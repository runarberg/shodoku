import{q as y,I as L,c as l,u as b,a1 as C}from"./index-BwH_6V5R.js";const m=(e,t)=>t.some(r=>e instanceof r);let p,D;function M(){return p||(p=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function O(){return D||(D=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const h=new WeakMap,I=new WeakMap,f=new WeakMap;function T(e){const t=new Promise((r,a)=>{const i=()=>{e.removeEventListener("success",n),e.removeEventListener("error",o)},n=()=>{r(u(e.result)),i()},o=()=>{a(e.error),i()};e.addEventListener("success",n),e.addEventListener("error",o)});return f.set(t,e),t}function N(e){if(h.has(e))return;const t=new Promise((r,a)=>{const i=()=>{e.removeEventListener("complete",n),e.removeEventListener("error",o),e.removeEventListener("abort",o)},n=()=>{r(),i()},o=()=>{a(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",n),e.addEventListener("error",o),e.addEventListener("abort",o)});h.set(e,t)}let k={get(e,t,r){if(e instanceof IDBTransaction){if(t==="done")return h.get(e);if(t==="store")return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return u(e[t])},set(e,t,r){return e[t]=r,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function j(e){k=e(k)}function W(e){return O().includes(e)?function(...t){return e.apply(v(this),t),u(this.request)}:function(...t){return u(e.apply(v(this),t))}}function F(e){return typeof e=="function"?W(e):(e instanceof IDBTransaction&&N(e),m(e,M())?new Proxy(e,k):e)}function u(e){if(e instanceof IDBRequest)return T(e);if(I.has(e))return I.get(e);const t=F(e);return t!==e&&(I.set(e,t),f.set(t,e)),t}const v=e=>f.get(e);function K(e,t,{blocked:r,upgrade:a,blocking:i,terminated:n}={}){const o=indexedDB.open(e,t),s=u(o);return a&&o.addEventListener("upgradeneeded",c=>{a(u(o.result),c.oldVersion,c.newVersion,u(o.transaction),c)}),r&&o.addEventListener("blocked",c=>r(c.oldVersion,c.newVersion,c)),s.then(c=>{n&&c.addEventListener("close",()=>n()),i&&c.addEventListener("versionchange",d=>i(d.oldVersion,d.newVersion,d))}).catch(()=>{}),s}const Q=["get","getKey","getAll","getAllKeys","count"],R=["put","add","delete","clear"],w=new Map;function P(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(w.get(t))return w.get(t);const r=t.replace(/FromIndex$/,""),a=t!==r,i=R.includes(r);if(!(r in(a?IDBIndex:IDBObjectStore).prototype)||!(i||Q.includes(r)))return;const n=async function(o,...s){const c=this.transaction(o,i?"readwrite":"readonly");let d=c.store;return a&&(d=d.index(s.shift())),(await Promise.all([d[r](...s),i&&c.done]))[0]};return w.set(t,n),n}j(e=>({...e,get:(t,r,a)=>P(t,r)||e.get(t,r,a),has:(t,r)=>!!P(t,r)||e.has(t,r)}));const _=["continue","continuePrimaryKey","advance"],B={},g=new WeakMap,E=new WeakMap,H={get(e,t){if(!_.includes(t))return e[t];let r=B[t];return r||(r=B[t]=function(...a){g.set(this,E.get(this)[t](...a))}),r}};async function*U(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const r=new Proxy(t,H);for(E.set(r,t),f.set(r,v(t));t;)yield r,t=await(g.get(r)||t.continue()),g.delete(r)}function x(e,t){return t===Symbol.asyncIterator&&m(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&m(e,[IDBIndex,IDBObjectStore])}j(e=>({...e,get(t,r,a){return x(t,r)?U:e.get(t,r,a)},has(t,r){return x(t,r)||e.has(t,r)}}));const A="live-query-channel",S=new BroadcastChannel(A),$=new BroadcastChannel(A);async function V(e,t,r,a,i){if(t<1){const n=e.createObjectStore("decks",{keyPath:"name"});n.createIndex("category","category"),n.createIndex("category+priority",["category","priority"]),n.createIndex("cards","cards",{multiEntry:!0}),e.createObjectStore("cards",{keyPath:"id"});const o=e.createObjectStore("progress",{keyPath:["cardId","cardType"]});o.createIndex("cardId+cardType+state",["cardId","cardType","fsrs.state"]),o.createIndex("state+due",["fsrs.state","fsrs.due"]);const s=e.createObjectStore("reviews",{keyPath:"id",autoIncrement:!0});s.createIndex("cardId","cardId"),s.createIndex("review","log.review"),s.createIndex("state+review",["log.state","log.review"])}if(t>=1){const n=a.objectStore("cards");n.indexNames.contains("decks")&&n.deleteIndex("decks"),n.indexNames.contains("position")&&n.deleteIndex("position");for await(const o of n.iterate()){const s=o.value;"position"in s&&delete s.position,"decks"in s&&delete s.decks,"deckPositions"in s&&delete s.deckPositions,o.update(s)}}if(t<2&&e.createObjectStore("review-limits",{keyPath:"id",autoIncrement:!0}).createIndex("time","time"),t<3&&e.createObjectStore("bookmarked-words",{keyPath:"wordId"}),t<4){const n=a.objectStore("bookmarked-words");if(n.createIndex("reading","reading"),n.createIndex("bookmarkedAt","bookmarkedAt"),t>=3){const o=new Date,s=await n.getAllKeys();for(const c of s)n.put({wordId:c,bookmarkedAt:o})}}if(t<5){const n=a.objectStore("decks");n.createIndex("createdAt","createdAt");const o=a.objectStore("cards");if(o.createIndex("createdAt","createdAt"),t>=4){const s=new Date;for await(const c of n.iterate()){const d=c.value;d.active=!0,d.createdAt=s,await c.update(d)}for await(const c of o.iterate()){const d=c.value;d.createdAt=s,await c.update(d)}}}if(t<6&&(e.createObjectStore("syncs",{keyPath:"hash"}).createIndex("syncedAt","syncedAt"),e.createObjectStore("sync.staging.stores",{keyPath:"id",autoIncrement:!0}),e.createObjectStore("sync.staging.preferences",{keyPath:"id",autoIncrement:!0}),a.objectStore("decks").createIndex("priority","priority")),t<7){const n=a.objectStore("decks");for await(const o of n.iterate()){const s=o.value;if(!s.cardTypes){const c=s.category==="kana"?["kana-write","kana-read"]:["kanji-write","kanji-read"];o.update({...s,cardTypes:c})}}}}const z=K("shodoku",7,{upgrade:V});function G(e,t=null){const r=y(!0),a=y(t),i=y(null);async function n(){r.value=!0,i.value=null;const o=b(e);try{a.value=await o()}catch(s){i.value=s,a.value=t}finally{r.value=!1}}return S.addEventListener("message",n),L(()=>b(e),n,{immediate:!0}),C(()=>{S.removeEventListener("message",n)}),{error:l(()=>i.value),result:l(()=>a.value),loading:l(()=>r.value)}}export{v as a,z as d,$ as l,G as u};
//# sourceMappingURL=db-CQLy7j3d.js.map
