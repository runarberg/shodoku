import{n as g,p as S,u as B,I as j,g as v}from"./index-BwJfRx6P.js";const I=(e,t)=>t.some(n=>e instanceof n);let E,p;function O(){return E||(E=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function T(){return p||(p=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const h=new WeakMap,y=new WeakMap,f=new WeakMap;function A(e){const t=new Promise((n,r)=>{const s=()=>{e.removeEventListener("success",o),e.removeEventListener("error",c)},o=()=>{n(d(e.result)),s()},c=()=>{r(e.error),s()};e.addEventListener("success",o),e.addEventListener("error",c)});return f.set(t,e),t}function V(e){if(h.has(e))return;const t=new Promise((n,r)=>{const s=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",c),e.removeEventListener("abort",c)},o=()=>{n(),s()},c=()=>{r(e.error||new DOMException("AbortError","AbortError")),s()};e.addEventListener("complete",o),e.addEventListener("error",c),e.addEventListener("abort",c)});h.set(e,t)}let m={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return h.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return d(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function C(e){m=e(m)}function N(e){return T().includes(e)?function(...t){return e.apply(w(this),t),d(this.request)}:function(...t){return d(e.apply(w(this),t))}}function R(e){return typeof e=="function"?N(e):(e instanceof IDBTransaction&&V(e),I(e,O())?new Proxy(e,m):e)}function d(e){if(e instanceof IDBRequest)return A(e);if(y.has(e))return y.get(e);const t=R(e);return t!==e&&(y.set(e,t),f.set(t,e)),t}const w=e=>f.get(e);function W(e,t,{blocked:n,upgrade:r,blocking:s,terminated:o}={}){const c=indexedDB.open(e,t),u=d(c);return r&&c.addEventListener("upgradeneeded",a=>{r(d(c.result),a.oldVersion,a.newVersion,d(c.transaction),a)}),n&&c.addEventListener("blocked",a=>n(a.oldVersion,a.newVersion,a)),u.then(a=>{o&&a.addEventListener("close",()=>o()),s&&a.addEventListener("versionchange",i=>s(i.oldVersion,i.newVersion,i))}).catch(()=>{}),u}const F=["get","getKey","getAll","getAllKeys","count"],Q=["put","add","delete","clear"],l=new Map;function x(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(l.get(t))return l.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,s=Q.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(s||F.includes(n)))return;const o=async function(c,...u){const a=this.transaction(c,s?"readwrite":"readonly");let i=a.store;return r&&(i=i.index(u.shift())),(await Promise.all([i[n](...u),s&&a.done]))[0]};return l.set(t,o),o}C(e=>({...e,get:(t,n,r)=>x(t,n)||e.get(t,n,r),has:(t,n)=>!!x(t,n)||e.has(t,n)}));const K=["continue","continuePrimaryKey","advance"],b={},D=new WeakMap,M=new WeakMap,_={get(e,t){if(!K.includes(t))return e[t];let n=b[t];return n||(n=b[t]=function(...r){D.set(this,M.get(this)[t](...r))}),n}};async function*H(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,_);for(M.set(n,t),f.set(n,w(t));t;)yield n,t=await(D.get(n)||t.continue()),D.delete(n)}function P(e,t){return t===Symbol.asyncIterator&&I(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&I(e,[IDBIndex,IDBObjectStore])}C(e=>({...e,get(t,n,r){return P(t,n)?H:e.get(t,n,r)},has(t,n){return P(t,n)||e.has(t,n)}}));const Y=W("shodoku",1,{upgrade(e,t){if(t<1){const n=e.createObjectStore("decks",{keyPath:"name"});n.createIndex("category","category"),n.createIndex("category+priority",["category","priority"]),n.createIndex("cards","cards",{multiEntry:!0});const r=e.createObjectStore("cards",{keyPath:"id"});r.createIndex("decks","decks",{multiEntry:!0}),r.createIndex("position",["position.priority","position.order"]);const s=e.createObjectStore("progress",{keyPath:["cardId","cardType"]});s.createIndex("cardId+cardType+state",["cardId","cardType","fsrs.state"]),s.createIndex("state+due",["fsrs.state","fsrs.due"]);const o=e.createObjectStore("reviews",{keyPath:"id",autoIncrement:!0});o.createIndex("cardId","cardId"),o.createIndex("review","log.review"),o.createIndex("state+review",["log.state","log.review"])}}}),k="live-query-channel",L=new BroadcastChannel(k),$=new BroadcastChannel(k);function z(e){const t=g(null),n=g(null);async function r(){const s=B(e);try{t.value=await s()}catch(o){n.value=o}}return L.addEventListener("message",r),S(()=>B(e),r,{immediate:!0}),j(()=>{L.removeEventListener("message",r)}),{error:v(()=>n.value),value:v(()=>t.value)}}export{Y as d,$ as l,z as u};
