import{d as V,c as p,p as W,o as d,f as G,w as O,b as _,t as D,u as g,q as J,s as X,_ as F,m as Z,n as ee,a as f,g as v,F as j,h,j as te,e as T,A as ne,R as ae,r as re,v as oe,x as se}from"./index-wKkOPtT6.js";import{d as c,a as ie}from"./channels-Cq-RpcWF.js";import{u as L}from"./db-CN4rHp8z.js";import{m as x,H as ue,E as S}from"./time-B3so-xG4.js";import{i as ce,n as we,d as le}from"./reviews-D-B0VpMz.js";import{u as i}from"./index-TyJKmroR.js";import{f as N,c as k,t as M}from"./iterators-PeFxZeGd.js";const de={class:"card-value"},me=V({__name:"ReviewSummaryItem",props:{cardId:{},reviews:{}},setup(n){const t=n,e=p(()=>String.fromCharCode(t.cardId)),a=p(()=>t.reviews.at(0)),r=p(()=>a.value?a.value.log.state===i.New:!1);return(u,s)=>{const o=W("RouterLink");return d(),G(o,{to:g(J)(e.value),class:X(["review-summary-item",{"is-new":r.value}])},{default:O(()=>[_("strong",de,D(e.value),1)]),_:1},8,["to","class"])}}}),fe=F(me,[["__scopeId","data-v-15bfc4b2"]]),ve={class:"review-summary"},ge={key:0},pe={class:"review-count total-count"},ye={class:"review-count new-count"},Ce={key:1,class:"review-summary-list"},Re=V({__name:"ReviewSummary",setup(n){const t=Z(),e=ee(),{result:a}=L(async()=>{const s=new Map,o=(await c).transaction("reviews").store.index("review");for await(const w of o.iterate(IDBKeyRange.lowerBound(x()))){const l=w.value;let m=s.get(l.cardId);m||(m=[],s.set(l.cardId,m)),m.push(l)}return s}),r=p(()=>{if(!a.value)return 0;let s=0;for(const[o]of a.value.values())o.log.state===i.New&&(s+=1);return s});function u(){ce(),t.name!==ae&&e.push(re)}return(s,o)=>(d(),f("section",ve,[g(a)?(d(),f("p",ge,[o[3]||(o[3]=v(" Reviewed ")),_("span",pe,D(g(a).size)+" cards",1),o[4]||(o[4]=v(" today")),r.value>0?(d(),f(j,{key:0},[o[1]||(o[1]=v(" (of which ")),_("span",ye,D(r.value)+" new",1),o[2]||(o[2]=v(")"))],64)):h("",!0),o[5]||(o[5]=v(". "))])):h("",!0),g(a)?(d(),f("ul",Ce,[(d(!0),f(j,null,te(g(a),([w,l])=>(d(),f("li",null,[T(fe,{"card-id":w,reviews:l},null,8,["card-id","reviews"])]))),256))])):h("",!0),o[7]||(o[7]=_("p",null," Click the button below to temporarily increase your daily review limit. ",-1)),T(ne,{onClick:o[0]||(o[0]=w=>u())},{default:O(()=>o[6]||(o[6]=[v("Continue Review")])),_:1})]))}}),ke=F(Re,[["__scopeId","data-v-e028f67f"]]);async function*b(n){const t=new Set;let e=await(await c).transaction("progress").store.index("state+due").openCursor();for(;e;){const[a,r]=e.key;if(a<i.Learning){e=await e.continue([i.Learning,S]);continue}if(a>i.Learning&&a<i.Relearning){e=await e.continue([i.Relearning,S]);continue}if(!n||r<n){const[u]=e.primaryKey;t.has(u)||(yield e,t.add(u))}e=await e.continue()}}async function P(){const n=new Set,t=(await c).transaction("reviews").store.index("review").iterate(IDBKeyRange.lowerBound(x()));for await(const e of t)n.add(e.value.cardId);return n}let y=null;async function A(){const n=new Date,t=(await c).transaction("reviews").store.index("state+review").count(IDBKeyRange.bound([i.New,x()],[i.New,n],!0,!0));return t.then(e=>{y=e}),t}async function*Y(){const n=await P(),t=(await c).transaction(["cards","progress"],"readwrite"),e=t.objectStore("cards"),a=t.objectStore("progress").index("cardId+cardType+state");let r=await e.index("position").openKeyCursor(IDBKeyRange.bound([0,0],[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],!1,!0));for(;r;){if(n.has(r.primaryKey)){r=await r.continue();continue}let u=await a.openCursor([r.primaryKey,"kanji-write",i.New]);u||(u=await a.openCursor([r.primaryKey,"kanji-read",i.New])),u&&(yield u),r=await r.continue()}}let C=null;async function $(){const n=new Date,t=(await c).transaction("reviews").store.index("state+review").count(IDBKeyRange.bound([i.Review,x()],[i.Review,n],!1,!0));return t.then(e=>{C=e}),t}async function*q(){const n=new Date,t=await P(),e=(await c).transaction(["cards","progress","reviews"],"readonly"),a=e.objectStore("cards"),r=e.objectStore("progress"),u=IDBKeyRange.bound([i.Review,S],[i.Review,n],!1,!0);let s=await r.index("state+due").openCursor(u);for(;s;){const[o]=s.primaryKey;if(!t.has(o)){const w=await a.get(o);w&&w.position.priority<Number.POSITIVE_INFINITY&&(yield s)}s=await s.continue()}}async function z(){const n=await(await c).getAllFromIndex("review-limits","time",IDBKeyRange.lowerBound(x())),t={due:0,new:0};for(const{count:e}of n)t.due+=e.due,t.new+=e.new;return t}let R=null;async function H(n=0){const t=await A(),e=Math.max(0,we.value+n-t),a=k(M(e,Y()));return a.then(r=>{R=r}),a}let I=null;async function Q(n=0){const t=await $(),e=Math.max(0,le.value+n-t),a=k(M(e,q()));return a.then(r=>{I=r}),a}async function Ie(){const n=await N(b(new Date));if(n)return n.value;const t=await z(),e=R??await H(t.new),a=y??await A(),r=I??await Q(t.due),u=C??await $(),s=e+a,o=r+u,w=e+r,l=Math.ceil((s+o)/s),m=Math.floor(l/2);if(e>0&&(r===0||w%l===m)){const K=await N(Y());if(K)return K.value}const B=await N(q());if(B)return B.value;const E=await N(b());return E?E.value:null}async function xe(){const n=await z();return{new:await H(n.new),due:await Q(n.due),learning:await k(b())}}async function Be({cardId:n,cardType:t,fsrs:e},a){const r=(await c).transaction(["progress","reviews"],"readwrite"),u=r.objectStore("progress"),s=r.objectStore("reviews");e.state===i.New?(R!==null&&(R-=1),y!==null&&(y+=1)):e.state===i.Review&&(I!==null&&(I-=1),C!==null&&(C+=1)),await u.put({cardId:n,cardType:t,fsrs:a.card}),await s.add({cardId:n,cardType:t,log:a.log})}function U(){C=null,I=null,y=null,R=null}globalThis.setInterval(U,ue);ie.addEventListener("message",n=>{n.data==="review-limit-increased"&&U()});function Ee(n){const t=p(()=>{const e=se(n);if(e){const{cardId:a,cardType:r}=e;return async()=>(await c).get("progress",[a,r])}return Ie});return L(t)}function Ke(){const{result:n,error:t}=L(xe);return oe(()=>{t.value&&console.error(t.value)}),n}export{ke as R,Ee as a,Be as r,Ke as u};
