import{m as y,y as L,c as l,u as b,S as C}from"./index-DyCUo9BM.js";const h=(e,t)=>t.some(r=>e instanceof r);let D,p;function M(){return D||(D=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function O(){return p||(p=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const w=new WeakMap,I=new WeakMap,f=new WeakMap;function T(e){const t=new Promise((r,s)=>{const i=()=>{e.removeEventListener("success",n),e.removeEventListener("error",o)},n=()=>{r(u(e.result)),i()},o=()=>{s(e.error),i()};e.addEventListener("success",n),e.addEventListener("error",o)});return f.set(t,e),t}function N(e){if(w.has(e))return;const t=new Promise((r,s)=>{const i=()=>{e.removeEventListener("complete",n),e.removeEventListener("error",o),e.removeEventListener("abort",o)},n=()=>{r(),i()},o=()=>{s(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",n),e.addEventListener("error",o),e.addEventListener("abort",o)});w.set(e,t)}let k={get(e,t,r){if(e instanceof IDBTransaction){if(t==="done")return w.get(e);if(t==="store")return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return u(e[t])},set(e,t,r){return e[t]=r,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function S(e){k=e(k)}function W(e){return O().includes(e)?function(...t){return e.apply(v(this),t),u(this.request)}:function(...t){return u(e.apply(v(this),t))}}function F(e){return typeof e=="function"?W(e):(e instanceof IDBTransaction&&N(e),h(e,M())?new Proxy(e,k):e)}function u(e){if(e instanceof IDBRequest)return T(e);if(I.has(e))return I.get(e);const t=F(e);return t!==e&&(I.set(e,t),f.set(t,e)),t}const v=e=>f.get(e);function K(e,t,{blocked:r,upgrade:s,blocking:i,terminated:n}={}){const o=indexedDB.open(e,t),c=u(o);return s&&o.addEventListener("upgradeneeded",a=>{s(u(o.result),a.oldVersion,a.newVersion,u(o.transaction),a)}),r&&o.addEventListener("blocked",a=>r(a.oldVersion,a.newVersion,a)),c.then(a=>{n&&a.addEventListener("close",()=>n()),i&&a.addEventListener("versionchange",d=>i(d.oldVersion,d.newVersion,d))}).catch(()=>{}),c}const Q=["get","getKey","getAll","getAllKeys","count"],R=["put","add","delete","clear"],m=new Map;function P(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(m.get(t))return m.get(t);const r=t.replace(/FromIndex$/,""),s=t!==r,i=R.includes(r);if(!(r in(s?IDBIndex:IDBObjectStore).prototype)||!(i||Q.includes(r)))return;const n=async function(o,...c){const a=this.transaction(o,i?"readwrite":"readonly");let d=a.store;return s&&(d=d.index(c.shift())),(await Promise.all([d[r](...c),i&&a.done]))[0]};return m.set(t,n),n}S(e=>({...e,get:(t,r,s)=>P(t,r)||e.get(t,r,s),has:(t,r)=>!!P(t,r)||e.has(t,r)}));const _=["continue","continuePrimaryKey","advance"],x={},g=new WeakMap,j=new WeakMap,V={get(e,t){if(!_.includes(t))return e[t];let r=x[t];return r||(r=x[t]=function(...s){g.set(this,j.get(this)[t](...s))}),r}};async function*H(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const r=new Proxy(t,V);for(j.set(r,t),f.set(r,v(t));t;)yield r,t=await(g.get(r)||t.continue()),g.delete(r)}function B(e,t){return t===Symbol.asyncIterator&&h(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&h(e,[IDBIndex,IDBObjectStore])}S(e=>({...e,get(t,r,s){return B(t,r)?H:e.get(t,r,s)},has(t,r){return B(t,r)||e.has(t,r)}}));const A="live-query-channel",E=new BroadcastChannel(A),$=new BroadcastChannel(A);async function U(e,t,r,s,i){if(t<1){const n=e.createObjectStore("decks",{keyPath:"name"});n.createIndex("category","category"),n.createIndex("category+priority",["category","priority"]),n.createIndex("cards","cards",{multiEntry:!0}),e.createObjectStore("cards",{keyPath:"id"});const o=e.createObjectStore("progress",{keyPath:["cardId","cardType"]});o.createIndex("cardId+cardType+state",["cardId","cardType","fsrs.state"]),o.createIndex("state+due",["fsrs.state","fsrs.due"]);const c=e.createObjectStore("reviews",{keyPath:"id",autoIncrement:!0});c.createIndex("cardId","cardId"),c.createIndex("review","log.review"),c.createIndex("state+review",["log.state","log.review"])}if(t<2&&e.createObjectStore("review-limits",{keyPath:"id",autoIncrement:!0}).createIndex("time","time"),t<3&&e.createObjectStore("bookmarked-words",{keyPath:"wordId"}),t<4){const n=s.objectStore("bookmarked-words");if(n.createIndex("reading","reading"),n.createIndex("bookmarkedAt","bookmarkedAt"),t>=3){const o=new Date,c=await n.getAllKeys();for(const a of c)n.put({wordId:a,bookmarkedAt:o})}}if(t<5){const n=s.objectStore("decks");n.createIndex("createdAt","createdAt");const o=s.objectStore("cards");if(o.createIndex("createdAt","createdAt"),t>=4){const c=new Date;for await(const a of n.iterate()){const d=a.value;d.active=!0,d.createdAt=c,await a.update(d)}for await(const a of o.iterate()){const d=a.value;d.createdAt=c,await a.update(d)}}}if(t<6&&(e.createObjectStore("syncs",{keyPath:"hash"}).createIndex("syncedAt","syncedAt"),e.createObjectStore("sync.staging.stores",{keyPath:"id",autoIncrement:!0}),e.createObjectStore("sync.staging.preferences",{keyPath:"id",autoIncrement:!0}),s.objectStore("decks").createIndex("priority","priority")),t>=1){const n=s.objectStore("cards");n.indexNames.contains("decks")&&n.deleteIndex("decks"),n.indexNames.contains("position")&&n.deleteIndex("position");for await(const o of n.iterate()){const c=o.value;"position"in c&&delete c.position,"decks"in c&&delete c.decks,"deckPositions"in c&&delete c.deckPositions,o.update(c)}}}const z=K("shodoku",6,{upgrade:U});function G(e){const t=y(!0),r=y(null),s=y(null);async function i(){t.value=!0,s.value=null;const n=b(e);try{r.value=await n()}catch(o){s.value=o,r.value=null}finally{t.value=!1}}return E.addEventListener("message",i),L(()=>b(e),i,{immediate:!0}),C(()=>{E.removeEventListener("message",i)}),{error:l(()=>s.value),result:l(()=>r.value),loading:l(()=>t.value)}}export{v as a,z as d,$ as l,G as u};
