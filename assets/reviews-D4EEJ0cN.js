var Ce=Object.defineProperty;var Te=(t,e,i)=>e in t?Ce(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i;var M=(t,e,i)=>Te(t,typeof e!="symbol"?e+"":e,i);import{u as Le,E as Fe,Y as W,m as N,Z as xe,x as j,$ as Oe,M as $e,P as ke,a0 as He,a1 as je,X as Me,a2 as Se,n as Pe,c as ue,C as ze}from"./index-chiovaS4.js";import{d as A,u as Be,l as Ee}from"./db-1SYsvhON.js";function Q(){return async function(t){const e=[];for await(const i of t)e.push(i);return e}}function V(t,...e){return e.reduce((i,a)=>a(i),t)}function Y(t){return async function*(e){for await(const i of e)yield t(i)}}function de(t){return async function*(e){for await(const i of e)t(i)&&(yield i)}}function fe(t){if(t<0){const e=-t;return async function*(i){const a=[];let n=0;for await(const r of i)a[n]=r,n=(n+1)%e;for(let r=0;r<a.length;r+=1)yield a[n],n=(n+1)%e}}return async function*(e){let i=0;for await(const a of e){if(i>=t)break;i+=1,yield a}}}function he(t){return async function*(e){const i=new Set;for await(const a of e){const n=t(a);i.has(n)||(yield a,i.add(n))}}}function Ge(t){return Oe()?($e(t),!0):!1}function D(t){return typeof t=="function"?t():Le(t)}const kt={mounted:"mounted",updated:"updated",unmounted:"unmounted"},Re=typeof window<"u"&&typeof document<"u";typeof WorkerGlobalScope<"u"&&globalThis instanceof WorkerGlobalScope;const Ht=t=>t!=null,Ke=Object.prototype.toString,We=t=>Ke.call(t)==="[object Object]",P=()=>{},jt=qe();function qe(){var t,e;return Re&&((t=window==null?void 0:window.navigator)==null?void 0:t.userAgent)&&(/iP(?:ad|hone|od)/.test(window.navigator.userAgent)||((e=window==null?void 0:window.navigator)==null?void 0:e.maxTouchPoints)>2&&/iPad|Macintosh/.test(window==null?void 0:window.navigator.userAgent))}function Qe(t,e){function i(...a){return new Promise((n,r)=>{Promise.resolve(t(()=>e.apply(this,a),{fn:e,thisArg:this,args:a})).then(n).catch(r)})}return i}const Ie=t=>t();function Ve(t,e={}){let i,a,n=P;const r=o=>{clearTimeout(o),n(),n=P};return o=>{const c=D(t),d=D(e.maxWait);return i&&r(i),c<=0||d!==void 0&&d<=0?(a&&(r(a),a=null),Promise.resolve(o())):new Promise((w,l)=>{n=e.rejectOnCancel?l:w,d&&!a&&(a=setTimeout(()=>{i&&r(i),a=null,w(o())},d)),i=setTimeout(()=>{a&&r(a),a=null,w(o())},c)})}}function Ye(t=Ie){const e=N(!0);function i(){e.value=!1}function a(){e.value=!0}const n=(...r)=>{e.value&&t(...r)};return{isActive:xe(e),pause:i,resume:a,eventFilter:n}}function we(t,e=!1,i="Timeout"){return new Promise((a,n)=>{setTimeout(e?()=>n(i):a,t)})}function Je(t){return ke()}function Pt(...t){if(t.length!==1)return He(...t);const e=t[0];return typeof e=="function"?xe(je(()=>({get:e,set:P}))):N(e)}function Ne(t,e,i={}){const{eventFilter:a=Ie,...n}=i;return j(t,Qe(a,e),n)}function Ue(t,e,i={}){const{eventFilter:a,...n}=i,{eventFilter:r,pause:s,resume:o,isActive:c}=Ye(a);return{stop:Ne(t,e,{...n,eventFilter:r}),pause:s,resume:o,isActive:c}}function Xe(t,e=!0,i){Je()?Fe(t,i):e?t():W(t)}function ie(t,e=!1){function i(l,{flush:f="sync",deep:g=!1,timeout:m,throwOnTimeout:v}={}){let _=null;const S=[new Promise(T=>{_=j(t,E=>{l(E)!==e&&(_?_():W(()=>_==null?void 0:_()),T(E))},{flush:f,deep:g,immediate:!0})})];return m!=null&&S.push(we(m,v).then(()=>D(t)).finally(()=>_==null?void 0:_())),Promise.race(S)}function a(l,f){if(!Me(l))return i(E=>E===l,f);const{flush:g="sync",deep:m=!1,timeout:v,throwOnTimeout:_}=f??{};let b=null;const T=[new Promise(E=>{b=j([t,l],([L,$])=>{e!==(L===$)&&(b?b():W(()=>b==null?void 0:b()),E(L))},{flush:g,deep:m,immediate:!0})})];return v!=null&&T.push(we(v,_).then(()=>D(t)).finally(()=>(b==null||b(),D(t)))),Promise.race(T)}function n(l){return i(f=>!!f,l)}function r(l){return a(null,l)}function s(l){return a(void 0,l)}function o(l){return i(Number.isNaN,l)}function c(l,f){return i(g=>{const m=Array.from(g);return m.includes(l)||m.includes(D(l))},f)}function d(l){return w(1,l)}function w(l=1,f){let g=-1;return i(()=>(g+=1,g>=l),f)}return Array.isArray(D(t))?{toMatch:i,toContains:c,changed:d,changedTimes:w,get not(){return ie(t,!e)}}:{toMatch:i,toBe:a,toBeTruthy:n,toBeNull:r,toBeNaN:o,toBeUndefined:s,changed:d,changedTimes:w,get not(){return ie(t,!e)}}}function zt(t){return ie(t)}function Bt(t,e,i={}){const{debounce:a=0,maxWait:n=void 0,...r}=i;return Ne(t,e,{...r,eventFilter:Ve(a,{maxWait:n})})}function Gt(t,e,i){let a;Me(i)?a={evaluating:i}:a={};const{lazy:n=!1,evaluating:r=void 0,shallow:s=!0,onError:o=P}=a,c=N(!n),d=s?Se(e):N(e);let w=0;return Pe(async l=>{if(!c.value)return;w++;const f=w;let g=!1;r&&Promise.resolve().then(()=>{r.value=!0});try{const m=await t(v=>{l(()=>{r&&(r.value=!1),g||v()})});f===w&&(d.value=m)}catch(m){o(m)}finally{r&&f===w&&(r.value=!1),g=!0}}),n?ue(()=>(c.value=!0,d.value)):d}const q=Re?window:void 0;function Ze(t){var e;const i=D(t);return(e=i==null?void 0:i.$el)!=null?e:i}function ye(...t){let e,i,a,n;if(typeof t[0]=="string"||Array.isArray(t[0])?([i,a,n]=t,e=q):[e,i,a,n]=t,!e)return P;Array.isArray(i)||(i=[i]),Array.isArray(a)||(a=[a]);const r=[],s=()=>{r.forEach(w=>w()),r.length=0},o=(w,l,f,g)=>(w.addEventListener(l,f,g),()=>w.removeEventListener(l,f,g)),c=j(()=>[Ze(e),D(n)],([w,l])=>{if(s(),!w)return;const f=We(l)?{...l}:l;r.push(...i.flatMap(g=>a.map(m=>o(w,g,m,f))))},{immediate:!0,flush:"post"}),d=()=>{c(),s()};return Ge(d),d}const B=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},G="__vueuse_ssr_handlers__",et=tt();function tt(){return G in B||(B[G]=B[G]||{}),B[G]}function it(t,e){return et[t]||e}function at(t){return t==null?"any":t instanceof Set?"set":t instanceof Map?"map":t instanceof Date?"date":typeof t=="boolean"?"boolean":typeof t=="string"?"string":typeof t=="object"?"object":Number.isNaN(t)?"any":"number"}const nt={boolean:{read:t=>t==="true",write:t=>String(t)},object:{read:t=>JSON.parse(t),write:t=>JSON.stringify(t)},number:{read:t=>Number.parseFloat(t),write:t=>String(t)},any:{read:t=>t,write:t=>String(t)},string:{read:t=>t,write:t=>String(t)},map:{read:t=>new Map(JSON.parse(t)),write:t=>JSON.stringify(Array.from(t.entries()))},set:{read:t=>new Set(JSON.parse(t)),write:t=>JSON.stringify(Array.from(t))},date:{read:t=>new Date(t),write:t=>t.toISOString()}},me="vueuse-storage";function rt(t,e,i,a={}){var n;const{flush:r="pre",deep:s=!0,listenToStorageChanges:o=!0,writeDefaults:c=!0,mergeDefaults:d=!1,shallow:w,window:l=q,eventFilter:f,onError:g=p=>{console.error(p)},initOnMounted:m}=a,v=(w?Se:N)(typeof e=="function"?e():e);if(!i)try{i=it("getDefaultStorage",()=>{var p;return(p=q)==null?void 0:p.localStorage})()}catch(p){g(p)}if(!i)return v;const _=D(e),b=at(_),S=(n=a.serializer)!=null?n:nt[b],{pause:T,resume:E}=Ue(v,()=>$(v.value),{flush:r,deep:s,eventFilter:f});l&&o&&Xe(()=>{i instanceof Storage?ye(l,"storage",R):ye(l,me,ce),m&&R()}),m||R();function L(p,x){if(l){const I={key:t,oldValue:p,newValue:x,storageArea:i};l.dispatchEvent(i instanceof Storage?new StorageEvent("storage",I):new CustomEvent(me,{detail:I}))}}function $(p){try{const x=i.getItem(t);if(p==null)L(x,null),i.removeItem(t);else{const I=S.write(p);x!==I&&(i.setItem(t,I),L(x,I))}}catch(x){g(x)}}function C(p){const x=p?p.newValue:i.getItem(t);if(x==null)return c&&_!=null&&i.setItem(t,S.write(_)),_;if(!p&&d){const I=S.read(x);return typeof d=="function"?d(I,_):b==="object"&&!Array.isArray(I)?{..._,...I}:I}else return typeof x!="string"?x:S.read(x)}function R(p){if(!(p&&p.storageArea!==i)){if(p&&p.key==null){v.value=_;return}if(!(p&&p.key!==t)){T();try{(p==null?void 0:p.newValue)!==S.write(v.value)&&(v.value=C(p))}catch(x){g(x)}finally{p?W(E):E()}}}}function ce(p){R(p.detail)}return v}function le(t,e,i={}){const{window:a=q}=i;return rt(t,e,a==null?void 0:a.localStorage,i)}var h=(t=>(t[t.New=0]="New",t[t.Learning=1]="Learning",t[t.Review=2]="Review",t[t.Relearning=3]="Relearning",t))(h||{}),u=(t=>(t[t.Manual=0]="Manual",t[t.Again=1]="Again",t[t.Hard=2]="Hard",t[t.Good=3]="Good",t[t.Easy=4]="Easy",t))(u||{});class y{static card(e){return{...e,state:y.state(e.state),due:y.time(e.due),last_review:e.last_review?y.time(e.last_review):void 0}}static rating(e){if(typeof e=="string"){const i=e.charAt(0).toUpperCase(),a=e.slice(1).toLowerCase(),n=u[`${i}${a}`];if(n===void 0)throw new Error(`Invalid rating:[${e}]`);return n}else if(typeof e=="number")return e;throw new Error(`Invalid rating:[${e}]`)}static state(e){if(typeof e=="string"){const i=e.charAt(0).toUpperCase(),a=e.slice(1).toLowerCase(),n=h[`${i}${a}`];if(n===void 0)throw new Error(`Invalid state:[${e}]`);return n}else if(typeof e=="number")return e;throw new Error(`Invalid state:[${e}]`)}static time(e){if(typeof e=="object"&&e instanceof Date)return e;if(typeof e=="string"){const i=Date.parse(e);if(isNaN(i))throw new Error(`Invalid date:[${e}]`);return new Date(i)}else if(typeof e=="number")return new Date(e);throw new Error(`Invalid date:[${e}]`)}static review_log(e){return{...e,due:y.time(e.due),rating:y.rating(e.rating),state:y.state(e.state),review:y.time(e.review)}}}const st=.9,ot=36500,ut=[.4072,1.1829,3.1262,15.4722,7.2102,.5316,1.0651,.0234,1.616,.1544,1.0824,1.9813,.0953,.2975,2.2042,.2407,2.9466,.5034,.6567],lt=!1,ct=!0,ge=t=>{let e=ut;return t!=null&&t.w&&(t.w.length===19?e=t==null?void 0:t.w:t.w.length===17&&(e=t==null?void 0:t.w.concat([0,0]),console.debug("[FSRS V5]auto fill w to 19 length"))),{request_retention:(t==null?void 0:t.request_retention)||st,maximum_interval:(t==null?void 0:t.maximum_interval)||ot,w:e,enable_fuzz:(t==null?void 0:t.enable_fuzz)??lt,enable_short_term:(t==null?void 0:t.enable_short_term)??ct}};function ae(t,e){const i={due:t?y.time(t):new Date,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:0,lapses:0,state:h.New,last_review:void 0};return e&&typeof e=="function"?e(i):i}Date.prototype.scheduler=function(t,e){return dt(this,t,e)},Date.prototype.diff=function(t,e){return ft(this,t,e)},Date.prototype.format=function(){return ht(this)},Date.prototype.dueFormat=function(t,e,i){return wt(this,t,e,i)};function dt(t,e,i){return new Date(i?F(t).getTime()+e*24*60*60*1e3:F(t).getTime()+e*60*1e3)}function ft(t,e,i){if(!t||!e)throw new Error("Invalid date");const a=F(t).getTime()-F(e).getTime();let n=0;switch(i){case"days":n=Math.floor(a/(24*60*60*1e3));break;case"minutes":n=Math.floor(a/(60*1e3));break}return n}function ht(t){const e=F(t),i=e.getFullYear(),a=e.getMonth()+1,n=e.getDate(),r=e.getHours(),s=e.getMinutes(),o=e.getSeconds();return`${i}-${k(a)}-${k(n)} ${k(r)}:${k(s)}:${k(o)}`}function k(t){return t<10?`0${t}`:`${t}`}const J=[60,60,24,31,12],U=["second","min","hour","day","month","year"];function wt(t,e,i,a=U){t=F(t),e=F(e),a.length!==U.length&&(a=U);let n=t.getTime()-e.getTime(),r;for(n/=1e3,r=0;r<J.length&&!(n<J[r]);r++)n/=J[r];return`${Math.floor(n)}${i?a[r]:""}`}function F(t){return y.time(t)}const yt=[u.Again,u.Hard,u.Good,u.Easy],mt=[{start:2.5,end:7,factor:.15},{start:7,end:20,factor:.1},{start:20,end:1/0,factor:.05}];function gt(t,e,i){let a=1;for(const s of mt)a+=s.factor*Math.max(Math.min(t,s.end)-s.start,0);t=Math.min(t,i);let n=Math.max(2,Math.round(t-a));const r=Math.min(Math.round(t+a),i);return t>e&&(n=Math.max(n,e+1)),n=Math.min(n,r),{min_ivl:n,max_ivl:r}}function X(t,e,i){return Math.min(Math.max(t,e),i)}class vt{constructor(e){M(this,"c");M(this,"s0");M(this,"s1");M(this,"s2");const i=pt();this.c=1,this.s0=i(" "),this.s1=i(" "),this.s2=i(" "),e==null&&(e=+new Date),this.s0-=i(e),this.s0<0&&(this.s0+=1),this.s1-=i(e),this.s1<0&&(this.s1+=1),this.s2-=i(e),this.s2<0&&(this.s2+=1)}next(){const e=2091639*this.s0+this.c*23283064365386963e-26;return this.s0=this.s1,this.s1=this.s2,this.s2=e-(this.c=e|0),this.s2}set state(e){this.c=e.c,this.s0=e.s0,this.s1=e.s1,this.s2=e.s2}get state(){return{c:this.c,s0:this.s0,s1:this.s1,s2:this.s2}}}function pt(){let t=4022871197;return function(e){e=String(e);for(let i=0;i<e.length;i++){t+=e.charCodeAt(i);let a=.02519603282416938*t;t=a>>>0,a-=t,a*=t,t=a>>>0,a-=t,t+=a*4294967296}return(t>>>0)*23283064365386963e-26}}function _t(t){const e=new vt(t),i=()=>e.next();return i.int32=()=>e.next()*4294967296|0,i.double=()=>i()+(i()*2097152|0)*11102230246251565e-32,i.state=()=>e.state,i.importState=a=>(e.state=a,i),i}const ve=-.5,pe=19/81;class bt{constructor(e){M(this,"param");M(this,"intervalModifier");M(this,"_seed");this.param=new Proxy(ge(e),this.params_handler_proxy()),this.intervalModifier=this.calculate_interval_modifier(this.param.request_retention)}get interval_modifier(){return this.intervalModifier}set seed(e){this._seed=e}calculate_interval_modifier(e){if(e<=0||e>1)throw new Error("Requested retention rate should be in the range (0,1]");return+((Math.pow(e,1/ve)-1)/pe).toFixed(8)}get parameters(){return this.param}set parameters(e){this.update_parameters(e)}params_handler_proxy(){const e=this;return{set:function(i,a,n){return a==="request_retention"&&Number.isFinite(n)&&(e.intervalModifier=e.calculate_interval_modifier(Number(n))),Reflect.set(i,a,n),!0}}}update_parameters(e){const i=ge(e);for(const a in i)if(a in this.param){const n=a;this.param[n]=i[n]}}init_stability(e){return Math.max(this.param.w[e-1],.1)}init_difficulty(e){return this.constrain_difficulty(this.param.w[4]-Math.exp((e-1)*this.param.w[5])+1)}apply_fuzz(e,i){if(!this.param.enable_fuzz||e<2.5)return Math.round(e);const a=_t(this._seed)(),{min_ivl:n,max_ivl:r}=gt(e,i,this.param.maximum_interval);return Math.floor(a*(r-n+1)+n)}next_interval(e,i){const a=Math.min(Math.max(1,Math.round(e*this.intervalModifier)),this.param.maximum_interval);return this.apply_fuzz(a,i)}next_difficulty(e,i){const a=e-this.param.w[6]*(i-3);return this.constrain_difficulty(this.mean_reversion(this.init_difficulty(u.Easy),a))}constrain_difficulty(e){return Math.min(Math.max(+e.toFixed(8),1),10)}mean_reversion(e,i){return+(this.param.w[7]*e+(1-this.param.w[7])*i).toFixed(8)}next_recall_stability(e,i,a,n){const r=u.Hard===n?this.param.w[15]:1,s=u.Easy===n?this.param.w[16]:1;return+X(i*(1+Math.exp(this.param.w[8])*(11-e)*Math.pow(i,-this.param.w[9])*(Math.exp((1-a)*this.param.w[10])-1)*r*s),.01,36500).toFixed(8)}next_forget_stability(e,i,a){return+X(this.param.w[11]*Math.pow(e,-this.param.w[12])*(Math.pow(i+1,this.param.w[13])-1)*Math.exp((1-a)*this.param.w[14]),.01,36500).toFixed(8)}next_short_term_stability(e,i){return+X(e*Math.exp(this.param.w[17]*(i-3+this.param.w[18])),.01,36500).toFixed(8)}forgetting_curve(e,i){return+Math.pow(1+pe*e/i,ve).toFixed(8)}}class De{constructor(e,i,a){M(this,"last");M(this,"current");M(this,"review_time");M(this,"next",new Map);M(this,"algorithm");this.algorithm=a,this.last=y.card(e),this.current=y.card(e),this.review_time=y.time(i),this.init()}init(){const{state:e,last_review:i}=this.current;let a=0;e!==h.New&&i&&(a=this.review_time.diff(i,"days")),this.current.last_review=this.review_time,this.current.elapsed_days=a,this.current.reps+=1,this.initSeed()}preview(){return{[u.Again]:this.review(u.Again),[u.Hard]:this.review(u.Hard),[u.Good]:this.review(u.Good),[u.Easy]:this.review(u.Easy),[Symbol.iterator]:this.previewIterator.bind(this)}}*previewIterator(){for(const e of yt)yield this.review(e)}review(e){const{state:i}=this.last;let a;switch(i){case h.New:a=this.newState(e);break;case h.Learning:case h.Relearning:a=this.learningState(e);break;case h.Review:a=this.reviewState(e);break}if(a)return a;throw new Error("Invalid grade")}initSeed(){const e=this.review_time.getTime(),i=this.current.reps,a=this.current.difficulty*this.current.stability;this.algorithm.seed=`${e}_${i}_${a}`}buildLog(e){const{last_review:i,due:a,elapsed_days:n}=this.last;return{rating:e,state:this.current.state,due:i||a,stability:this.current.stability,difficulty:this.current.difficulty,elapsed_days:this.current.elapsed_days,last_elapsed_days:n,scheduled_days:this.current.scheduled_days,review:this.review_time}}}class _e extends De{newState(e){const i=this.next.get(e);if(i)return i;const a=y.card(this.current);switch(a.difficulty=this.algorithm.init_difficulty(e),a.stability=this.algorithm.init_stability(e),e){case u.Again:a.scheduled_days=0,a.due=this.review_time.scheduler(1),a.state=h.Learning;break;case u.Hard:a.scheduled_days=0,a.due=this.review_time.scheduler(5),a.state=h.Learning;break;case u.Good:a.scheduled_days=0,a.due=this.review_time.scheduler(10),a.state=h.Learning;break;case u.Easy:{const r=this.algorithm.next_interval(a.stability,this.current.elapsed_days);a.scheduled_days=r,a.due=this.review_time.scheduler(r,!0),a.state=h.Review;break}default:throw new Error("Invalid grade")}const n={card:a,log:this.buildLog(e)};return this.next.set(e,n),n}learningState(e){const i=this.next.get(e);if(i)return i;const{state:a,difficulty:n,stability:r}=this.last,s=y.card(this.current),o=this.current.elapsed_days;switch(s.difficulty=this.algorithm.next_difficulty(n,e),s.stability=this.algorithm.next_short_term_stability(r,e),e){case u.Again:{s.scheduled_days=0,s.due=this.review_time.scheduler(5,!1),s.state=a;break}case u.Hard:{s.scheduled_days=0,s.due=this.review_time.scheduler(10),s.state=a;break}case u.Good:{const d=this.algorithm.next_interval(s.stability,o);s.scheduled_days=d,s.due=this.review_time.scheduler(d,!0),s.state=h.Review;break}case u.Easy:{const d=this.algorithm.next_short_term_stability(r,u.Good),w=this.algorithm.next_interval(d,o),l=Math.max(this.algorithm.next_interval(s.stability,o),w+1);s.scheduled_days=l,s.due=this.review_time.scheduler(l,!0),s.state=h.Review;break}default:throw new Error("Invalid grade")}const c={card:s,log:this.buildLog(e)};return this.next.set(e,c),c}reviewState(e){const i=this.next.get(e);if(i)return i;const a=this.current.elapsed_days,{difficulty:n,stability:r}=this.last,s=this.algorithm.forgetting_curve(a,r),o=y.card(this.current),c=y.card(this.current),d=y.card(this.current),w=y.card(this.current);this.next_ds(o,c,d,w,n,r,s),this.next_interval(o,c,d,w,a),this.next_state(o,c,d,w),o.lapses+=1;const l={card:o,log:this.buildLog(u.Again)},f={card:c,log:super.buildLog(u.Hard)},g={card:d,log:super.buildLog(u.Good)},m={card:w,log:super.buildLog(u.Easy)};return this.next.set(u.Again,l),this.next.set(u.Hard,f),this.next.set(u.Good,g),this.next.set(u.Easy,m),this.next.get(e)}next_ds(e,i,a,n,r,s,o){e.difficulty=this.algorithm.next_difficulty(r,u.Again),e.stability=this.algorithm.next_forget_stability(r,s,o),i.difficulty=this.algorithm.next_difficulty(r,u.Hard),i.stability=this.algorithm.next_recall_stability(r,s,o,u.Hard),a.difficulty=this.algorithm.next_difficulty(r,u.Good),a.stability=this.algorithm.next_recall_stability(r,s,o,u.Good),n.difficulty=this.algorithm.next_difficulty(r,u.Easy),n.stability=this.algorithm.next_recall_stability(r,s,o,u.Easy)}next_interval(e,i,a,n,r){let s,o;s=this.algorithm.next_interval(i.stability,r),o=this.algorithm.next_interval(a.stability,r),s=Math.min(s,o),o=Math.max(o,s+1);const c=Math.max(this.algorithm.next_interval(n.stability,r),o+1);e.scheduled_days=0,e.due=this.review_time.scheduler(5),i.scheduled_days=s,i.due=this.review_time.scheduler(s,!0),a.scheduled_days=o,a.due=this.review_time.scheduler(o,!0),n.scheduled_days=c,n.due=this.review_time.scheduler(c,!0)}next_state(e,i,a,n){e.state=h.Relearning,i.state=h.Review,a.state=h.Review,n.state=h.Review}}class be extends De{newState(e){const i=this.next.get(e);if(i)return i;this.current.scheduled_days=0,this.current.elapsed_days=0;const a=y.card(this.current),n=y.card(this.current),r=y.card(this.current),s=y.card(this.current);return this.init_ds(a,n,r,s),this.next_interval(a,n,r,s,0),this.next_state(a,n,r,s),this.update_next(a,n,r,s),this.next.get(e)}init_ds(e,i,a,n){e.difficulty=this.algorithm.init_difficulty(u.Again),e.stability=this.algorithm.init_stability(u.Again),i.difficulty=this.algorithm.init_difficulty(u.Hard),i.stability=this.algorithm.init_stability(u.Hard),a.difficulty=this.algorithm.init_difficulty(u.Good),a.stability=this.algorithm.init_stability(u.Good),n.difficulty=this.algorithm.init_difficulty(u.Easy),n.stability=this.algorithm.init_stability(u.Easy)}learningState(e){return this.reviewState(e)}reviewState(e){const i=this.next.get(e);if(i)return i;const a=this.current.elapsed_days,{difficulty:n,stability:r}=this.last,s=this.algorithm.forgetting_curve(a,r),o=y.card(this.current),c=y.card(this.current),d=y.card(this.current),w=y.card(this.current);return this.next_ds(o,c,d,w,n,r,s),this.next_interval(o,c,d,w,a),this.next_state(o,c,d,w),o.lapses+=1,this.update_next(o,c,d,w),this.next.get(e)}next_ds(e,i,a,n,r,s,o){e.difficulty=this.algorithm.next_difficulty(r,u.Again),e.stability=this.algorithm.next_forget_stability(r,s,o),i.difficulty=this.algorithm.next_difficulty(r,u.Hard),i.stability=this.algorithm.next_recall_stability(r,s,o,u.Hard),a.difficulty=this.algorithm.next_difficulty(r,u.Good),a.stability=this.algorithm.next_recall_stability(r,s,o,u.Good),n.difficulty=this.algorithm.next_difficulty(r,u.Easy),n.stability=this.algorithm.next_recall_stability(r,s,o,u.Easy)}next_interval(e,i,a,n,r){let s,o,c,d;s=this.algorithm.next_interval(e.stability,r),o=this.algorithm.next_interval(i.stability,r),c=this.algorithm.next_interval(a.stability,r),d=this.algorithm.next_interval(n.stability,r),s=Math.min(s,o),o=Math.max(o,s+1),c=Math.max(c,o+1),d=Math.max(d,c+1),e.scheduled_days=s,e.due=this.review_time.scheduler(s,!0),i.scheduled_days=o,i.due=this.review_time.scheduler(o,!0),a.scheduled_days=c,a.due=this.review_time.scheduler(c,!0),n.scheduled_days=d,n.due=this.review_time.scheduler(d,!0)}next_state(e,i,a,n){e.state=h.Review,i.state=h.Review,a.state=h.Review,n.state=h.Review}update_next(e,i,a,n){const r={card:e,log:this.buildLog(u.Again)},s={card:i,log:super.buildLog(u.Hard)},o={card:a,log:super.buildLog(u.Good)},c={card:n,log:super.buildLog(u.Easy)};this.next.set(u.Again,r),this.next.set(u.Hard,s),this.next.set(u.Good,o),this.next.set(u.Easy,c)}}class xt{constructor(e){M(this,"fsrs");this.fsrs=e}replay(e,i,a){return this.fsrs.next(e,i,a)}handleManualRating(e,i,a,n,r,s,o){if(typeof i>"u")throw new Error("reschedule: state is required for manual rating");let c,d;if(i===h.New)c={rating:u.Manual,state:i,due:o??a,stability:e.stability,difficulty:e.difficulty,elapsed_days:n,last_elapsed_days:e.elapsed_days,scheduled_days:e.scheduled_days,review:a},d=ae(a),d.last_review=a;else{if(typeof o>"u")throw new Error("reschedule: due is required for manual rating");const w=o.diff(a,"days");c={rating:u.Manual,state:e.state,due:e.last_review||e.due,stability:e.stability,difficulty:e.difficulty,elapsed_days:n,last_elapsed_days:e.elapsed_days,scheduled_days:e.scheduled_days,review:a},d={...e,state:i,due:o,last_review:a,stability:r||e.stability,difficulty:s||e.difficulty,elapsed_days:n,scheduled_days:w,reps:e.reps+1}}return{card:d,log:c}}reschedule(e,i){const a=[];let n=ae(e.due);for(const r of i){let s;if(r.review=y.time(r.review),r.rating===u.Manual){let o=0;n.state!==h.New&&n.last_review&&(o=r.review.diff(n.last_review,"days")),s=this.handleManualRating(n,r.state,r.review,o,r.stability,r.difficulty,r.due?y.time(r.due):void 0)}else s=this.replay(n,r.review,r.rating);a.push(s),n=s.card}return a}calculateManualRecord(e,i,a,n){if(!a)return null;const{card:r,log:s}=a,o=y.card(e);return o.due.getTime()===r.due.getTime()?null:(o.scheduled_days=r.due.diff(o.due,"days"),this.handleManualRating(o,r.state,y.time(i),s.elapsed_days,n?r.stability:void 0,n?r.difficulty:void 0,r.due))}}class Mt extends bt{constructor(i){super(i);M(this,"Scheduler");const{enable_short_term:a}=this.parameters;this.Scheduler=a?_e:be}params_handler_proxy(){const i=this;return{set:function(a,n,r){return n==="request_retention"&&Number.isFinite(r)?i.intervalModifier=i.calculate_interval_modifier(Number(r)):n==="enable_short_term"&&(i.Scheduler=r===!0?_e:be),Reflect.set(a,n,r),!0}}}repeat(i,a,n){const r=this.Scheduler,s=new r(i,a,this).preview();return n&&typeof n=="function"?n(s):s}next(i,a,n,r){const s=this.Scheduler,o=new s(i,a,this),c=y.rating(n);if(c===u.Manual)throw new Error("Cannot review a manual rating");const d=o.review(c);return r&&typeof r=="function"?r(d):d}get_retrievability(i,a,n=!0){const r=y.card(i);a=a?y.time(a):new Date;const s=r.state!==h.New?Math.max(a.diff(r.last_review,"days"),0):0,o=r.state!==h.New?this.forgetting_curve(s,+r.stability.toFixed(8)):0;return n?`${(o*100).toFixed(2)}%`:o}rollback(i,a,n){const r=y.card(i),s=y.review_log(a);if(s.rating===u.Manual)throw new Error("Cannot rollback a manual rating");let o,c,d;switch(s.state){case h.New:o=s.due,c=void 0,d=0;break;case h.Learning:case h.Relearning:case h.Review:o=s.review,c=s.due,d=r.lapses-(s.rating===u.Again&&s.state===h.Review?1:0);break}const w={...r,due:o,stability:s.stability,difficulty:s.difficulty,elapsed_days:s.last_elapsed_days,scheduled_days:s.scheduled_days,reps:Math.max(0,r.reps-1),lapses:Math.max(0,d),state:s.state,last_review:c};return n&&typeof n=="function"?n(w):w}forget(i,a,n=!1,r){const s=y.card(i);a=y.time(a);const o=s.state===h.New?0:a.diff(s.last_review,"days"),c={rating:u.Manual,state:s.state,due:s.due,stability:s.stability,difficulty:s.difficulty,elapsed_days:0,last_elapsed_days:s.elapsed_days,scheduled_days:o,review:a},d={card:{...s,due:a,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:n?0:s.reps,lapses:n?0:s.lapses,state:h.New,last_review:s.last_review},log:c};return r&&typeof r=="function"?r(d):d}reschedule(i,a=[],n={}){const{recordLogHandler:r,reviewsOrderBy:s,skipManual:o=!0,now:c=new Date,update_memory_state:d=!1}=n;s&&typeof s=="function"&&a.sort(s),o&&(a=a.filter(v=>v.rating!==u.Manual));const w=new xt(this),l=w.reschedule(n.first_card||ae(),a),f=l.length,g=y.card(i),m=w.calculateManualRecord(g,c,f?l[f-1]:void 0,d);return r&&typeof r=="function"?{collections:l.map(r),reschedule_item:m?r(m):null}:{collections:l,reschedule_item:m}}}const Kt=t=>new Mt(t||{}),ne=1e3,K=60*ne,H=60*K,O=24*H,Z=7*O,ee=29.53*O,te=365.2425*O,re=new Date(0);function z(t=new Date){return new Date(t.getFullYear(),t.getMonth(),t.getDate())}function St(t){const e=Math.abs(t);return e<1.5*K?{unit:"second",multiplier:ne,value:t/ne}:e<1.5*H?{unit:"minute",multiplier:K,value:t/K}:e<1.5*O?{unit:"hour",multiplier:H,value:t/H}:e<Z?{unit:"day",multiplier:O,value:t/O}:e<ee?{unit:"week",multiplier:Z,value:t/Z}:e<te?{unit:"month",multiplier:ee,value:t/ee}:{unit:"year",multiplier:te,value:t/te}}const Et=new Intl.RelativeTimeFormat("default",{numeric:"always",style:"short"});function Wt(t){const{unit:e,value:i}=St(t);return Et.format(Math.round(i),e)}function qt(t){return new Promise(e=>{globalThis.setTimeout(e,t)})}async function*Rt(t){const e=new Set;let i=await(await A).transaction("progress").store.index("state+due").openCursor();for(;i;){const[a,n]=i.key;if(a<h.Learning){i=await i.continue([h.Learning,re]);continue}if(a>h.Learning&&a<h.Relearning){i=await i.continue([h.Relearning,re]);continue}{const[r]=i.primaryKey;e.has(r)||(yield i,e.add(r))}i=await i.continue()}}async function Ae(){const t=new Set,e=(await A).transaction("reviews").store.index("review").iterate(IDBKeyRange.lowerBound(z()));for await(const i of e)t.add(i.value.cardId);return t}async function It(){const t=new Date;return(await A).transaction("reviews").store.index("state+review").count(IDBKeyRange.bound([h.New,z()],[h.New,t],!0,!0))}async function*Nt(){const t=await Ae(),e=(await A).transaction(["cards","progress"],"readwrite"),i=e.objectStore("cards"),a=e.objectStore("progress").index("cardId+cardType+state");let n=await i.index("position").openKeyCursor(IDBKeyRange.bound([0,0],[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],!1,!0));for(;n;){if(t.has(n.primaryKey)){n=await n.continue();continue}let r=await a.openCursor([n.primaryKey,"kanji-write",h.New]);r||(r=await a.openCursor([n.primaryKey,"kanji-read",h.New])),r&&(yield r),n=await n.continue()}}async function Dt(){const t=new Date;return(await A).transaction("reviews").store.index("state+review").count(IDBKeyRange.bound([h.Review,z()],[h.Review,t],!1,!0))}async function*At(){const t=new Date,e=await Ae(),i=(await A).transaction(["cards","progress","reviews"],"readonly"),a=i.objectStore("cards"),n=i.objectStore("progress"),r=IDBKeyRange.bound([h.Review,re],[h.Review,t],!1,!0);let s=await n.index("state+due").openCursor(r);for(;s;){const[o]=s.primaryKey;if(!e.has(o)){const c=await a.get(o);c&&c.position.priority<Number.POSITIVE_INFINITY&&(yield s)}s=await s.continue()}}async function Ct(){const t=await(await A).getAllFromIndex("review-limits","time",IDBKeyRange.lowerBound(z())),e={due:0,new:0};for(const{count:i}of t)e.due+=i.due,e.new+=i.new;return e}async function Tt({cardId:t,cardType:e},i){const a=(await A).transaction(["progress","reviews"],"readwrite"),n=a.objectStore("progress"),r=a.objectStore("reviews");await n.put({cardId:t,cardType:e,fsrs:i.card}),await r.add({cardId:t,cardType:e,log:i.log})}const se=le("shodoku.app.preferences.limit.due",50),oe=le("shodoku.app.preferences.limit.new",10),Qt=le("shodoku.app.preferences.fsrs.fuzz-enabled",!0);async function Vt(t={new:oe.value,due:se.value}){return await(await A).add("review-limits",{time:new Date,count:t}),Ee.postMessage("review-limit-increased")}const Lt=ze("reviews",()=>{const t=N(!1),e=N([]),i=N([]),a=N([]),n=N(0),r=N(0),s=ue(()=>{const l=new Date;let f=0,g=0,m=0,v=e.value.at(f);const _=[];for(;v&&v.fsrs.due<l;)_.push(v),f+=1,v=e.value.at(f);const b=i.value.length,S=a.value.length,T=b+n.value,E=S+r.value,L=Math.ceil((E+T)/E),$=Math.floor(L/2);let C=i.value.at(g),R=a.value.at(m);for(;C||R;){if(!R){C&&_.push(C),g+=1,C=i.value.at(g);continue}if(!C){R&&_.push(R),m+=1,R=a.value.at(m);continue}(n.value+g+r.value+m)%L===$?(_.push(R),m+=1,R=a.value.at(m)):(_.push(C),g+=1,C=i.value.at(g))}for(;v;)_.push(v),f+=1,v=e.value.at(f);return _});async function o({cardId:l,cardType:f,fsrs:g},m){if(g.state===h.New?(a.value=a.value.filter(v=>v.cardId!==l),r.value+=1):g.state===h.Review?(i.value=i.value.filter(v=>v.cardId!==l),n.value+=1):e.value=e.value.filter(v=>v.cardId!==l),m.card.state===h.Learning||m.card.state===h.Relearning){const v={cardId:l,cardType:f,fsrs:m.card},_=m.card.due,b=e.value.findIndex(S=>_<S.fsrs.due);e.value=e.value.toSpliced(b===-1?e.value.length:b,0,v)}await Tt({cardId:l,cardType:f},m),Ee.postMessage("card-review")}function c(l){return e.value.some(f=>f.cardId===l)}function d(l){return i.value.some(f=>f.cardId===l)}async function w(){t.value=!0;try{const l=await Ct();n.value=await Dt(),r.value=await It(),e.value=await V(Rt(),Y(f=>f.value),Q()),i.value=await V(At(),he(({primaryKey:[f]})=>f),de(({primaryKey:[f]})=>!c(f)),fe(Math.max(0,se.value+l.due-n.value)),Y(f=>f.value),Q()),a.value=await V(Nt(),he(f=>f.primaryKey[0]),de(({primaryKey:[f]})=>!c(f)&&!d(f)),fe(Math.max(0,oe.value+l.new-r.value)),Y(f=>f.value),Q())}finally{t.value=!1}}return w(),setTimeout(w,H),j([se,oe],w),{refreshing:t,learningQueue:e,dueQueue:i,newQueue:a,queue:s,refreshQueues:w,rateCard:o}});function Yt(){const t=Lt();return ue(()=>({due:t.dueQueue.length,new:t.newQueue.length,learning:t.learningQueue.length}))}function Jt(){const{result:t}=Be(async()=>{const e=new Map,i=(await A).transaction("reviews").store.index("review");for await(const a of i.iterate(IDBKeyRange.lowerBound(z()))){const n=a.value;let r=e.get(n.cardId);r||(r=[],e.set(n.cardId,r)),r.push(n)}return e});return t}export{Mt as O,Kt as W,Jt as a,h as b,Gt as c,Lt as d,zt as e,Wt as f,ge as g,Bt as h,Vt as i,kt as j,P as k,u as l,Ge as m,Ht as n,Pt as o,jt as p,Re as q,We as r,qt as s,D as t,Yt as u,Qt as v,ae as w,se as x,oe as y};
