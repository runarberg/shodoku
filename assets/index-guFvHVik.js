var G=Object.defineProperty;var k=(s,t,e)=>t in s?G(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var f=(s,t,e)=>k(s,typeof t!="symbol"?t+"":t,e);var u=(s=>(s[s.New=0]="New",s[s.Learning=1]="Learning",s[s.Review=2]="Review",s[s.Relearning=3]="Relearning",s))(u||{}),l=(s=>(s[s.Manual=0]="Manual",s[s.Again=1]="Again",s[s.Hard=2]="Hard",s[s.Good=3]="Good",s[s.Easy=4]="Easy",s))(l||{});class o{static card(t){return{...t,state:o.state(t.state),due:o.time(t.due),last_review:t.last_review?o.time(t.last_review):void 0}}static rating(t){if(typeof t=="string"){const e=t.charAt(0).toUpperCase(),i=t.slice(1).toLowerCase(),a=l[`${e}${i}`];if(a===void 0)throw new Error(`Invalid rating:[${t}]`);return a}else if(typeof t=="number")return t;throw new Error(`Invalid rating:[${t}]`)}static state(t){if(typeof t=="string"){const e=t.charAt(0).toUpperCase(),i=t.slice(1).toLowerCase(),a=u[`${e}${i}`];if(a===void 0)throw new Error(`Invalid state:[${t}]`);return a}else if(typeof t=="number")return t;throw new Error(`Invalid state:[${t}]`)}static time(t){if(typeof t=="object"&&t instanceof Date)return t;if(typeof t=="string"){const e=Date.parse(t);if(isNaN(e))throw new Error(`Invalid date:[${t}]`);return new Date(e)}else if(typeof t=="number")return new Date(t);throw new Error(`Invalid date:[${t}]`)}static review_log(t){return{...t,due:o.time(t.due),rating:o.rating(t.rating),state:o.state(t.state),review:o.time(t.review)}}}const N=.9,F=36500,z=[.4072,1.1829,3.1262,15.4722,7.2102,.5316,1.0651,.0234,1.616,.1544,1.0824,1.9813,.0953,.2975,2.2042,.2407,2.9466,.5034,.6567],D=!1,I=!0,x=s=>{let t=z;return s!=null&&s.w&&(s.w.length===19?t=s==null?void 0:s.w:s.w.length===17&&(t=s==null?void 0:s.w.concat([0,0]),console.debug("[FSRS V5]auto fill w to 19 length"))),{request_retention:(s==null?void 0:s.request_retention)||N,maximum_interval:(s==null?void 0:s.maximum_interval)||F,w:t,enable_fuzz:(s==null?void 0:s.enable_fuzz)??D,enable_short_term:(s==null?void 0:s.enable_short_term)??I}};function Y(s,t){const e={due:s?o.time(s):new Date,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:0,lapses:0,state:u.New,last_review:void 0};return t&&typeof t=="function"?t(e):e}Date.prototype.scheduler=function(s,t){return $(this,s,t)},Date.prototype.diff=function(s,t){return C(this,s,t)},Date.prototype.format=function(){return q(this)},Date.prototype.dueFormat=function(s,t,e){return T(this,s,t,e)};function $(s,t,e){return new Date(e?y(s).getTime()+t*24*60*60*1e3:y(s).getTime()+t*60*1e3)}function C(s,t,e){if(!s||!t)throw new Error("Invalid date");const i=y(s).getTime()-y(t).getTime();let a=0;switch(e){case"days":a=Math.floor(i/(24*60*60*1e3));break;case"minutes":a=Math.floor(i/(60*1e3));break}return a}function q(s){const t=y(s),e=t.getFullYear(),i=t.getMonth()+1,a=t.getDate(),n=t.getHours(),r=t.getMinutes(),h=t.getSeconds();return`${e}-${m(i)}-${m(a)} ${m(n)}:${m(r)}:${m(h)}`}function m(s){return s<10?`0${s}`:`${s}`}const w=[60,60,24,31,12],v=["second","min","hour","day","month","year"];function T(s,t,e,i=v){s=y(s),t=y(t),i.length!==v.length&&(i=v);let a=s.getTime()-t.getTime(),n;for(a/=1e3,n=0;n<w.length&&!(a<w[n]);n++)a/=w[n];return`${Math.floor(a)}${e?i[n]:""}`}function y(s){return o.time(s)}const U=[l.Again,l.Hard,l.Good,l.Easy],P=[{start:2.5,end:7,factor:.15},{start:7,end:20,factor:.1},{start:20,end:1/0,factor:.05}];function V(s,t,e){let i=1;for(const r of P)i+=r.factor*Math.max(Math.min(s,r.end)-r.start,0);s=Math.min(s,e);let a=Math.max(2,Math.round(s-i));const n=Math.min(Math.round(s+i),e);return s>t&&(a=Math.max(a,t+1)),a=Math.min(a,n),{min_ivl:a,max_ivl:n}}function p(s,t,e){return Math.min(Math.max(s,t),e)}class j{constructor(t){f(this,"c");f(this,"s0");f(this,"s1");f(this,"s2");const e=B();this.c=1,this.s0=e(" "),this.s1=e(" "),this.s2=e(" "),t==null&&(t=+new Date),this.s0-=e(t),this.s0<0&&(this.s0+=1),this.s1-=e(t),this.s1<0&&(this.s1+=1),this.s2-=e(t),this.s2<0&&(this.s2+=1)}next(){const t=2091639*this.s0+this.c*23283064365386963e-26;return this.s0=this.s1,this.s1=this.s2,this.s2=t-(this.c=t|0),this.s2}set state(t){this.c=t.c,this.s0=t.s0,this.s1=t.s1,this.s2=t.s2}get state(){return{c:this.c,s0:this.s0,s1:this.s1,s2:this.s2}}}function B(){let s=4022871197;return function(t){t=String(t);for(let e=0;e<t.length;e++){s+=t.charCodeAt(e);let i=.02519603282416938*s;s=i>>>0,i-=s,i*=s,s=i>>>0,i-=s,s+=i*4294967296}return(s>>>0)*23283064365386963e-26}}function J(s){const t=new j(s),e=()=>t.next();return e.int32=()=>t.next()*4294967296|0,e.double=()=>e()+(e()*2097152|0)*11102230246251565e-32,e.state=()=>t.state,e.importState=i=>(t.state=i,e),e}const b=-.5,M=19/81;class K{constructor(t){f(this,"param");f(this,"intervalModifier");f(this,"_seed");this.param=new Proxy(x(t),this.params_handler_proxy()),this.intervalModifier=this.calculate_interval_modifier(this.param.request_retention)}get interval_modifier(){return this.intervalModifier}set seed(t){this._seed=t}calculate_interval_modifier(t){if(t<=0||t>1)throw new Error("Requested retention rate should be in the range (0,1]");return+((Math.pow(t,1/b)-1)/M).toFixed(8)}get parameters(){return this.param}set parameters(t){this.update_parameters(t)}params_handler_proxy(){const t=this;return{set:function(e,i,a){return i==="request_retention"&&Number.isFinite(a)&&(t.intervalModifier=t.calculate_interval_modifier(Number(a))),Reflect.set(e,i,a),!0}}}update_parameters(t){const e=x(t);for(const i in e)if(i in this.param){const a=i;this.param[a]=e[a]}}init_stability(t){return Math.max(this.param.w[t-1],.1)}init_difficulty(t){return this.constrain_difficulty(this.param.w[4]-Math.exp((t-1)*this.param.w[5])+1)}apply_fuzz(t,e,i){if(!i||t<2.5)return Math.round(t);const a=J(this._seed)(),{min_ivl:n,max_ivl:r}=V(t,e,this.param.maximum_interval);return Math.floor(a*(r-n+1)+n)}next_interval(t,e,i=this.param.enable_fuzz){const a=Math.min(Math.max(1,Math.round(t*this.intervalModifier)),this.param.maximum_interval);return this.apply_fuzz(a,e,i)}next_difficulty(t,e){const i=t-this.param.w[6]*(e-3);return this.constrain_difficulty(this.mean_reversion(this.init_difficulty(l.Easy),i))}constrain_difficulty(t){return Math.min(Math.max(+t.toFixed(8),1),10)}mean_reversion(t,e){return+(this.param.w[7]*t+(1-this.param.w[7])*e).toFixed(8)}next_recall_stability(t,e,i,a){const n=l.Hard===a?this.param.w[15]:1,r=l.Easy===a?this.param.w[16]:1;return+p(e*(1+Math.exp(this.param.w[8])*(11-t)*Math.pow(e,-this.param.w[9])*(Math.exp((1-i)*this.param.w[10])-1)*n*r),.01,36500).toFixed(8)}next_forget_stability(t,e,i){return+p(this.param.w[11]*Math.pow(t,-this.param.w[12])*(Math.pow(e+1,this.param.w[13])-1)*Math.exp((1-i)*this.param.w[14]),.01,36500).toFixed(8)}next_short_term_stability(t,e){return+p(t*Math.exp(this.param.w[17]*(e-3+this.param.w[18])),.01,36500).toFixed(8)}forgetting_curve(t,e){return+Math.pow(1+M*t/e,b).toFixed(8)}}class S{constructor(t,e,i){f(this,"last");f(this,"current");f(this,"review_time");f(this,"next",new Map);f(this,"algorithm");this.algorithm=i,this.last=o.card(t),this.current=o.card(t),this.review_time=o.time(e),this.init()}init(){const{state:t,last_review:e}=this.current;let i=0;t!==u.New&&e&&(i=this.review_time.diff(e,"days")),this.current.last_review=this.review_time,this.current.elapsed_days=i,this.current.reps+=1,this.initSeed()}preview(){return{[l.Again]:this.review(l.Again),[l.Hard]:this.review(l.Hard),[l.Good]:this.review(l.Good),[l.Easy]:this.review(l.Easy),[Symbol.iterator]:this.previewIterator.bind(this)}}*previewIterator(){for(const t of U)yield this.review(t)}review(t){const{state:e}=this.last;let i;switch(e){case u.New:i=this.newState(t);break;case u.Learning:case u.Relearning:i=this.learningState(t);break;case u.Review:i=this.reviewState(t);break}if(i)return i;throw new Error("Invalid grade")}initSeed(){const t=this.review_time.getTime(),e=this.current.reps,i=this.current.difficulty*this.current.stability;this.algorithm.seed=`${t}_${e}_${i}`}buildLog(t){const{last_review:e,due:i,elapsed_days:a}=this.last;return{rating:t,state:this.current.state,due:e||i,stability:this.current.stability,difficulty:this.current.difficulty,elapsed_days:this.current.elapsed_days,last_elapsed_days:a,scheduled_days:this.current.scheduled_days,review:this.review_time}}}class E extends S{newState(t){const e=this.next.get(t);if(e)return e;const i=o.card(this.current);switch(i.difficulty=this.algorithm.init_difficulty(t),i.stability=this.algorithm.init_stability(t),t){case l.Again:i.scheduled_days=0,i.due=this.review_time.scheduler(1),i.state=u.Learning;break;case l.Hard:i.scheduled_days=0,i.due=this.review_time.scheduler(5),i.state=u.Learning;break;case l.Good:i.scheduled_days=0,i.due=this.review_time.scheduler(10),i.state=u.Learning;break;case l.Easy:{const n=this.algorithm.next_interval(i.stability,this.current.elapsed_days,this.algorithm.parameters.enable_fuzz);i.scheduled_days=n,i.due=this.review_time.scheduler(n,!0),i.state=u.Review;break}default:throw new Error("Invalid grade")}const a={card:i,log:this.buildLog(t)};return this.next.set(t,a),a}learningState(t){const e=this.next.get(t);if(e)return e;const{state:i,difficulty:a,stability:n}=this.last,r=o.card(this.current),h=this.current.elapsed_days;switch(r.difficulty=this.algorithm.next_difficulty(a,t),r.stability=this.algorithm.next_short_term_stability(n,t),t){case l.Again:{r.scheduled_days=0,r.due=this.review_time.scheduler(5,!1),r.state=i;break}case l.Hard:{r.scheduled_days=0,r.due=this.review_time.scheduler(10),r.state=i;break}case l.Good:{const c=this.algorithm.next_interval(r.stability,h);r.scheduled_days=c,r.due=this.review_time.scheduler(c,!0),r.state=u.Review;break}case l.Easy:{const c=this.algorithm.next_short_term_stability(n,l.Good),_=this.algorithm.next_interval(c,h),g=Math.max(this.algorithm.next_interval(r.stability,h),_+1);r.scheduled_days=g,r.due=this.review_time.scheduler(g,!0),r.state=u.Review;break}default:throw new Error("Invalid grade")}const d={card:r,log:this.buildLog(t)};return this.next.set(t,d),d}reviewState(t){const e=this.next.get(t);if(e)return e;const i=this.current.elapsed_days,{difficulty:a,stability:n}=this.last,r=this.algorithm.forgetting_curve(i,n),h=o.card(this.current),d=o.card(this.current),c=o.card(this.current),_=o.card(this.current);this.next_ds(h,d,c,_,a,n,r),this.next_interval(h,d,c,_,i),this.next_state(h,d,c,_),h.lapses+=1;const g={card:h,log:this.buildLog(l.Again)},H={card:d,log:super.buildLog(l.Hard)},A={card:c,log:super.buildLog(l.Good)},L={card:_,log:super.buildLog(l.Easy)};return this.next.set(l.Again,g),this.next.set(l.Hard,H),this.next.set(l.Good,A),this.next.set(l.Easy,L),this.next.get(t)}next_ds(t,e,i,a,n,r,h){t.difficulty=this.algorithm.next_difficulty(n,l.Again),t.stability=this.algorithm.next_forget_stability(n,r,h),e.difficulty=this.algorithm.next_difficulty(n,l.Hard),e.stability=this.algorithm.next_recall_stability(n,r,h,l.Hard),i.difficulty=this.algorithm.next_difficulty(n,l.Good),i.stability=this.algorithm.next_recall_stability(n,r,h,l.Good),a.difficulty=this.algorithm.next_difficulty(n,l.Easy),a.stability=this.algorithm.next_recall_stability(n,r,h,l.Easy)}next_interval(t,e,i,a,n){let r,h;r=this.algorithm.next_interval(e.stability,n),h=this.algorithm.next_interval(i.stability,n),r=Math.min(r,h),h=Math.max(h,r+1);const d=Math.max(this.algorithm.next_interval(a.stability,n),h+1);t.scheduled_days=0,t.due=this.review_time.scheduler(5),e.scheduled_days=r,e.due=this.review_time.scheduler(r,!0),i.scheduled_days=h,i.due=this.review_time.scheduler(h,!0),a.scheduled_days=d,a.due=this.review_time.scheduler(d,!0)}next_state(t,e,i,a){t.state=u.Relearning,e.state=u.Review,i.state=u.Review,a.state=u.Review}}class R extends S{newState(t){const e=this.next.get(t);if(e)return e;this.current.scheduled_days=0,this.current.elapsed_days=0;const i=o.card(this.current),a=o.card(this.current),n=o.card(this.current),r=o.card(this.current);return this.init_ds(i,a,n,r),this.next_interval(i,a,n,r,0),this.next_state(i,a,n,r),this.update_next(i,a,n,r),this.next.get(t)}init_ds(t,e,i,a){t.difficulty=this.algorithm.init_difficulty(l.Again),t.stability=this.algorithm.init_stability(l.Again),e.difficulty=this.algorithm.init_difficulty(l.Hard),e.stability=this.algorithm.init_stability(l.Hard),i.difficulty=this.algorithm.init_difficulty(l.Good),i.stability=this.algorithm.init_stability(l.Good),a.difficulty=this.algorithm.init_difficulty(l.Easy),a.stability=this.algorithm.init_stability(l.Easy)}learningState(t){return this.reviewState(t)}reviewState(t){const e=this.next.get(t);if(e)return e;const i=this.current.elapsed_days,{difficulty:a,stability:n}=this.last,r=this.algorithm.forgetting_curve(i,n),h=o.card(this.current),d=o.card(this.current),c=o.card(this.current),_=o.card(this.current);return this.next_ds(h,d,c,_,a,n,r),this.next_interval(h,d,c,_,i),this.next_state(h,d,c,_),h.lapses+=1,this.update_next(h,d,c,_),this.next.get(t)}next_ds(t,e,i,a,n,r,h){t.difficulty=this.algorithm.next_difficulty(n,l.Again),t.stability=this.algorithm.next_forget_stability(n,r,h),e.difficulty=this.algorithm.next_difficulty(n,l.Hard),e.stability=this.algorithm.next_recall_stability(n,r,h,l.Hard),i.difficulty=this.algorithm.next_difficulty(n,l.Good),i.stability=this.algorithm.next_recall_stability(n,r,h,l.Good),a.difficulty=this.algorithm.next_difficulty(n,l.Easy),a.stability=this.algorithm.next_recall_stability(n,r,h,l.Easy)}next_interval(t,e,i,a,n){let r,h,d,c;r=this.algorithm.next_interval(t.stability,n),h=this.algorithm.next_interval(e.stability,n),d=this.algorithm.next_interval(i.stability,n),c=this.algorithm.next_interval(a.stability,n),r=Math.min(r,h),h=Math.max(h,r+1),d=Math.max(d,h+1),c=Math.max(c,d+1),t.scheduled_days=r,t.due=this.review_time.scheduler(r,!0),e.scheduled_days=h,e.due=this.review_time.scheduler(h,!0),i.scheduled_days=d,i.due=this.review_time.scheduler(d,!0),a.scheduled_days=c,a.due=this.review_time.scheduler(c,!0)}next_state(t,e,i,a){t.state=u.Review,e.state=u.Review,i.state=u.Review,a.state=u.Review}update_next(t,e,i,a){const n={card:t,log:this.buildLog(l.Again)},r={card:e,log:super.buildLog(l.Hard)},h={card:i,log:super.buildLog(l.Good)},d={card:a,log:super.buildLog(l.Easy)};this.next.set(l.Again,n),this.next.set(l.Hard,r),this.next.set(l.Good,h),this.next.set(l.Easy,d)}}class O extends K{constructor(e){super(e);f(this,"Scheduler");const{enable_short_term:i}=this.parameters;this.Scheduler=i?E:R}params_handler_proxy(){const e=this;return{set:function(i,a,n){return a==="request_retention"&&Number.isFinite(n)?e.intervalModifier=e.calculate_interval_modifier(Number(n)):a==="enable_short_term"&&(e.Scheduler=n===!0?E:R),Reflect.set(i,a,n),!0}}}repeat(e,i,a){const n=this.Scheduler,r=new n(e,i,this).preview();return a&&typeof a=="function"?a(r):r}next(e,i,a,n){const r=this.Scheduler,h=new r(e,i,this),d=o.rating(a);if(d===l.Manual)throw new Error("Cannot review a manual rating");const c=h.review(d);return n&&typeof n=="function"?n(c):c}get_retrievability(e,i,a=!0){const n=o.card(e);i=i?o.time(i):new Date;const r=n.state!==u.New?Math.max(i.diff(n.last_review,"days"),0):0,h=n.state!==u.New?this.forgetting_curve(r,+n.stability.toFixed(8)):0;return a?`${(h*100).toFixed(2)}%`:h}rollback(e,i,a){const n=o.card(e),r=o.review_log(i);if(r.rating===l.Manual)throw new Error("Cannot rollback a manual rating");let h,d,c;switch(r.state){case u.New:h=r.due,d=void 0,c=0;break;case u.Learning:case u.Relearning:case u.Review:h=r.review,d=r.due,c=n.lapses-(r.rating===l.Again&&r.state===u.Review?1:0);break}const _={...n,due:h,stability:r.stability,difficulty:r.difficulty,elapsed_days:r.last_elapsed_days,scheduled_days:r.scheduled_days,reps:Math.max(0,n.reps-1),lapses:Math.max(0,c),state:r.state,last_review:d};return a&&typeof a=="function"?a(_):_}forget(e,i,a=!1,n){const r=o.card(e);i=o.time(i);const h=r.state===u.New?0:i.diff(r.last_review,"days"),d={rating:l.Manual,state:r.state,due:r.due,stability:r.stability,difficulty:r.difficulty,elapsed_days:0,last_elapsed_days:r.elapsed_days,scheduled_days:h,review:i},c={card:{...r,due:i,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:a?0:r.reps,lapses:a?0:r.lapses,state:u.New,last_review:r.last_review},log:d};return n&&typeof n=="function"?n(c):c}reschedule(e,i={}){if(!Array.isArray(e))throw new Error("cards must be an array");const a=[];for(const n of e){if(o.state(n.state)!==u.Review||!n.last_review)continue;const r=Math.floor(n.scheduled_days),h=this.next_interval(+n.stability.toFixed(2),Math.round(n.elapsed_days),i.enable_fuzz??!0);if(h===r||h===0)continue;const d={...n};d.scheduled_days=h;const c=$(d.last_review,h,!0);i.dateHandler&&typeof i.dateHandler=="function"?d.due=i.dateHandler(c):d.due=c,a.push(d)}return a}}const W=s=>new O(s||{});export{W as Q,Y as U,l,u,x as w};
