import{al as D,am as si,c as _a,q as V,I as oi}from"./index-sZE7bAWT.js";import{u as sr,d as E,l as ue,a as ui}from"./db-CaAx7W_9.js";function ci(t,e){return async r=>{const n=new Map;for await(const a of r){const i=t(a);let s=n.get(i);s||(s=[],n.set(i,s)),s.push(a)}return n}}function de(){return async function(t){const e=[];for await(const r of t)e.push(r);return e}}function X(t,...e){return e.reduce((r,n)=>n(r),t)}function Zt(t){return async function*(e){for await(const r of e)yield t(r)}}function li(t){return function*(e){const r=e[Symbol.iterator]();let n=r.next();for(;!n.done&&t(n.value);)n=r.next();try{for(;!n.done;)yield n.value,n=r.next()}finally{typeof r.return=="function"&&r.return()}}}function _r(t){return async function*(e){for await(const r of e)t(r)&&(yield r)}}function Sr(t){if(t<0){const e=-t;return async function*(r){const n=[];let a=0;for await(const i of r)n[a]=i,a=(a+1)%e;for(let i=0;i<n.length;i+=1)yield n[a],a=(a+1)%e}}return async function*(e){let r=0;for await(const n of e){if(r>=t)break;r+=1,yield n}}}class he extends Error{constructor(e,r){super(e),this.name="DevalueError",this.path=r.join("")}}function Ar(t){return Object(t)!==t}const fi=Object.getOwnPropertyNames(Object.prototype).sort().join("\0");function di(t){const e=Object.getPrototypeOf(t);return e===Object.prototype||e===null||Object.getPrototypeOf(e)===null||Object.getOwnPropertyNames(e).sort().join("\0")===fi}function hi(t){return Object.prototype.toString.call(t).slice(8,-1)}function yi(t){switch(t){case'"':return'\\"';case"<":return"\\u003C";case"\\":return"\\\\";case`
`:return"\\n";case"\r":return"\\r";case"	":return"\\t";case"\b":return"\\b";case"\f":return"\\f";case"\u2028":return"\\u2028";case"\u2029":return"\\u2029";default:return t<" "?`\\u${t.charCodeAt(0).toString(16).padStart(4,"0")}`:""}}function F(t){let e="",r=0;const n=t.length;for(let a=0;a<n;a+=1){const i=t[a],s=yi(i);s&&(e+=t.slice(r,a)+s,r=a+1)}return`"${r===0?t:e+t.slice(r)}"`}function vi(t){return Object.getOwnPropertySymbols(t).filter(e=>Object.getOwnPropertyDescriptor(t,e).enumerable)}const pi=/^[a-zA-Z_$][a-zA-Z_$0-9]*$/;function Ir(t){return pi.test(t)?"."+t:"["+JSON.stringify(t)+"]"}function gi(t){const e=new DataView(t);let r="";for(let n=0;n<t.byteLength;n++)r+=String.fromCharCode(e.getUint8(n));return bi(r)}function mi(t){const e=wi(t),r=new ArrayBuffer(e.length),n=new DataView(r);for(let a=0;a<r.byteLength;a++)n.setUint8(a,e.charCodeAt(a));return r}const Sa="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function wi(t){t.length%4===0&&(t=t.replace(/==?$/,""));let e="",r=0,n=0;for(let a=0;a<t.length;a++)r<<=6,r|=Sa.indexOf(t[a]),n+=6,n===24&&(e+=String.fromCharCode((r&16711680)>>16),e+=String.fromCharCode((r&65280)>>8),e+=String.fromCharCode(r&255),r=n=0);return n===12?(r>>=4,e+=String.fromCharCode(r)):n===18&&(r>>=2,e+=String.fromCharCode((r&65280)>>8),e+=String.fromCharCode(r&255)),e}function bi(t){let e="";for(let r=0;r<t.length;r+=3){const n=[void 0,void 0,void 0,void 0];n[0]=t.charCodeAt(r)>>2,n[1]=(t.charCodeAt(r)&3)<<4,t.length>r+1&&(n[1]|=t.charCodeAt(r+1)>>4,n[2]=(t.charCodeAt(r+1)&15)<<2),t.length>r+2&&(n[2]|=t.charCodeAt(r+2)>>6,n[3]=t.charCodeAt(r+2)&63);for(let a=0;a<n.length;a++)typeof n[a]>"u"?e+="=":e+=Sa[n[a]]}return e}const or=-1,Aa=-2,Ia=-3,Oa=-4,Ea=-5,ur=-6;function ye(t,e){return _i(JSON.parse(t))}function _i(t,e){if(typeof t=="number")return a(t,!0);if(!Array.isArray(t)||t.length===0)throw new Error("Invalid input");const r=t,n=Array(r.length);function a(i,s=!1){if(i===or)return;if(i===Ia)return NaN;if(i===Oa)return 1/0;if(i===Ea)return-1/0;if(i===ur)return-0;if(s||typeof i!="number")throw new Error("Invalid input");if(i in n)return n[i];const o=r[i];if(!o||typeof o!="object")n[i]=o;else if(Array.isArray(o))if(typeof o[0]=="string"){const c=o[0];switch(c){case"Date":n[i]=new Date(o[1]);break;case"Set":const u=new Set;n[i]=u;for(let d=1;d<o.length;d+=1)u.add(a(o[d]));break;case"Map":const f=new Map;n[i]=f;for(let d=1;d<o.length;d+=2)f.set(a(o[d]),a(o[d+1]));break;case"RegExp":n[i]=new RegExp(o[1],o[2]);break;case"Object":n[i]=Object(o[1]);break;case"BigInt":n[i]=BigInt(o[1]);break;case"null":const l=Object.create(null);n[i]=l;for(let d=1;d<o.length;d+=2)l[o[d]]=a(o[d+1]);break;case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"BigInt64Array":case"BigUint64Array":{const d=globalThis[c],h=new d(a(o[1]));n[i]=o[2]!==void 0?h.subarray(o[2],o[3]):h;break}case"ArrayBuffer":{const d=o[1],h=mi(d);n[i]=h;break}case"Temporal.Duration":case"Temporal.Instant":case"Temporal.PlainDate":case"Temporal.PlainTime":case"Temporal.PlainDateTime":case"Temporal.PlainMonthDay":case"Temporal.PlainYearMonth":case"Temporal.ZonedDateTime":{const d=c.slice(9);n[i]=Temporal[d].from(o[1]);break}case"URL":{const d=new URL(o[1]);n[i]=d;break}case"URLSearchParams":{const d=new URLSearchParams(o[1]);n[i]=d;break}default:throw new Error(`Unknown type ${c}`)}}else{const c=new Array(o.length);n[i]=c;for(let u=0;u<o.length;u+=1){const f=o[u];f!==Aa&&(c[u]=a(f))}}else{const c={};n[i]=c;for(const u in o){if(u==="__proto__")throw new Error("Cannot parse an object with a `__proto__` property");const f=o[u];c[u]=a(f)}}return n[i]}return a(0)}function ee(t,e){const r=[],n=new Map,a=[],i=[];let s=0;function o(u){if(typeof u=="function")throw new he("Cannot stringify a function",i);if(u===void 0)return or;if(Number.isNaN(u))return Ia;if(u===1/0)return Oa;if(u===-1/0)return Ea;if(u===0&&1/u<0)return ur;if(n.has(u))return n.get(u);const f=s++;n.set(u,f);for(const{key:d,fn:h}of a){const y=h(u);if(y)return r[f]=`["${d}",${o(y)}]`,f}let l="";if(Ar(u))l=ve(u);else{const d=hi(u);switch(d){case"Number":case"String":case"Boolean":l=`["Object",${ve(u)}]`;break;case"BigInt":l=`["BigInt",${u}]`;break;case"Date":l=`["Date","${!isNaN(u.getDate())?u.toISOString():""}"]`;break;case"URL":l=`["URL",${F(u.toString())}]`;break;case"URLSearchParams":l=`["URLSearchParams",${F(u.toString())}]`;break;case"RegExp":const{source:y,flags:_}=u;l=_?`["RegExp",${F(y)},"${_}"]`:`["RegExp",${F(y)}]`;break;case"Array":l="[";for(let v=0;v<u.length;v+=1)v>0&&(l+=","),v in u?(i.push(`[${v}]`),l+=o(u[v]),i.pop()):l+=Aa;l+="]";break;case"Set":l='["Set"';for(const v of u)l+=`,${o(v)}`;l+="]";break;case"Map":l='["Map"';for(const[v,b]of u)i.push(`.get(${Ar(v)?ve(v):"..."})`),l+=`,${o(v)},${o(b)}`,i.pop();l+="]";break;case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"BigInt64Array":case"BigUint64Array":{const v=u;l='["'+d+'",'+o(v.buffer);const b=u.byteOffset,g=b+u.byteLength;if(b>0||g!==v.buffer.byteLength){const m=+/(\d+)/.exec(d)[1]/8;l+=`,${b/m},${g/m}`}l+="]";break}case"ArrayBuffer":{l=`["ArrayBuffer","${gi(u)}"]`;break}case"Temporal.Duration":case"Temporal.Instant":case"Temporal.PlainDate":case"Temporal.PlainTime":case"Temporal.PlainDateTime":case"Temporal.PlainMonthDay":case"Temporal.PlainYearMonth":case"Temporal.ZonedDateTime":l=`["${d}",${F(u.toString())}]`;break;default:if(!di(u))throw new he("Cannot stringify arbitrary non-POJOs",i);if(vi(u).length>0)throw new he("Cannot stringify POJOs with symbolic keys",i);if(Object.getPrototypeOf(u)===null){l='["null"';for(const v in u)i.push(Ir(v)),l+=`,${F(v)},${o(u[v])}`,i.pop();l+="]"}else{l="{";let v=!1;for(const b in u)v&&(l+=","),v=!0,i.push(Ir(b)),l+=`${F(b)}:${o(u[b])}`,i.pop();l+="}"}}}return r[f]=l,f}const c=o(t);return c<0?`${c}`:`[${r.join(",")}]`}function ve(t){const e=typeof t;return e==="string"?F(t):t instanceof String?F(t.toString()):t===void 0?or.toString():t===0&&1/t<0?ur.toString():e==="bigint"?`["BigInt","${t}"]`:String(t)}const G="shodoku.app.config.sync.remote",Si=D(`${G}.fetch.method`,"GET"),Ai=D(`${G}.fetch.url`,""),Ii=D(`${G}.fetch.headers`,[]),Oi=D(`${G}.push.method`,"PUT"),Ei=D(`${G}.push.url`,""),Ri=D(`${G}.push.headers`,[]),Ra=D(`${G}.push.body`,void 0);function Mo(){return sr(async()=>await(await E).count("syncs")>0)}function Po(){return sr(async()=>await(await E).count("sync.staging.stores")>0)}function Ta(t){return typeof t!="object"?typeof t:t===null?"null":t.constructor.name}function cr(t,e){return`Expected "${t}" but got "${Ta(e)}"`}function lr(t,e,r){return`Expected key "${t}" to be "${e}" but is "${Ta(r)}"`}class N extends Error{name="AssertationError";code="ERR_ASSERTION";actual;constructor(e={}){if(e.message)super(e.message);else{let r;"actual"in e&&(r=`Assertion failed with "${e.actual}"`),super(r||"Assertion failed")}this.actual=e.actual}}function xa(t){if(typeof t!="string")throw new N({message:cr("String",t),actual:t})}function te(t){if(!Array.isArray(t))throw new N({message:cr("Array",t),actual:t})}function qa(t){if(typeof t!="object"||t==null)throw new N({message:cr("Object",t),actual:t})}function fr(t,e){if(!(t in e))throw new N({message:`Expected object to have key "${String(t)}" but none found`,actual:e})}function U(t,e,{optional:r=!1,nullable:n=!1}={}){if(!(r&&!(t in e))&&(fr(t,e),typeof e[t]!="string")){if(n&&e[t]===null||r&&typeof e[t]>"u")return;throw new N({message:lr(String(t),"String",e[t]),actual:e})}}function Or(t,e,{optional:r=!1,nullable:n=!1}={}){if(!(r&&!(t in e))&&(fr(t,e),typeof e[t]!="number")){if(n&&e[t]===null||r&&typeof e[t]>"u")return;throw new N({message:lr(String(t),"Number",e[t]),actual:e})}}function oe(t,e,{optional:r=!1,nullable:n=!1}={}){if(!(r&&!(t in e))&&(fr(t,e),!Array.isArray(e[t]))){if(n&&e[t]===null||r&&typeof e[t]>"u")return;throw new N({message:lr(String(t),"Array",e[t]),actual:e})}}function pe(t,e,{optional:r=!1,nullable:n=!1}={}){oe(t,e,{optional:r,nullable:n});const a=e[t];if(a)for(const i of a)xa(i)}var Er=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Rr={},Tr={},Z,xr;function T(){if(xr)return Z;xr=1;var t=function(e){return e&&e.Math===Math&&e};return Z=t(typeof globalThis=="object"&&globalThis)||t(typeof window=="object"&&window)||t(typeof self=="object"&&self)||t(typeof Er=="object"&&Er)||t(typeof Z=="object"&&Z)||(function(){return this})()||Function("return this")(),Z}var ge={},me,qr;function k(){return qr||(qr=1,me=function(t){try{return!!t()}catch{return!0}}),me}var we,Mr;function H(){if(Mr)return we;Mr=1;var t=k();return we=!t(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!==7}),we}var be,Pr;function Ma(){if(Pr)return be;Pr=1;var t=k();return be=!t(function(){var e=(function(){}).bind();return typeof e!="function"||e.hasOwnProperty("prototype")}),be}var _e,Dr;function dr(){if(Dr)return _e;Dr=1;var t=Ma(),e=Function.prototype.call;return _e=t?e.bind(e):function(){return e.apply(e,arguments)},_e}var Se={},jr;function Ti(){if(jr)return Se;jr=1;var t={}.propertyIsEnumerable,e=Object.getOwnPropertyDescriptor,r=e&&!t.call({1:2},1);return Se.f=r?function(a){var i=e(this,a);return!!i&&i.enumerable}:t,Se}var Ae,Br;function Pa(){return Br||(Br=1,Ae=function(t,e){return{enumerable:!(t&1),configurable:!(t&2),writable:!(t&4),value:e}}),Ae}var Ie,Cr;function j(){if(Cr)return Ie;Cr=1;var t=Ma(),e=Function.prototype,r=e.call,n=t&&e.bind.bind(r,r);return Ie=t?n:function(a){return function(){return r.apply(a,arguments)}},Ie}var Oe,$r;function hr(){if($r)return Oe;$r=1;var t=j(),e=t({}.toString),r=t("".slice);return Oe=function(n){return r(e(n),8,-1)},Oe}var Ee,Nr;function xi(){if(Nr)return Ee;Nr=1;var t=j(),e=k(),r=hr(),n=Object,a=t("".split);return Ee=e(function(){return!n("z").propertyIsEnumerable(0)})?function(i){return r(i)==="String"?a(i,""):n(i)}:n,Ee}var Re,Fr;function Da(){return Fr||(Fr=1,Re=function(t){return t==null}),Re}var Te,Lr;function ja(){if(Lr)return Te;Lr=1;var t=Da(),e=TypeError;return Te=function(r){if(t(r))throw new e("Can't call method on "+r);return r},Te}var xe,Ur;function yr(){if(Ur)return xe;Ur=1;var t=xi(),e=ja();return xe=function(r){return t(e(r))},xe}var qe,kr;function $(){if(kr)return qe;kr=1;var t=typeof document=="object"&&document.all;return qe=typeof t>"u"&&t!==void 0?function(e){return typeof e=="function"||e===t}:function(e){return typeof e=="function"},qe}var Me,Kr;function W(){if(Kr)return Me;Kr=1;var t=$();return Me=function(e){return typeof e=="object"?e!==null:t(e)},Me}var Pe,Gr;function Ba(){if(Gr)return Pe;Gr=1;var t=T(),e=$(),r=function(n){return e(n)?n:void 0};return Pe=function(n,a){return arguments.length<2?r(t[n]):t[n]&&t[n][a]},Pe}var De,Hr;function qi(){if(Hr)return De;Hr=1;var t=j();return De=t({}.isPrototypeOf),De}var je,Vr;function Mi(){if(Vr)return je;Vr=1;var t=T(),e=t.navigator,r=e&&e.userAgent;return je=r?String(r):"",je}var Be,zr;function Pi(){if(zr)return Be;zr=1;var t=T(),e=Mi(),r=t.process,n=t.Deno,a=r&&r.versions||n&&n.version,i=a&&a.v8,s,o;return i&&(s=i.split("."),o=s[0]>0&&s[0]<4?1:+(s[0]+s[1])),!o&&e&&(s=e.match(/Edge\/(\d+)/),(!s||s[1]>=74)&&(s=e.match(/Chrome\/(\d+)/),s&&(o=+s[1]))),Be=o,Be}var Ce,Yr;function Ca(){if(Yr)return Ce;Yr=1;var t=Pi(),e=k(),r=T(),n=r.String;return Ce=!!Object.getOwnPropertySymbols&&!e(function(){var a=Symbol("symbol detection");return!n(a)||!(Object(a)instanceof Symbol)||!Symbol.sham&&t&&t<41}),Ce}var $e,Wr;function $a(){if(Wr)return $e;Wr=1;var t=Ca();return $e=t&&!Symbol.sham&&typeof Symbol.iterator=="symbol",$e}var Ne,Qr;function Na(){if(Qr)return Ne;Qr=1;var t=Ba(),e=$(),r=qi(),n=$a(),a=Object;return Ne=n?function(i){return typeof i=="symbol"}:function(i){var s=t("Symbol");return e(s)&&r(s.prototype,a(i))},Ne}var Fe,Zr;function Di(){if(Zr)return Fe;Zr=1;var t=String;return Fe=function(e){try{return t(e)}catch{return"Object"}},Fe}var Le,Jr;function Fa(){if(Jr)return Le;Jr=1;var t=$(),e=Di(),r=TypeError;return Le=function(n){if(t(n))return n;throw new r(e(n)+" is not a function")},Le}var Ue,Xr;function ji(){if(Xr)return Ue;Xr=1;var t=Fa(),e=Da();return Ue=function(r,n){var a=r[n];return e(a)?void 0:t(a)},Ue}var ke,en;function Bi(){if(en)return ke;en=1;var t=dr(),e=$(),r=W(),n=TypeError;return ke=function(a,i){var s,o;if(i==="string"&&e(s=a.toString)&&!r(o=t(s,a))||e(s=a.valueOf)&&!r(o=t(s,a))||i!=="string"&&e(s=a.toString)&&!r(o=t(s,a)))return o;throw new n("Can't convert object to primitive value")},ke}var Ke={exports:{}},Ge,tn;function Ci(){return tn||(tn=1,Ge=!1),Ge}var He,rn;function vr(){if(rn)return He;rn=1;var t=T(),e=Object.defineProperty;return He=function(r,n){try{e(t,r,{value:n,configurable:!0,writable:!0})}catch{t[r]=n}return n},He}var nn;function pr(){if(nn)return Ke.exports;nn=1;var t=Ci(),e=T(),r=vr(),n="__core-js_shared__",a=Ke.exports=e[n]||r(n,{});return(a.versions||(a.versions=[])).push({version:"3.45.1",mode:t?"pure":"global",copyright:"Â© 2014-2025 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.45.1/LICENSE",source:"https://github.com/zloirock/core-js"}),Ke.exports}var Ve,an;function La(){if(an)return Ve;an=1;var t=pr();return Ve=function(e,r){return t[e]||(t[e]=r||{})},Ve}var ze,sn;function $i(){if(sn)return ze;sn=1;var t=ja(),e=Object;return ze=function(r){return e(t(r))},ze}var Ye,on;function K(){if(on)return Ye;on=1;var t=j(),e=$i(),r=t({}.hasOwnProperty);return Ye=Object.hasOwn||function(a,i){return r(e(a),i)},Ye}var We,un;function Ua(){if(un)return We;un=1;var t=j(),e=0,r=Math.random(),n=t(1.1.toString);return We=function(a){return"Symbol("+(a===void 0?"":a)+")_"+n(++e+r,36)},We}var Qe,cn;function gr(){if(cn)return Qe;cn=1;var t=T(),e=La(),r=K(),n=Ua(),a=Ca(),i=$a(),s=t.Symbol,o=e("wks"),c=i?s.for||s:s&&s.withoutSetter||n;return Qe=function(u){return r(o,u)||(o[u]=a&&r(s,u)?s[u]:c("Symbol."+u)),o[u]},Qe}var Ze,ln;function Ni(){if(ln)return Ze;ln=1;var t=dr(),e=W(),r=Na(),n=ji(),a=Bi(),i=gr(),s=TypeError,o=i("toPrimitive");return Ze=function(c,u){if(!e(c)||r(c))return c;var f=n(c,o),l;if(f){if(u===void 0&&(u="default"),l=t(f,c,u),!e(l)||r(l))return l;throw new s("Can't convert object to primitive value")}return u===void 0&&(u="number"),a(c,u)},Ze}var Je,fn;function ka(){if(fn)return Je;fn=1;var t=Ni(),e=Na();return Je=function(r){var n=t(r,"string");return e(n)?n:n+""},Je}var Xe,dn;function Fi(){if(dn)return Xe;dn=1;var t=T(),e=W(),r=t.document,n=e(r)&&e(r.createElement);return Xe=function(a){return n?r.createElement(a):{}},Xe}var et,hn;function Ka(){if(hn)return et;hn=1;var t=H(),e=k(),r=Fi();return et=!t&&!e(function(){return Object.defineProperty(r("div"),"a",{get:function(){return 7}}).a!==7}),et}var yn;function Ga(){if(yn)return ge;yn=1;var t=H(),e=dr(),r=Ti(),n=Pa(),a=yr(),i=ka(),s=K(),o=Ka(),c=Object.getOwnPropertyDescriptor;return ge.f=t?c:function(f,l){if(f=a(f),l=i(l),o)try{return c(f,l)}catch{}if(s(f,l))return n(!e(r.f,f,l),f[l])},ge}var tt={},rt,vn;function Li(){if(vn)return rt;vn=1;var t=H(),e=k();return rt=t&&e(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!==42}),rt}var nt,pn;function Ha(){if(pn)return nt;pn=1;var t=W(),e=String,r=TypeError;return nt=function(n){if(t(n))return n;throw new r(e(n)+" is not an object")},nt}var gn;function mr(){if(gn)return tt;gn=1;var t=H(),e=Ka(),r=Li(),n=Ha(),a=ka(),i=TypeError,s=Object.defineProperty,o=Object.getOwnPropertyDescriptor,c="enumerable",u="configurable",f="writable";return tt.f=t?r?function(d,h,y){if(n(d),h=a(h),n(y),typeof d=="function"&&h==="prototype"&&"value"in y&&f in y&&!y[f]){var _=o(d,h);_&&_[f]&&(d[h]=y.value,y={configurable:u in y?y[u]:_[u],enumerable:c in y?y[c]:_[c],writable:!1})}return s(d,h,y)}:s:function(d,h,y){if(n(d),h=a(h),n(y),e)try{return s(d,h,y)}catch{}if("get"in y||"set"in y)throw new i("Accessors not supported");return"value"in y&&(d[h]=y.value),d},tt}var at,mn;function Va(){if(mn)return at;mn=1;var t=H(),e=mr(),r=Pa();return at=t?function(n,a,i){return e.f(n,a,r(1,i))}:function(n,a,i){return n[a]=i,n},at}var it={exports:{}},st,wn;function Ui(){if(wn)return st;wn=1;var t=H(),e=K(),r=Function.prototype,n=t&&Object.getOwnPropertyDescriptor,a=e(r,"name"),i=a&&(function(){}).name==="something",s=a&&(!t||t&&n(r,"name").configurable);return st={EXISTS:a,PROPER:i,CONFIGURABLE:s},st}var ot,bn;function ki(){if(bn)return ot;bn=1;var t=j(),e=$(),r=pr(),n=t(Function.toString);return e(r.inspectSource)||(r.inspectSource=function(a){return n(a)}),ot=r.inspectSource,ot}var ut,_n;function Ki(){if(_n)return ut;_n=1;var t=T(),e=$(),r=t.WeakMap;return ut=e(r)&&/native code/.test(String(r)),ut}var ct,Sn;function Gi(){if(Sn)return ct;Sn=1;var t=La(),e=Ua(),r=t("keys");return ct=function(n){return r[n]||(r[n]=e(n))},ct}var lt,An;function za(){return An||(An=1,lt={}),lt}var ft,In;function Hi(){if(In)return ft;In=1;var t=Ki(),e=T(),r=W(),n=Va(),a=K(),i=pr(),s=Gi(),o=za(),c="Object already initialized",u=e.TypeError,f=e.WeakMap,l,d,h,y=function(g){return h(g)?d(g):l(g,{})},_=function(g){return function(m){var A;if(!r(m)||(A=d(m)).type!==g)throw new u("Incompatible receiver, "+g+" required");return A}};if(t||i.state){var v=i.state||(i.state=new f);v.get=v.get,v.has=v.has,v.set=v.set,l=function(g,m){if(v.has(g))throw new u(c);return m.facade=g,v.set(g,m),m},d=function(g){return v.get(g)||{}},h=function(g){return v.has(g)}}else{var b=s("state");o[b]=!0,l=function(g,m){if(a(g,b))throw new u(c);return m.facade=g,n(g,b,m),m},d=function(g){return a(g,b)?g[b]:{}},h=function(g){return a(g,b)}}return ft={set:l,get:d,has:h,enforce:y,getterFor:_},ft}var On;function Vi(){if(On)return it.exports;On=1;var t=j(),e=k(),r=$(),n=K(),a=H(),i=Ui().CONFIGURABLE,s=ki(),o=Hi(),c=o.enforce,u=o.get,f=String,l=Object.defineProperty,d=t("".slice),h=t("".replace),y=t([].join),_=a&&!e(function(){return l(function(){},"length",{value:8}).length!==8}),v=String(String).split("String"),b=it.exports=function(g,m,A){d(f(m),0,7)==="Symbol("&&(m="["+h(f(m),/^Symbol\(([^)]*)\).*$/,"$1")+"]"),A&&A.getter&&(m="get "+m),A&&A.setter&&(m="set "+m),(!n(g,"name")||i&&g.name!==m)&&(a?l(g,"name",{value:m,configurable:!0}):g.name=m),_&&A&&n(A,"arity")&&g.length!==A.arity&&l(g,"length",{value:A.arity});try{A&&n(A,"constructor")&&A.constructor?a&&l(g,"prototype",{writable:!1}):g.prototype&&(g.prototype=void 0)}catch{}var I=c(g);return n(I,"source")||(I.source=y(v,typeof m=="string"?m:"")),g};return Function.prototype.toString=b(function(){return r(this)&&u(this).source||s(this)},"toString"),it.exports}var dt,En;function zi(){if(En)return dt;En=1;var t=$(),e=mr(),r=Vi(),n=vr();return dt=function(a,i,s,o){o||(o={});var c=o.enumerable,u=o.name!==void 0?o.name:i;if(t(s)&&r(s,u,o),o.global)c?a[i]=s:n(i,s);else{try{o.unsafe?a[i]&&(c=!0):delete a[i]}catch{}c?a[i]=s:e.f(a,i,{value:s,enumerable:!1,configurable:!o.nonConfigurable,writable:!o.nonWritable})}return a},dt}var ht={},yt,Rn;function Yi(){if(Rn)return yt;Rn=1;var t=Math.ceil,e=Math.floor;return yt=Math.trunc||function(n){var a=+n;return(a>0?e:t)(a)},yt}var vt,Tn;function Ya(){if(Tn)return vt;Tn=1;var t=Yi();return vt=function(e){var r=+e;return r!==r||r===0?0:t(r)},vt}var pt,xn;function Wi(){if(xn)return pt;xn=1;var t=Ya(),e=Math.max,r=Math.min;return pt=function(n,a){var i=t(n);return i<0?e(i+a,0):r(i,a)},pt}var gt,qn;function Qi(){if(qn)return gt;qn=1;var t=Ya(),e=Math.min;return gt=function(r){var n=t(r);return n>0?e(n,9007199254740991):0},gt}var mt,Mn;function Wa(){if(Mn)return mt;Mn=1;var t=Qi();return mt=function(e){return t(e.length)},mt}var wt,Pn;function Zi(){if(Pn)return wt;Pn=1;var t=yr(),e=Wi(),r=Wa(),n=function(a){return function(i,s,o){var c=t(i),u=r(c);if(u===0)return!a&&-1;var f=e(o,u),l;if(a&&s!==s){for(;u>f;)if(l=c[f++],l!==l)return!0}else for(;u>f;f++)if((a||f in c)&&c[f]===s)return a||f||0;return!a&&-1}};return wt={includes:n(!0),indexOf:n(!1)},wt}var bt,Dn;function Ji(){if(Dn)return bt;Dn=1;var t=j(),e=K(),r=yr(),n=Zi().indexOf,a=za(),i=t([].push);return bt=function(s,o){var c=r(s),u=0,f=[],l;for(l in c)!e(a,l)&&e(c,l)&&i(f,l);for(;o.length>u;)e(c,l=o[u++])&&(~n(f,l)||i(f,l));return f},bt}var _t,jn;function Xi(){return jn||(jn=1,_t=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"]),_t}var Bn;function es(){if(Bn)return ht;Bn=1;var t=Ji(),e=Xi(),r=e.concat("length","prototype");return ht.f=Object.getOwnPropertyNames||function(a){return t(a,r)},ht}var St={},Cn;function ts(){return Cn||(Cn=1,St.f=Object.getOwnPropertySymbols),St}var At,$n;function rs(){if($n)return At;$n=1;var t=Ba(),e=j(),r=es(),n=ts(),a=Ha(),i=e([].concat);return At=t("Reflect","ownKeys")||function(o){var c=r.f(a(o)),u=n.f;return u?i(c,u(o)):c},At}var It,Nn;function ns(){if(Nn)return It;Nn=1;var t=K(),e=rs(),r=Ga(),n=mr();return It=function(a,i,s){for(var o=e(i),c=n.f,u=r.f,f=0;f<o.length;f++){var l=o[f];!t(a,l)&&!(s&&t(s,l))&&c(a,l,u(i,l))}},It}var Ot,Fn;function as(){if(Fn)return Ot;Fn=1;var t=k(),e=$(),r=/#|\.prototype\./,n=function(c,u){var f=i[a(c)];return f===o?!0:f===s?!1:e(u)?t(u):!!u},a=n.normalize=function(c){return String(c).replace(r,".").toLowerCase()},i=n.data={},s=n.NATIVE="N",o=n.POLYFILL="P";return Ot=n,Ot}var Et,Ln;function Qa(){if(Ln)return Et;Ln=1;var t=T(),e=Ga().f,r=Va(),n=zi(),a=vr(),i=ns(),s=as();return Et=function(o,c){var u=o.target,f=o.global,l=o.stat,d,h,y,_,v,b;if(f?h=t:l?h=t[u]||a(u,{}):h=t[u]&&t[u].prototype,h)for(y in c){if(v=c[y],o.dontCallGetSet?(b=e(h,y),_=b&&b.value):_=h[y],d=s(f?y:u+(l?".":"#")+y,o.forced),!d&&_!==void 0){if(typeof v==typeof _)continue;i(v,_)}(o.sham||_&&_.sham)&&r(v,"sham",!0),n(h,y,v,o)}},Et}var Rt,Un;function is(){if(Un)return Rt;Un=1;var t=Wa();return Rt=function(e,r,n){for(var a=0,i=arguments.length>2?n:t(r),s=new e(i);i>a;)s[a]=r[a++];return s},Rt}var Tt,kn;function Za(){if(kn)return Tt;kn=1;var t=W(),e=String,r=TypeError;return Tt=function(n){if(n===void 0||t(n))return n;throw new r(e(n)+" is not an object or undefined")},Tt}var xt,Kn;function ss(){if(Kn)return xt;Kn=1;var t=TypeError;return xt=function(e){if(typeof e=="string")return e;throw new t("Argument is not a string")},xt}var qt,Gn;function Ja(){if(Gn)return qt;Gn=1;var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=t+"+/",r=t+"-_",n=function(a){for(var i={},s=0;s<64;s++)i[a.charAt(s)]=s;return i};return qt={i2c:e,c2i:n(e),i2cUrl:r,c2iUrl:n(r)},qt}var Mt,Hn;function Xa(){if(Hn)return Mt;Hn=1;var t=TypeError;return Mt=function(e){var r=e&&e.alphabet;if(r===void 0||r==="base64"||r==="base64url")return r||"base64";throw new t("Incorrect `alphabet` option")},Mt}var Pt,Vn;function os(){return Vn||(Vn=1,Pt=typeof ArrayBuffer<"u"&&typeof DataView<"u"),Pt}var Dt,zn;function us(){if(zn)return Dt;zn=1;var t=j(),e=Fa();return Dt=function(r,n,a){try{return t(e(Object.getOwnPropertyDescriptor(r,n)[a]))}catch{}},Dt}var jt,Yn;function cs(){if(Yn)return jt;Yn=1;var t=T(),e=us(),r=hr(),n=t.ArrayBuffer,a=t.TypeError;return jt=n&&e(n.prototype,"byteLength","get")||function(i){if(r(i)!=="ArrayBuffer")throw new a("ArrayBuffer expected");return i.byteLength},jt}var Bt,Wn;function ls(){if(Wn)return Bt;Wn=1;var t=T(),e=os(),r=cs(),n=t.DataView;return Bt=function(a){if(!e||r(a)!==0)return!1;try{return new n(a),!1}catch{return!0}},Bt}var Ct,Qn;function ei(){if(Qn)return Ct;Qn=1;var t=ls(),e=TypeError;return Ct=function(r){if(t(r))throw new e("ArrayBuffer is detached");return r},Ct}var $t,Zn;function fs(){if(Zn)return $t;Zn=1;var t=T(),e=j(),r=Za(),n=ss(),a=K(),i=Ja(),s=Xa(),o=ei(),c=i.c2i,u=i.c2iUrl,f=t.SyntaxError,l=t.TypeError,d=e("".charAt),h=function(v,b){for(var g=v.length;b<g;b++){var m=d(v,b);if(m!==" "&&m!=="	"&&m!==`
`&&m!=="\f"&&m!=="\r")break}return b},y=function(v,b,g){var m=v.length;m<4&&(v+=m===2?"AA":"A");var A=(b[d(v,0)]<<18)+(b[d(v,1)]<<12)+(b[d(v,2)]<<6)+b[d(v,3)],I=[A>>16&255,A>>8&255,A&255];if(m===2){if(g&&I[1]!==0)throw new f("Extra bits");return[I[0]]}if(m===3){if(g&&I[2]!==0)throw new f("Extra bits");return[I[0],I[1]]}return I},_=function(v,b,g){for(var m=b.length,A=0;A<m;A++)v[g+A]=b[A];return g+m};return $t=function(v,b,g,m){n(v),r(b);var A=s(b)==="base64"?c:u,I=b?b.lastChunkHandling:void 0;if(I===void 0&&(I="loose"),I!=="loose"&&I!=="strict"&&I!=="stop-before-partial")throw new l("Incorrect `lastChunkHandling` option");g&&o(g.buffer);var O=v.length,q=g||[],R=0,Q=0,P="",M=0;if(m)for(;;){if(M=h(v,M),M===O){if(P.length>0){if(I==="stop-before-partial")break;if(I==="loose"){if(P.length===1)throw new f("Malformed padding: exactly one additional character");R=_(q,y(P,A,!1),R)}else throw new f("Missing padding")}Q=O;break}var fe=d(v,M);if(++M,fe==="="){if(P.length<2)throw new f("Padding is too early");if(M=h(v,M),P.length===2){if(M===O){if(I==="stop-before-partial")break;throw new f("Malformed padding: only one =")}d(v,M)==="="&&(++M,M=h(v,M))}if(M<O)throw new f("Unexpected character after padding");R=_(q,y(P,A,I==="strict"),R),Q=O;break}if(!a(A,fe))throw new f("Unexpected character");var br=m-R;if(br===1&&P.length===2||br===2&&P.length===3||(P+=fe,P.length===4&&(R=_(q,y(P,A,!1),R),P="",Q=M,R===m)))break}return{bytes:q,read:Q,written:R}},$t}var Jn;function ti(){if(Jn)return Tr;Jn=1;var t=Qa(),e=T(),r=is(),n=fs(),a=e.Uint8Array,i=!a||!a.fromBase64||!(function(){try{a.fromBase64("a");return}catch{}try{a.fromBase64("",null)}catch{return!0}})();return a&&t({target:"Uint8Array",stat:!0,forced:i},{fromBase64:function(o){var c=n(o,arguments.length>1?arguments[1]:void 0,null,9007199254740991);return r(a,c.bytes)}}),Tr}var Xn;function ds(){return Xn||(Xn=1,ti()),Rr}var Nt,ea;function hs(){if(ea)return Nt;ea=1;var t=ds();return Nt=t,Nt}var ta={},ra;function ys(){return ra||(ra=1,ti()),ta}var Ft,na;function vs(){if(na)return Ft;na=1;var t=hs();return ys(),Ft=t,Ft}vs();var aa={},ia={},Lt,sa;function ps(){if(sa)return Lt;sa=1;var t=gr(),e=t("toStringTag"),r={};return r[e]="z",Lt=String(r)==="[object z]",Lt}var Ut,oa;function gs(){if(oa)return Ut;oa=1;var t=ps(),e=$(),r=hr(),n=gr(),a=n("toStringTag"),i=Object,s=r((function(){return arguments})())==="Arguments",o=function(c,u){try{return c[u]}catch{}};return Ut=t?r:function(c){var u,f,l;return c===void 0?"Undefined":c===null?"Null":typeof(f=o(u=i(c),a))=="string"?f:s?r(u):(l=r(u))==="Object"&&e(u.callee)?"Arguments":l},Ut}var kt,ua;function ms(){if(ua)return kt;ua=1;var t=gs(),e=TypeError;return kt=function(r){if(t(r)==="Uint8Array")return r;throw new e("Argument is not an Uint8Array")},kt}var ca;function ri(){if(ca)return ia;ca=1;var t=Qa(),e=T(),r=j(),n=Za(),a=ms(),i=ei(),s=Ja(),o=Xa(),c=s.i2c,u=s.i2cUrl,f=r("".charAt),l=e.Uint8Array,d=!l||!l.prototype.toBase64||!(function(){try{var h=new l;h.toBase64(null)}catch{return!0}})();return l&&t({target:"Uint8Array",proto:!0,forced:d},{toBase64:function(){var y=a(this),_=arguments.length?n(arguments[0]):void 0,v=o(_)==="base64"?c:u,b=!!_&&!!_.omitPadding;i(this.buffer);for(var g="",m=0,A=y.length,I,O=function(q){return f(v,I>>6*q&63)};m+2<A;m+=3)I=(y[m]<<16)+(y[m+1]<<8)+y[m+2],g+=O(3)+O(2)+O(1)+O(0);return m+2===A?(I=(y[m]<<16)+(y[m+1]<<8),g+=O(3)+O(2)+O(1)+(b?"":"=")):m+1===A&&(I=y[m]<<16,g+=O(3)+O(2)+(b?"":"==")),g}}),ia}var la;function ws(){return la||(la=1,ri()),aa}var Kt,fa;function bs(){if(fa)return Kt;fa=1;var t=ws();return Kt=t,Kt}var da={},ha;function _s(){return ha||(ha=1,ri()),da}var Gt,ya;function Ss(){if(ya)return Gt;ya=1;var t=bs();return _s(),Gt=t,Gt}Ss();const As=new RegExp("\\p{Script=Han}","u"),Is=new RegExp("^\\p{Script=Han}$","u"),Os=/[\p{Script=Hiragana}\p{Script=Katakana}\p{Script=Han}\u{2e80}-\u{2fd5}\u{3000}-\u{303f}\u{31f0}-\u{31ff}\u{3220}-\u{3243}\u{3280}-\u{337f}\u{ff5f}-\u{ff9f}\u{ff01}-\u{ff5e}]/u;function Do(t){return Os.test(t)}function jo(t){return As.test(t)}function Bo(t){return Is.test(t)}function Es(t){return new TextDecoder().decode(Uint8Array.fromBase64(t))}function Rs(t){return new TextEncoder().encode(t).toBase64()}const Jt=["bookmarked-words","cards","decks","progress","reviews"],Ts="${PLACEHOLDER}";function xs(t){if(!Jt.includes(t))throw new N({actual:t,message:`Expected "${t}" to be a store name`})}function qs(t,e){oe(t,e);for(const r of e[t]){qa(r),U("name",r),xs(r.name),pe("add",r,{optional:!0}),oe("set",r,{optional:!0});for(const n of r.set??[]){if(te(n),n.length!==2)throw new N({actual:n,message:`Excpected a 2-tuple. Got ${n.length}-tuple`});xa(n[0]),te(n[1]);for(const a of n[1]){if(te(a),a.length!==3)throw new N({actual:n,message:`Excpected a 3-tuple. Got ${a.length}-tuple`});U(0,a),pe(1,a),U(2,a)}}pe("delete",r,{optional:!0})}}function Ms(t,e){oe(t,e);for(const r of e[t])te(r),U(0,r),U(1,r,{nullable:!0})}async function Ps(){const t=Si.value,e=URL.parse(Ai.value),r=new Headers(Ii.value);if(!e)throw new Error("Remote sync not set up");e.host==="gist.githubusercontent.com"&&e.searchParams.set("cachebuster",new Date().toISOString());const a=await fetch(e,{method:t,headers:r,mode:"cors"}),i=await a.text();if(!a.ok)throw new Error(`Error ${a.status} fetching sync: ${i}`);if(!i.trim())return[];const s=Ra.value,o=JSON.parse(s?Es(i):i);return te(o),o.map(c=>(qa(c),U("hash",c),U("parent",c,{nullable:!0}),U("syncedAt",c),Or("dbVersion",c),Or("patchVersion",c),qs("stores",c),Ms("preferences",c),{...c,syncedAt:new Date(c.syncedAt)}))}async function Ds(t){const e=Oi.value,r=URL.parse(Ei.value),n=new Headers(Ri.value),a=Ra.value;if(!r)throw new Error("Remote sync not set up");let i=JSON.stringify(t);a&&(i=a.replace(Ts,Rs(i)));const s=await fetch(r,{method:e,headers:n,body:i,mode:"cors"});if(!s.ok)throw new Error(`Error ${s.status} pushing sync: ${await s.text()}`)}const L="shodoku.app.sync.latest",js=1;async function Bs(t){const e=JSON.stringify(t),r=new TextEncoder().encode(e),n=await crypto.subtle.digest("SHA-256",r);return Array.from(new Uint8Array(n)).map(i=>i.toString(16).padStart(2,"0")).join("")}async function Cs(t){const e={...t,parent:localStorage.getItem(L)};return{...e,hash:await Bs(e)}}async function $s(){const t=await E,e=t.transaction(Jt),r=[];for(const n of Jt){const a=e.objectStore(n),i=await a.getAll();if(i.length===0)continue;const s=i.map(o=>{if(a.autoIncrement&&typeof a.keyPath=="string"){const c=a.keyPath;delete o[c]}return ee(o)});r.push({name:n,add:s})}return r.length===0?null:{syncedAt:new Date,dbVersion:t.version,patchVersion:js,stores:r,preferences:[]}}async function Ns(){const t=await E;if(await t.count("syncs")===0&&localStorage.getItem(L)&&localStorage.removeItem(L),!localStorage.getItem(L))return $s();const e=t.transaction(t.objectStoreNames),r=await X(e.objectStore("sync.staging.stores").iterate(),Zt(a=>a.value),ci(a=>a.store));if(r.size===0)return null;const n=[];for(const[a,i]of r){const s=[],o=[],c=[];for(const f of i)if(f.op==="add"){const l=e.objectStore(a),d=await l.get(f.key);if(!d)continue;if(l.autoIncrement&&typeof l.keyPath=="string"){const h=l.keyPath;delete d[h]}s.push(ee(d))}else f.op==="put"?o.push(ee(await e.objectStore(a).get(f.key))):c.push(ee(f.key));const u={name:a};s.length>0&&(u.add=s),o.length>0&&(u.put=o),c.length>0&&(u.delete=c),(u.add||u.put||u.delete)&&n.push(u)}return{syncedAt:new Date,dbVersion:t.version,patchVersion:1,stores:n,preferences:[]}}function Xt(t,e){if(!t)return e;if(Array.isArray(t))return t.map(n=>Xt(n,e));let r=e;for(const n of t.split("."))r=r[n];return r}function Fs(t,e){return t.updatedAt?e.updatedAt?t.updatedAt>e.updatedAt:!0:e.updatedAt?!1:t.createdAt>e.createdAt}function Ls(t,e){return t.fsrs.last_review?e.fsrs.last_review?t.fsrs.last_review>e.fsrs.last_review:!0:!1}function Us(t,e){return t.log.review>e.log.review}function ks(t,e){return t.bookmarkedAt>e.bookmarkedAt}function Ks(t,e,r){return t==="decks"?Fs(e,r):t==="progress"?Ls(e,r):t==="reviews"?Us(e,r):t==="bookmarked-words"?ks(e,r):!0}function Gs(t,e,r){if(!r)return;const n=r.stores.find(({name:i})=>i===t);if(!n?.add)return;const a=n.add.indexOf(e);a!==-1&&n.add.splice(a,1)}function Hs(t,e,r){if(!r)return;const n=r.stores.find(({name:i})=>i===t);if(!n)return;let{put:a}=n;a||(a=[],n.put=a),a.push(e)}function va(t){return t instanceof DOMException&&t.name==="ConstraintError"}async function Vs(t,e){const r=await E,n=r.transaction(r.objectStoreNames,"readwrite"),a=localStorage.getItem(L)??null;let i;for(const s of X(t,li(({parent:o})=>o!==a))){for(const o of s.stores){const c=n.objectStore(o.name);for(const u of o.add??[]){const f=ye(u),l=c.add(f),d=ui(l);d.addEventListener("error",h=>{va(d.error)&&(h.preventDefault(),h.stopPropagation())});try{await l}catch(h){if(va(h)){const y=await c.get(Xt(c.keyPath,f));if(y){const _=ee(y);Gs(o.name,_,e),Ks(o.name,y,f)?Hs(o.name,_,e):c.put(f)}}else throw h}}for(const u of o.put??[]){const f=ye(u),l=await c.openCursor(Xt(c.keyPath,f));l&&l.update(f)}for(const u of o.delete??[]){const f=ye(u);console.log(f),c.delete(f)}}n.objectStore("syncs").add(s),i=s.hash}await n.done,i&&localStorage.setItem(L,i)}async function Co(){const t=await Ps(),e=await Ns();if(await Vs(t,e),!e)return;const r=await Cs(e),a=(await E).transaction(["sync.staging.preferences","sync.staging.stores","syncs"],"readwrite");a.objectStore("sync.staging.stores").clear(),a.objectStore("sync.staging.preferences").clear(),a.objectStore("syncs").add(r),await a.done,localStorage.setItem(L,r.hash),ue.postMessage("sync-enabled"),await Ds([...t,r])}function zs(){return localStorage.getItem(L)!=null}async function $o(){const e=(await E).transaction(["sync.staging.preferences","sync.staging.stores","syncs"],"readwrite");e.objectStore("sync.staging.stores").clear(),e.objectStore("sync.staging.preferences").clear(),e.objectStore("syncs").clear(),await e.done,localStorage.removeItem(L),ue.postMessage("sync-disabled")}async function Ys(t){if(!zs())return;const r=(await E).transaction("sync.staging.stores","readwrite");for(const n of t)r.store.add(n);await r.done}var w=(t=>(t[t.New=0]="New",t[t.Learning=1]="Learning",t[t.Review=2]="Review",t[t.Relearning=3]="Relearning",t))(w||{}),p=(t=>(t[t.Manual=0]="Manual",t[t.Again=1]="Again",t[t.Hard=2]="Hard",t[t.Good=3]="Good",t[t.Easy=4]="Easy",t))(p||{});class S{static card(e){return{...e,state:S.state(e.state),due:S.time(e.due),last_review:e.last_review?S.time(e.last_review):void 0}}static rating(e){if(typeof e=="string"){const r=e.charAt(0).toUpperCase(),n=e.slice(1).toLowerCase(),a=p[`${r}${n}`];if(a===void 0)throw new Error(`Invalid rating:[${e}]`);return a}else if(typeof e=="number")return e;throw new Error(`Invalid rating:[${e}]`)}static state(e){if(typeof e=="string"){const r=e.charAt(0).toUpperCase(),n=e.slice(1).toLowerCase(),a=w[`${r}${n}`];if(a===void 0)throw new Error(`Invalid state:[${e}]`);return a}else if(typeof e=="number")return e;throw new Error(`Invalid state:[${e}]`)}static time(e){if(typeof e=="object"&&e instanceof Date)return e;if(typeof e=="string"){const r=Date.parse(e);if(Number.isNaN(r))throw new Error(`Invalid date:[${e}]`);return new Date(r)}else if(typeof e=="number")return new Date(e);throw new Error(`Invalid date:[${e}]`)}static review_log(e){return{...e,due:S.time(e.due),rating:S.rating(e.rating),state:S.state(e.state),review:S.time(e.review)}}}Date.prototype.scheduler=function(t,e){return B(this,t,e)};Date.prototype.diff=function(t,e){return z(this,t,e)};Date.prototype.format=function(){return Ws(this)};Date.prototype.dueFormat=function(t,e,r){return Qs(this,t,e,r)};function B(t,e,r){return new Date(r?S.time(t).getTime()+e*24*60*60*1e3:S.time(t).getTime()+e*60*1e3)}function z(t,e,r){if(!t||!e)throw new Error("Invalid date");const n=S.time(t).getTime()-S.time(e).getTime();let a=0;switch(r){case"days":a=Math.floor(n/(1440*60*1e3));break;case"minutes":a=Math.floor(n/(60*1e3));break}return a}function Ws(t){const e=S.time(t),r=e.getFullYear(),n=e.getMonth()+1,a=e.getDate(),i=e.getHours(),s=e.getMinutes(),o=e.getSeconds();return`${r}-${J(n)}-${J(a)} ${J(i)}:${J(s)}:${J(o)}`}function J(t){return t<10?`0${t}`:`${t}`}const Ht=[60,60,24,31,12],Vt=["second","min","hour","day","month","year"];function Qs(t,e,r,n=Vt){t=S.time(t),e=S.time(e),n.length!==Vt.length&&(n=Vt);let a=t.getTime()-e.getTime(),i=0;for(a/=1e3,i=0;i<Ht.length&&!(a<Ht[i]);i++)a/=Ht[i];return`${Math.floor(a)}${r?n[i]:""}`}const Zs=Object.freeze([p.Again,p.Hard,p.Good,p.Easy]),Js=[{start:2.5,end:7,factor:.15},{start:7,end:20,factor:.1},{start:20,end:1/0,factor:.05}];function Xs(t,e,r){let n=1;for(const s of Js)n+=s.factor*Math.max(Math.min(t,s.end)-s.start,0);t=Math.min(t,r);let a=Math.max(2,Math.round(t-n));const i=Math.min(Math.round(t+n),r);return t>e&&(a=Math.max(a,e+1)),a=Math.min(a,i),{min_ivl:a,max_ivl:i}}function x(t,e,r){return Math.min(Math.max(t,e),r)}function eo(t,e){const r=Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()),n=Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate());return Math.floor((n-r)/864e5)}const to=t=>{const e=t.slice(-1),r=parseInt(t.slice(0,-1),10);if(Number.isNaN(r)||!Number.isFinite(r)||r<0)throw new Error(`Invalid step value: ${t}`);switch(e){case"m":return r;case"h":return r*60;case"d":return r*1440;default:throw new Error(`Invalid step unit: ${t}, expected m/h/d`)}},ro=(t,e,r)=>{const n=e===w.Relearning||e===w.Review?t.relearning_steps:t.learning_steps,a=n.length;if(a===0||r>=a)return{};const i=n[0],s=to,o=()=>s(i),c=()=>{if(a===1)return Math.round(s(i)*1.5);const h=n[1];return Math.round((s(i)+s(h))/2)},u=h=>h<0||h>=a?null:n[h],f=h=>s(h),l={},d=u(Math.max(0,r));if(e===w.Review)return l[p.Again]={scheduled_minutes:s(d),next_step:0},l;{l[p.Again]={scheduled_minutes:o(),next_step:0},l[p.Hard]={scheduled_minutes:c(),next_step:r};const h=u(r+1);if(h){const y=f(h);y&&(l[p.Good]={scheduled_minutes:Math.round(y),next_step:r+1})}}return l};function no(){const t=this.review_time.getTime(),e=this.current.reps,r=this.current.difficulty*this.current.stability;return`${t}_${e}_${r}`}var ce=(t=>(t.SCHEDULER="Scheduler",t.LEARNING_STEPS="LearningSteps",t.SEED="Seed",t))(ce||{});class ni{last;current;review_time;next=new Map;algorithm;strategies;elapsed_days=0;constructor(e,r,n,a){this.algorithm=n,this.last=S.card(e),this.current=S.card(e),this.review_time=S.time(r),this.strategies=a,this.init()}checkGrade(e){if(!Number.isFinite(e)||e<0||e>4)throw new Error(`Invalid grade "${e}",expected 1-4`)}init(){const{state:e,last_review:r}=this.current;let n=0;e!==w.New&&r&&(n=eo(r,this.review_time)),this.current.last_review=this.review_time,this.elapsed_days=n,this.current.elapsed_days=n,this.current.reps+=1;let a=no;if(this.strategies){const i=this.strategies.get(ce.SEED);i&&(a=i)}this.algorithm.seed=a.call(this)}preview(){return{[p.Again]:this.review(p.Again),[p.Hard]:this.review(p.Hard),[p.Good]:this.review(p.Good),[p.Easy]:this.review(p.Easy),[Symbol.iterator]:this.previewIterator.bind(this)}}*previewIterator(){for(const e of Zs)yield this.review(e)}review(e){const{state:r}=this.last;let n;switch(this.checkGrade(e),r){case w.New:n=this.newState(e);break;case w.Learning:case w.Relearning:n=this.learningState(e);break;case w.Review:n=this.reviewState(e);break}return n}buildLog(e){const{last_review:r,due:n,elapsed_days:a}=this.last;return{rating:e,state:this.current.state,due:r||n,stability:this.current.stability,difficulty:this.current.difficulty,elapsed_days:this.elapsed_days,last_elapsed_days:a,scheduled_days:this.current.scheduled_days,learning_steps:this.current.learning_steps,review:this.review_time}}}class ao{c;s0;s1;s2;constructor(e){const r=io();this.c=1,this.s0=r(" "),this.s1=r(" "),this.s2=r(" "),e==null&&(e=Date.now()),this.s0-=r(e),this.s0<0&&(this.s0+=1),this.s1-=r(e),this.s1<0&&(this.s1+=1),this.s2-=r(e),this.s2<0&&(this.s2+=1)}next(){const e=2091639*this.s0+this.c*23283064365386963e-26;return this.s0=this.s1,this.s1=this.s2,this.c=e|0,this.s2=e-this.c,this.s2}set state(e){this.c=e.c,this.s0=e.s0,this.s1=e.s1,this.s2=e.s2}get state(){return{c:this.c,s0:this.s0,s1:this.s1,s2:this.s2}}}function io(){let t=4022871197;return function(r){r=String(r);for(let n=0;n<r.length;n++){t+=r.charCodeAt(n);let a=.02519603282416938*t;t=a>>>0,a-=t,a*=t,t=a>>>0,a-=t,t+=a*4294967296}return(t>>>0)*23283064365386963e-26}}function so(t){const e=new ao(t),r=()=>e.next();return r.int32=()=>e.next()*4294967296|0,r.double=()=>r()+(r()*2097152|0)*11102230246251565e-32,r.state=()=>e.state,r.importState=n=>(e.state=n,r),r}const oo=.9,uo=36500,co=!1,le=!0,lo=Object.freeze(["1m","10m"]),fo=Object.freeze(["10m"]),C=.001,ie=100,pa=.5,ho=.1542,ga=Object.freeze([.212,1.2931,2.3065,8.2956,6.4133,.8334,3.0194,.001,1.8722,.1666,.796,1.4835,.0614,.2629,1.6483,.6014,1.8729,.5425,.0912,.0658,ho]),yo=2,vo=(t,e=le)=>[[C,ie],[C,ie],[C,ie],[C,ie],[1,10],[.001,4],[.001,4],[.001,.75],[0,4.5],[0,.8],[.001,3.5],[.001,5],[.001,.25],[.001,.9],[0,4],[0,1],[1,6],[0,t],[0,t],[e?.01:0,.8],[.1,.8]],zt=(t,e,r=le)=>{let n=yo;if(Math.max(0,e)>1){const i=-(Math.log(t[11])+Math.log(Math.pow(2,t[13])-1)+t[14]*.3)/e;n=x(+i.toFixed(8),.01,2)}return vo(n,r).slice(0,t.length).map(([i,s],o)=>x(t[o]||0,i,s))},wr=(t,e=0,r=le)=>{if(t===void 0)return[...ga];switch(t.length){case 21:return zt(Array.from(t),e,r);case 19:return console.debug("[FSRS-6]auto fill w from 19 to 21 length"),zt(Array.from(t),e,r).concat([0,pa]);case 17:{const n=zt(Array.from(t),e,r);return n[4]=+(n[5]*2+n[4]).toFixed(8),n[5]=+(Math.log(n[5]*3+1)/3).toFixed(8),n[6]=+(n[6]+.5).toFixed(8),console.debug("[FSRS-6]auto fill w from 17 to 21 length"),n.concat([0,0,0,pa])}default:return console.warn("[FSRS]Invalid parameters length, using default parameters"),[...ga]}},ma=t=>{const e=Array.isArray(t?.learning_steps)?t.learning_steps:lo,r=Array.isArray(t?.relearning_steps)?t.relearning_steps:fo,n=t?.enable_short_term??le,a=wr(t?.w,r.length,n);return{request_retention:t?.request_retention||oo,maximum_interval:t?.maximum_interval||uo,w:a,enable_fuzz:t?.enable_fuzz??co,enable_short_term:n,learning_steps:e,relearning_steps:r}};function er(t,e){return{due:t?S.time(t):new Date,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:0,lapses:0,learning_steps:0,state:w.New,last_review:void 0}}const ai=t=>{const e=typeof t=="number"?-t:-t[20],r=Math.exp(Math.pow(e,-1)*Math.log(.9))-1;return{decay:e,factor:+r.toFixed(8)}};function tr(t,e,r){const{decay:n,factor:a}=ai(t);return+Math.pow(1+a*e/r,n).toFixed(8)}class po{param;intervalModifier;_seed;constructor(e){this.param=new Proxy(ma(e),this.params_handler_proxy()),this.intervalModifier=this.calculate_interval_modifier(this.param.request_retention),this.forgetting_curve=tr.bind(this,this.param.w)}get interval_modifier(){return this.intervalModifier}set seed(e){this._seed=e}calculate_interval_modifier(e){if(e<=0||e>1)throw new Error("Requested retention rate should be in the range (0,1]");const{decay:r,factor:n}=ai(this.param.w);return+((Math.pow(e,1/r)-1)/n).toFixed(8)}get parameters(){return this.param}set parameters(e){this.update_parameters(e)}params_handler_proxy(){const e=this;return{set:function(r,n,a){return n==="request_retention"&&Number.isFinite(a)?e.intervalModifier=e.calculate_interval_modifier(Number(a)):n==="w"&&(a=wr(a,r.relearning_steps.length,r.enable_short_term),e.forgetting_curve=tr.bind(this,a),e.intervalModifier=e.calculate_interval_modifier(Number(r.request_retention))),Reflect.set(r,n,a),!0}}}update_parameters(e){const r=ma(e);for(const n in r){const a=n;this.param[a]=r[a]}}init_stability(e){return Math.max(this.param.w[e-1],.1)}init_difficulty(e){return+(this.param.w[4]-Math.exp((e-1)*this.param.w[5])+1).toFixed(8)}apply_fuzz(e,r){if(!this.param.enable_fuzz||e<2.5)return Math.round(e);const a=so(this._seed)(),{min_ivl:i,max_ivl:s}=Xs(e,r,this.param.maximum_interval);return Math.floor(a*(s-i+1)+i)}next_interval(e,r){const n=Math.min(Math.max(1,Math.round(e*this.intervalModifier)),this.param.maximum_interval);return this.apply_fuzz(n,r)}linear_damping(e,r){return+(e*(10-r)/9).toFixed(8)}next_difficulty(e,r){const n=-this.param.w[6]*(r-3),a=e+this.linear_damping(n,e);return x(this.mean_reversion(this.init_difficulty(p.Easy),a),1,10)}mean_reversion(e,r){return+(this.param.w[7]*e+(1-this.param.w[7])*r).toFixed(8)}next_recall_stability(e,r,n,a){const i=p.Hard===a?this.param.w[15]:1,s=p.Easy===a?this.param.w[16]:1;return+x(r*(1+Math.exp(this.param.w[8])*(11-e)*Math.pow(r,-this.param.w[9])*(Math.exp((1-n)*this.param.w[10])-1)*i*s),C,36500).toFixed(8)}next_forget_stability(e,r,n){return+x(this.param.w[11]*Math.pow(e,-this.param.w[12])*(Math.pow(r+1,this.param.w[13])-1)*Math.exp((1-n)*this.param.w[14]),C,36500).toFixed(8)}next_short_term_stability(e,r){const n=Math.pow(e,-this.param.w[19])*Math.exp(this.param.w[17]*(r-3+this.param.w[18])),a=r>=3?Math.max(n,1):n;return+x(e*a,C,36500).toFixed(8)}forgetting_curve;next_state(e,r,n){const{difficulty:a,stability:i}=e??{difficulty:0,stability:0};if(r<0)throw new Error(`Invalid delta_t "${r}"`);if(n<0||n>4)throw new Error(`Invalid grade "${n}"`);if(a===0&&i===0)return{difficulty:x(this.init_difficulty(n),1,10),stability:this.init_stability(n)};if(n===0)return{difficulty:a,stability:i};if(a<1||i<C)throw new Error(`Invalid memory state { difficulty: ${a}, stability: ${i} }`);const s=this.forgetting_curve(r,i),o=this.next_recall_stability(a,i,s,n),c=this.next_forget_stability(a,i,s),u=this.next_short_term_stability(i,n);let f=o;if(n===1){let[d,h]=[0,0];this.param.enable_short_term&&(d=this.param.w[17],h=this.param.w[18]);const y=i/Math.exp(d*h);f=x(+y.toFixed(8),C,c)}return r===0&&this.param.enable_short_term&&(f=u),{difficulty:this.next_difficulty(a,n),stability:f}}}class wa extends ni{learningStepsStrategy;constructor(e,r,n,a){super(e,r,n,a);let i=ro;if(this.strategies){const s=this.strategies.get(ce.LEARNING_STEPS);s&&(i=s)}this.learningStepsStrategy=i}getLearningInfo(e,r){const n=this.algorithm.parameters;e.learning_steps=e.learning_steps||0;const a=this.learningStepsStrategy(n,e.state,this.current.state===w.Learning&&r!==p.Again&&r!==p.Hard?e.learning_steps+1:e.learning_steps),i=Math.max(0,a[r]?.scheduled_minutes??0),s=Math.max(0,a[r]?.next_step??0);return{scheduled_minutes:i,next_steps:s}}applyLearningSteps(e,r,n){const{scheduled_minutes:a,next_steps:i}=this.getLearningInfo(this.current,r);if(a>0&&a<1440)e.learning_steps=i,e.scheduled_days=0,e.state=n,e.due=B(this.review_time,Math.round(a),!1);else if(e.state=w.Review,a>=1440)e.learning_steps=i,e.due=B(this.review_time,Math.round(a),!1),e.scheduled_days=Math.floor(a/1440);else{e.learning_steps=0;const s=this.algorithm.next_interval(e.stability,this.elapsed_days);e.scheduled_days=s,e.due=B(this.review_time,s,!0)}}newState(e){const r=this.next.get(e);if(r)return r;const n=S.card(this.current);n.difficulty=x(this.algorithm.init_difficulty(e),1,10),n.stability=this.algorithm.init_stability(e),this.applyLearningSteps(n,e,w.Learning);const a={card:n,log:this.buildLog(e)};return this.next.set(e,a),a}learningState(e){const r=this.next.get(e);if(r)return r;const{state:n,difficulty:a,stability:i}=this.last,s=S.card(this.current);s.difficulty=this.algorithm.next_difficulty(a,e),s.stability=this.algorithm.next_short_term_stability(i,e),this.applyLearningSteps(s,e,n);const o={card:s,log:this.buildLog(e)};return this.next.set(e,o),o}reviewState(e){const r=this.next.get(e);if(r)return r;const n=this.elapsed_days,{difficulty:a,stability:i}=this.last,s=this.algorithm.forgetting_curve(n,i),o=S.card(this.current),c=S.card(this.current),u=S.card(this.current),f=S.card(this.current);this.next_ds(o,c,u,f,a,i,s),this.next_interval(c,u,f,n),this.next_state(c,u,f),this.applyLearningSteps(o,p.Again,w.Relearning),o.lapses+=1;const l={card:o,log:this.buildLog(p.Again)},d={card:c,log:super.buildLog(p.Hard)},h={card:u,log:super.buildLog(p.Good)},y={card:f,log:super.buildLog(p.Easy)};return this.next.set(p.Again,l),this.next.set(p.Hard,d),this.next.set(p.Good,h),this.next.set(p.Easy,y),this.next.get(e)}next_ds(e,r,n,a,i,s,o){e.difficulty=this.algorithm.next_difficulty(i,p.Again);const c=s/Math.exp(this.algorithm.parameters.w[17]*this.algorithm.parameters.w[18]),u=this.algorithm.next_forget_stability(i,s,o);e.stability=x(+c.toFixed(8),C,u),r.difficulty=this.algorithm.next_difficulty(i,p.Hard),r.stability=this.algorithm.next_recall_stability(i,s,o,p.Hard),n.difficulty=this.algorithm.next_difficulty(i,p.Good),n.stability=this.algorithm.next_recall_stability(i,s,o,p.Good),a.difficulty=this.algorithm.next_difficulty(i,p.Easy),a.stability=this.algorithm.next_recall_stability(i,s,o,p.Easy)}next_interval(e,r,n,a){let i,s;i=this.algorithm.next_interval(e.stability,a),s=this.algorithm.next_interval(r.stability,a),i=Math.min(i,s),s=Math.max(s,i+1);const o=Math.max(this.algorithm.next_interval(n.stability,a),s+1);e.scheduled_days=i,e.due=B(this.review_time,i,!0),r.scheduled_days=s,r.due=B(this.review_time,s,!0),n.scheduled_days=o,n.due=B(this.review_time,o,!0)}next_state(e,r,n){e.state=w.Review,e.learning_steps=0,r.state=w.Review,r.learning_steps=0,n.state=w.Review,n.learning_steps=0}}class ba extends ni{newState(e){const r=this.next.get(e);if(r)return r;this.current.scheduled_days=0,this.current.elapsed_days=0;const n=S.card(this.current),a=S.card(this.current),i=S.card(this.current),s=S.card(this.current);return this.init_ds(n,a,i,s),this.next_interval(n,a,i,s,0),this.next_state(n,a,i,s),this.update_next(n,a,i,s),this.next.get(e)}init_ds(e,r,n,a){e.difficulty=x(this.algorithm.init_difficulty(p.Again),1,10),e.stability=this.algorithm.init_stability(p.Again),r.difficulty=x(this.algorithm.init_difficulty(p.Hard),1,10),r.stability=this.algorithm.init_stability(p.Hard),n.difficulty=x(this.algorithm.init_difficulty(p.Good),1,10),n.stability=this.algorithm.init_stability(p.Good),a.difficulty=x(this.algorithm.init_difficulty(p.Easy),1,10),a.stability=this.algorithm.init_stability(p.Easy)}learningState(e){return this.reviewState(e)}reviewState(e){const r=this.next.get(e);if(r)return r;const n=this.elapsed_days,{difficulty:a,stability:i}=this.last,s=this.algorithm.forgetting_curve(n,i),o=S.card(this.current),c=S.card(this.current),u=S.card(this.current),f=S.card(this.current);return this.next_ds(o,c,u,f,a,i,s),this.next_interval(o,c,u,f,n),this.next_state(o,c,u,f),o.lapses+=1,this.update_next(o,c,u,f),this.next.get(e)}next_ds(e,r,n,a,i,s,o){e.difficulty=this.algorithm.next_difficulty(i,p.Again);const c=this.algorithm.next_forget_stability(i,s,o);e.stability=x(s,C,c),r.difficulty=this.algorithm.next_difficulty(i,p.Hard),r.stability=this.algorithm.next_recall_stability(i,s,o,p.Hard),n.difficulty=this.algorithm.next_difficulty(i,p.Good),n.stability=this.algorithm.next_recall_stability(i,s,o,p.Good),a.difficulty=this.algorithm.next_difficulty(i,p.Easy),a.stability=this.algorithm.next_recall_stability(i,s,o,p.Easy)}next_interval(e,r,n,a,i){let s,o,c,u;s=this.algorithm.next_interval(e.stability,i),o=this.algorithm.next_interval(r.stability,i),c=this.algorithm.next_interval(n.stability,i),u=this.algorithm.next_interval(a.stability,i),s=Math.min(s,o),o=Math.max(o,s+1),c=Math.max(c,o+1),u=Math.max(u,c+1),e.scheduled_days=s,e.due=B(this.review_time,s,!0),r.scheduled_days=o,r.due=B(this.review_time,o,!0),n.scheduled_days=c,n.due=B(this.review_time,c,!0),a.scheduled_days=u,a.due=B(this.review_time,u,!0)}next_state(e,r,n,a){e.state=w.Review,e.learning_steps=0,r.state=w.Review,r.learning_steps=0,n.state=w.Review,n.learning_steps=0,a.state=w.Review,a.learning_steps=0}update_next(e,r,n,a){const i={card:e,log:this.buildLog(p.Again)},s={card:r,log:super.buildLog(p.Hard)},o={card:n,log:super.buildLog(p.Good)},c={card:a,log:super.buildLog(p.Easy)};this.next.set(p.Again,i),this.next.set(p.Hard,s),this.next.set(p.Good,o),this.next.set(p.Easy,c)}}class go{fsrs;constructor(e){this.fsrs=e}replay(e,r,n){return this.fsrs.next(e,r,n)}handleManualRating(e,r,n,a,i,s,o){if(typeof r>"u")throw new Error("reschedule: state is required for manual rating");let c,u;if(r===w.New)c={rating:p.Manual,state:r,due:o??n,stability:e.stability,difficulty:e.difficulty,elapsed_days:a,last_elapsed_days:e.elapsed_days,scheduled_days:e.scheduled_days,learning_steps:e.learning_steps,review:n},u=er(n),u.last_review=n;else{if(typeof o>"u")throw new Error("reschedule: due is required for manual rating");const f=z(o,n,"days");c={rating:p.Manual,state:e.state,due:e.last_review||e.due,stability:e.stability,difficulty:e.difficulty,elapsed_days:a,last_elapsed_days:e.elapsed_days,scheduled_days:e.scheduled_days,learning_steps:e.learning_steps,review:n},u={...e,state:r,due:o,last_review:n,stability:i||e.stability,difficulty:s||e.difficulty,elapsed_days:a,scheduled_days:f,reps:e.reps+1}}return{card:u,log:c}}reschedule(e,r){const n=[];let a=er(e.due);for(const i of r){let s;if(i.review=S.time(i.review),i.rating===p.Manual){let o=0;a.state!==w.New&&a.last_review&&(o=z(i.review,a.last_review,"days")),s=this.handleManualRating(a,i.state,i.review,o,i.stability,i.difficulty,i.due?S.time(i.due):void 0)}else s=this.replay(a,i.review,i.rating);n.push(s),a=s.card}return n}calculateManualRecord(e,r,n,a){if(!n)return null;const{card:i,log:s}=n,o=S.card(e);return o.due.getTime()===i.due.getTime()?null:(o.scheduled_days=z(i.due,o.due,"days"),this.handleManualRating(o,i.state,S.time(r),s.elapsed_days,a?i.stability:void 0,a?i.difficulty:void 0,i.due))}}class mo extends po{strategyHandler=new Map;Scheduler;constructor(e){super(e);const{enable_short_term:r}=this.parameters;this.Scheduler=r?wa:ba}params_handler_proxy(){const e=this;return{set:function(r,n,a){return n==="request_retention"&&Number.isFinite(a)?e.intervalModifier=e.calculate_interval_modifier(Number(a)):n==="enable_short_term"?e.Scheduler=a===!0?wa:ba:n==="w"&&(a=wr(a,r.relearning_steps.length,r.enable_short_term),e.forgetting_curve=tr.bind(this,a),e.intervalModifier=e.calculate_interval_modifier(Number(r.request_retention))),Reflect.set(r,n,a),!0}}}useStrategy(e,r){return this.strategyHandler.set(e,r),this}clearStrategy(e){return e?this.strategyHandler.delete(e):this.strategyHandler.clear(),this}getScheduler(e,r){const a=this.strategyHandler.get(ce.SCHEDULER)||this.Scheduler;return new a(e,r,this,this.strategyHandler)}repeat(e,r,n){const i=this.getScheduler(e,r).preview();return n&&typeof n=="function"?n(i):i}next(e,r,n,a){const i=this.getScheduler(e,r),s=S.rating(n);if(s===p.Manual)throw new Error("Cannot review a manual rating");const o=i.review(s);return a&&typeof a=="function"?a(o):o}get_retrievability(e,r,n=!0){const a=S.card(e);r=r?S.time(r):new Date;const i=a.state!==w.New?Math.max(z(r,a.last_review,"days"),0):0,s=a.state!==w.New?this.forgetting_curve(i,+a.stability.toFixed(8)):0;return n?`${(s*100).toFixed(2)}%`:s}rollback(e,r,n){const a=S.card(e),i=S.review_log(r);if(i.rating===p.Manual)throw new Error("Cannot rollback a manual rating");let s,o,c;switch(i.state){case w.New:s=i.due,o=void 0,c=0;break;case w.Learning:case w.Relearning:case w.Review:s=i.review,o=i.due,c=a.lapses-(i.rating===p.Again&&i.state===w.Review?1:0);break}const u={...a,due:s,stability:i.stability,difficulty:i.difficulty,elapsed_days:i.last_elapsed_days,scheduled_days:i.scheduled_days,reps:Math.max(0,a.reps-1),lapses:Math.max(0,c),learning_steps:i.learning_steps,state:i.state,last_review:o};return n&&typeof n=="function"?n(u):u}forget(e,r,n=!1,a){const i=S.card(e);r=S.time(r);const s=i.state===w.New?0:z(r,i.due,"days"),o={rating:p.Manual,state:i.state,due:i.due,stability:i.stability,difficulty:i.difficulty,elapsed_days:0,last_elapsed_days:i.elapsed_days,scheduled_days:s,learning_steps:i.learning_steps,review:r},u={card:{...i,due:r,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:n?0:i.reps,lapses:n?0:i.lapses,learning_steps:0,state:w.New,last_review:i.last_review},log:o};return a&&typeof a=="function"?a(u):u}reschedule(e,r=[],n={}){const{recordLogHandler:a,reviewsOrderBy:i,skipManual:s=!0,now:o=new Date,update_memory_state:c=!1}=n;i&&typeof i=="function"&&r.sort(i),s&&(r=r.filter(y=>y.rating!==p.Manual));const u=new go(this),f=u.reschedule(n.first_card||er(),r),l=f.length,d=S.card(e),h=u.calculateManualRecord(d,o,l?f[l-1]:void 0,c);return a&&typeof a=="function"?{collections:f.map(a),reschedule_item:h?a(h):null}:{collections:f,reschedule_item:h}}}const No=t=>new mo(t||{}),rr=1e3,se=60*rr,re=60*se,Y=24*re,Yt=7*Y,Wt=29.53*Y,Qt=365.2425*Y,nr=new Date(0);function ne(t=new Date){return new Date(t.getFullYear(),t.getMonth(),t.getDate())}function wo(t){const e=Math.abs(t);return e<1.5*se?{unit:"second",multiplier:rr,value:t/rr}:e<1.5*re?{unit:"minute",multiplier:se,value:t/se}:e<1.5*Y?{unit:"hour",multiplier:re,value:t/re}:e<Yt?{unit:"day",multiplier:Y,value:t/Y}:e<Wt?{unit:"week",multiplier:Yt,value:t/Yt}:e<Qt?{unit:"month",multiplier:Wt,value:t/Wt}:{unit:"year",multiplier:Qt,value:t/Qt}}const bo=new Intl.RelativeTimeFormat("default",{numeric:"always",style:"short"});function Fo(t){const{unit:e,value:r}=wo(t);return bo.format(Math.round(r),e)}function Lo(t){return new Promise(e=>{globalThis.setTimeout(e,t)})}async function*_o(t){const e=new Set;let r=await(await E).transaction("progress").store.index("state+due").openCursor();for(;r;){const[n,a]=r.key;if(n<w.Learning){r=await r.continue([w.Learning,nr]);continue}if(n>w.Learning&&n<w.Relearning){r=await r.continue([w.Relearning,nr]);continue}{const[i]=r.primaryKey;e.has(i)||(yield r,e.add(i))}r=await r.continue()}}async function ii(){const t=new Set,e=(await E).transaction("reviews").store.index("review").iterate(IDBKeyRange.lowerBound(ne()));for await(const r of e)t.add(r.value.cardId);return t}async function So(){const t=new Date;return(await E).transaction("reviews").store.index("state+review").count(IDBKeyRange.bound([w.New,ne()],[w.New,t],!0,!0))}async function*Ao(){const t=await ii(),e=(await E).transaction(["decks","progress"]),r=e.objectStore("progress"),n=new Set;let a=null,i=null,s=null;for await(const c of r.index("cardId+cardType+state")){const[u,f,l]=c.key;if(!(t.has(u)||n.has(u)))if(a===u&&s!==null&&i!==null){if(s!==w.New&&l===w.New)yield c.value,n.add(u);else if(s===0&&l!==w.New){const d=await r.get([a,i]);d&&(yield d,n.add(a))}}else a=u,i=f,s=l}const o=e.objectStore("decks").index("priority");for await(const{value:c}of o)if(c.active){for(const u of c.cards)if(!(n.has(u)||t.has(u)))for(const f of c.cardTypes){const l=await r.get([u,f]);if(l?.fsrs.state===w.New){yield l;break}}}}async function Io(){const t=new Date;return(await E).transaction("reviews").store.index("state+review").count(IDBKeyRange.bound([w.Review,ne()],[w.Review,t],!1,!0))}async function*Oo(){const t=new Date,e=await ii(),r=(await E).transaction(["decks","progress","reviews"],"readonly"),a=r.objectStore("decks").index("cards"),i=r.objectStore("progress"),s=IDBKeyRange.bound([w.Review,nr],[w.Review,t],!1,!0),o=new Set;let c=await i.index("state+due").openCursor(s);for(;c;){const[u]=c.primaryKey;!o.has(u)&&!e.has(u)&&await a.getKey(IDBKeyRange.only(u))&&(yield c),c=await c.continue()}}async function Eo(){const t=await(await E).getAllFromIndex("review-limits","time",IDBKeyRange.lowerBound(ne())),e={due:0,new:0};for(const{count:r}of t)e.due+=r.due,e.new+=r.new;return e}async function Ro({cardId:t,cardType:e},r){const n=(await E).transaction(["progress","reviews"],"readwrite"),a=n.objectStore("progress"),i=n.objectStore("reviews");await a.put({cardId:t,cardType:e,fsrs:r.card});const s=await i.add({cardId:t,cardType:e,log:r.log});Ys([{store:"progress",op:"put",key:[t,e]},{store:"reviews",op:"add",key:s}]),await n.done}const ae="shodoku.app.preferences",ar=D(`${ae}.limit.due`,50),ir=D(`${ae}.limit.new`,10),Uo=D(`${ae}.fsrs.fuzz-enabled`,!0),ko=D(`${ae}.known.min-due-weeks`,8),Ko=D(`${ae}.known.min-retention`,90);async function Go(t={new:ir.value,due:ar.value}){return await(await E).add("review-limits",{time:new Date,count:t}),ue.postMessage("review-limit-increased")}const To=si("reviews",()=>{const t=V(!1),e=V([]),r=V([]),n=V([]),a=V(0),i=V(0),s=_a(()=>{const l=new Date;let d=0,h=0,y=0,_=e.value.at(d);const v=[];for(;_&&_.fsrs.due<l;)v.push(_),d+=1,_=e.value.at(d);const b=r.value.length,g=n.value.length,m=b+a.value,A=g+i.value,I=Math.ceil((A+m)/A),O=Math.floor(I/2);let q=r.value.at(h),R=n.value.at(y);for(;q||R;){if(!R){q&&v.push(q),h+=1,q=r.value.at(h);continue}if(!q){R&&v.push(R),y+=1,R=n.value.at(y);continue}(a.value+h+i.value+y)%I===O?(v.push(R),y+=1,R=n.value.at(y)):(v.push(q),h+=1,q=r.value.at(h))}for(;_;)v.push(_),d+=1,_=e.value.at(d);return v});async function o({cardId:l,cardType:d,fsrs:h},y){if(h.state===w.New?(n.value=n.value.filter(_=>_.cardId!==l),i.value+=1):h.state===w.Review?(r.value=r.value.filter(_=>_.cardId!==l),a.value+=1):e.value=e.value.filter(_=>_.cardId!==l),y.card.state===w.Learning||y.card.state===w.Relearning){const _={cardId:l,cardType:d,fsrs:y.card},{due:v}=y.card,b=e.value.findIndex(g=>v<g.fsrs.due);e.value=e.value.toSpliced(b===-1?e.value.length:b,0,_)}await Ro({cardId:l,cardType:d},y),ue.postMessage("card-review")}function c(l){return e.value.some(d=>d.cardId===l)}function u(l){return r.value.some(d=>d.cardId===l)}async function f(){t.value=!0;try{const l=await Eo();a.value=await Io(),i.value=await So(),e.value=await X(_o(),Zt(d=>d.value),de()),r.value=await X(Oo(),_r(({primaryKey:[d]})=>!c(d)),Sr(Math.max(0,ar.value+l.due-a.value)),Zt(d=>d.value),de()),n.value=await X(Ao(),_r(({cardId:d})=>!c(d)&&!u(d)),Sr(Math.max(0,ir.value+l.new-i.value)),de())}finally{t.value=!1}}return f(),setTimeout(f,re),oi([ar,ir],f),{refreshing:t,learningQueue:e,dueQueue:r,newQueue:n,queue:s,refreshQueues:f,rateCard:o}});function Ho(){const t=To();return _a(()=>({due:t.dueQueue.length,new:t.newQueue.length,learning:t.learningQueue.length}))}function Vo(){const{result:t}=sr(async()=>{const e=new Map,r=(await E).transaction("reviews").store.index("review");for await(const n of r.iterate(IDBKeyRange.lowerBound(ne()))){const a=n.value;let i=e.get(a.cardId);i||(i=[],e.set(a.cardId,i)),i.push(a)}return e});return t}export{Ai as A,Si as B,Ii as C,Mo as D,$o as E,mo as F,Po as G,Co as H,Ts as P,p as R,w as S,Yt as W,Vo as a,Fo as b,To as c,Bo as d,ko as e,_r as f,Ys as g,ma as h,Go as i,er as j,Ko as k,jo as l,Zt as m,ir as n,Do as o,X as p,As as q,Uo as r,Lo as s,No as t,Ho as u,ar as v,Ei as w,Oi as x,Ri as y,Ra as z};
//# sourceMappingURL=reviews-BjQG9Nhh.js.map
