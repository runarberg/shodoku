import{u as ve,y as j,G as ge,a2 as W,m as N,a3 as se,X as ye,a4 as he,V as Se,a5 as be,a6 as Ie,a1 as ce,a7 as le,p as Ce,c as Z,D as De}from"./index-iqwy-qSw.js";import{c as y,p as z,m as V}from"./index-BOsLoRk8.js";import{d as x,u as Ne,l as fe}from"./db-B7IDTSNy.js";function k(){return async function(e){const t=[];for await(const n of e)t.push(n);return t}}function ne(e){return async function*(t){for await(const n of t)e(n)&&(yield n)}}function re(e){if(e<0){const t=-e;return async function*(n){const r=[];let a=0;for await(const i of n)r[a]=i,a=(a+1)%t;for(let i=0;i<r.length;i+=1)yield r[a],a=(a+1)%t}}return async function*(t){let n=0;for await(const r of t){if(n>=e)break;n+=1,yield r}}}function ae(e){return async function*(t){const n=new Set;for await(const r of t){const a=e(r);n.has(a)||(yield r,n.add(a))}}}function Te(e){return he()?(Se(e),!0):!1}function T(e){return typeof e=="function"?e():ve(e)}const nt={mounted:"mounted"},de=typeof window<"u"&&typeof document<"u";typeof WorkerGlobalScope<"u"&&globalThis instanceof WorkerGlobalScope;const rt=e=>e!=null,xe=Object.prototype.toString,Re=e=>xe.call(e)==="[object Object]",P=()=>{},at=Ae();function Ae(){var e,t;return de&&((e=window==null?void 0:window.navigator)==null?void 0:e.userAgent)&&(/iP(?:ad|hone|od)/.test(window.navigator.userAgent)||((t=window==null?void 0:window.navigator)==null?void 0:t.maxTouchPoints)>2&&/iPad|Macintosh/.test(window==null?void 0:window.navigator.userAgent))}function Oe(e,t){function n(...r){return new Promise((a,i)=>{Promise.resolve(e(()=>t.apply(this,r),{fn:t,thisArg:this,args:r})).then(a).catch(i)})}return n}const we=e=>e();function Ee(e,t={}){let n,r,a=P;const i=m=>{clearTimeout(m),a(),a=P};return m=>{const g=T(e),p=T(t.maxWait);return n&&i(n),g<=0||p!==void 0&&p<=0?(r&&(i(r),r=null),Promise.resolve(m())):new Promise((d,o)=>{a=t.rejectOnCancel?o:d,p&&!r&&(r=setTimeout(()=>{n&&i(n),r=null,d(m())},p)),n=setTimeout(()=>{r&&i(r),r=null,d(m())},g)})}}function Fe(e=we){const t=N(!0);function n(){t.value=!1}function r(){t.value=!0}const a=(...i)=>{t.value&&e(...i)};return{isActive:se(t),pause:n,resume:r,eventFilter:a}}function ie(e,t=!1,n="Timeout"){return new Promise((r,a)=>{setTimeout(t?()=>a(n):r,e)})}function Me(e){return ye()}function it(...e){if(e.length!==1)return be(...e);const t=e[0];return typeof t=="function"?se(Ie(()=>({get:t,set:P}))):N(t)}function pe(e,t,n={}){const{eventFilter:r=we,...a}=n;return j(e,Oe(r,t),a)}function je(e,t,n={}){const{eventFilter:r,...a}=n,{eventFilter:i,pause:v,resume:m,isActive:g}=Fe(r);return{stop:pe(e,t,{...a,eventFilter:i}),pause:v,resume:m,isActive:g}}function Pe(e,t=!0,n){Me()?ge(e,n):t?e():W(e)}function U(e,t=!1){function n(o,{flush:u="sync",deep:s=!1,timeout:l,throwOnTimeout:c}={}){let w=null;const b=[new Promise(A=>{w=j(e,I=>{o(I)!==t&&(w?w():W(()=>w==null?void 0:w()),A(I))},{flush:u,deep:s,immediate:!0})})];return l!=null&&b.push(ie(l,c).then(()=>T(e)).finally(()=>w==null?void 0:w())),Promise.race(b)}function r(o,u){if(!ce(o))return n(I=>I===o,u);const{flush:s="sync",deep:l=!1,timeout:c,throwOnTimeout:w}=u??{};let h=null;const A=[new Promise(I=>{h=j([e,o],([O,F])=>{t!==(O===F)&&(h?h():W(()=>h==null?void 0:h()),I(O))},{flush:s,deep:l,immediate:!0})})];return c!=null&&A.push(ie(c,w).then(()=>T(e)).finally(()=>(h==null||h(),T(e)))),Promise.race(A)}function a(o){return n(u=>!!u,o)}function i(o){return r(null,o)}function v(o){return r(void 0,o)}function m(o){return n(Number.isNaN,o)}function g(o,u){return n(s=>{const l=Array.from(s);return l.includes(o)||l.includes(T(o))},u)}function p(o){return d(1,o)}function d(o=1,u){let s=-1;return n(()=>(s+=1,s>=o),u)}return Array.isArray(T(e))?{toMatch:n,toContains:g,changed:p,changedTimes:d,get not(){return U(e,!t)}}:{toMatch:n,toBe:r,toBeTruthy:a,toBeNull:i,toBeNaN:m,toBeUndefined:v,changed:p,changedTimes:d,get not(){return U(e,!t)}}}function ot(e){return U(e)}function ut(e,t,n={}){const{debounce:r=0,maxWait:a=void 0,...i}=n;return pe(e,t,{...i,eventFilter:Ee(r,{maxWait:a})})}function st(e,t,n){let r;ce(n)?r={evaluating:n}:r={};const{lazy:a=!1,evaluating:i=void 0,shallow:v=!0,onError:m=P}=r,g=N(!a),p=v?le(t):N(t);let d=0;return Ce(async o=>{if(!g.value)return;d++;const u=d;let s=!1;i&&Promise.resolve().then(()=>{i.value=!0});try{const l=await e(c=>{o(()=>{i&&(i.value=!1),s||c()})});u===d&&(p.value=l)}catch(l){m(l)}finally{i&&u===d&&(i.value=!1),s=!0}}),a?Z(()=>(g.value=!0,p.value)):p}const Q=de?window:void 0;function Be(e){var t;const n=T(e);return(t=n==null?void 0:n.$el)!=null?t:n}function oe(...e){let t,n,r,a;if(typeof e[0]=="string"||Array.isArray(e[0])?([n,r,a]=e,t=Q):[t,n,r,a]=e,!t)return P;Array.isArray(n)||(n=[n]),Array.isArray(r)||(r=[r]);const i=[],v=()=>{i.forEach(d=>d()),i.length=0},m=(d,o,u,s)=>(d.addEventListener(o,u,s),()=>d.removeEventListener(o,u,s)),g=j(()=>[Be(t),T(a)],([d,o])=>{if(v(),!d)return;const u=Re(o)?{...o}:o;i.push(...n.flatMap(s=>r.map(l=>m(d,s,l,u))))},{immediate:!0,flush:"post"}),p=()=>{g(),v()};return Te(p),p}const K=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},L="__vueuse_ssr_handlers__",Ke=Le();function Le(){return L in K||(K[L]=K[L]||{}),K[L]}function _e(e,t){return Ke[e]||t}function We(e){return e==null?"any":e instanceof Set?"set":e instanceof Map?"map":e instanceof Date?"date":typeof e=="boolean"?"boolean":typeof e=="string"?"string":typeof e=="object"?"object":Number.isNaN(e)?"any":"number"}const Qe={boolean:{read:e=>e==="true",write:e=>String(e)},object:{read:e=>JSON.parse(e),write:e=>JSON.stringify(e)},number:{read:e=>Number.parseFloat(e),write:e=>String(e)},any:{read:e=>e,write:e=>String(e)},string:{read:e=>e,write:e=>String(e)},map:{read:e=>new Map(JSON.parse(e)),write:e=>JSON.stringify(Array.from(e.entries()))},set:{read:e=>new Set(JSON.parse(e)),write:e=>JSON.stringify(Array.from(e))},date:{read:e=>new Date(e),write:e=>e.toISOString()}},ue="vueuse-storage";function ze(e,t,n,r={}){var a;const{flush:i="pre",deep:v=!0,listenToStorageChanges:m=!0,writeDefaults:g=!0,mergeDefaults:p=!1,shallow:d,window:o=Q,eventFilter:u,onError:s=f=>{console.error(f)},initOnMounted:l}=r,c=(d?le:N)(typeof t=="function"?t():t);if(!n)try{n=_e("getDefaultStorage",()=>{var f;return(f=Q)==null?void 0:f.localStorage})()}catch(f){s(f)}if(!n)return c;const w=T(t),h=We(w),b=(a=r.serializer)!=null?a:Qe[h],{pause:A,resume:I}=je(c,()=>F(c.value),{flush:i,deep:v,eventFilter:u});o&&m&&Pe(()=>{n instanceof Storage?oe(o,"storage",C):oe(o,ue,te),l&&C()}),l||C();function O(f,S){if(o){const D={key:e,oldValue:f,newValue:S,storageArea:n};o.dispatchEvent(n instanceof Storage?new StorageEvent("storage",D):new CustomEvent(ue,{detail:D}))}}function F(f){try{const S=n.getItem(e);if(f==null)O(S,null),n.removeItem(e);else{const D=b.write(f);S!==D&&(n.setItem(e,D),O(S,D))}}catch(S){s(S)}}function R(f){const S=f?f.newValue:n.getItem(e);if(S==null)return g&&w!=null&&n.setItem(e,b.write(w)),w;if(!f&&p){const D=b.read(S);return typeof p=="function"?p(D,w):h==="object"&&!Array.isArray(D)?{...w,...D}:D}else return typeof S!="string"?S:b.read(S)}function C(f){if(!(f&&f.storageArea!==n)){if(f&&f.key==null){c.value=w;return}if(!(f&&f.key!==e)){A();try{(f==null?void 0:f.newValue)!==b.write(c.value)&&(c.value=R(f))}catch(S){s(S)}finally{f?W(I):I()}}}}function te(f){C(f.detail)}return c}function ee(e,t,n={}){const{window:r=Q}=n;return ze(e,t,r==null?void 0:r.localStorage,n)}const q=1e3,_=60*q,M=60*_,E=24*M,J=7*E,Y=29.53*E,H=365.2425*E,G=new Date(0);function B(e=new Date){return new Date(e.getFullYear(),e.getMonth(),e.getDate())}function Ve(e){const t=Math.abs(e);return t<1.5*_?{unit:"second",multiplier:q,value:e/q}:t<1.5*M?{unit:"minute",multiplier:_,value:e/_}:t<1.5*E?{unit:"hour",multiplier:M,value:e/M}:t<J?{unit:"day",multiplier:E,value:e/E}:t<Y?{unit:"week",multiplier:J,value:e/J}:t<H?{unit:"month",multiplier:Y,value:e/Y}:{unit:"year",multiplier:H,value:e/H}}const ke=new Intl.RelativeTimeFormat("default",{numeric:"always",style:"short"});function ct(e){const{unit:t,value:n}=Ve(e);return ke.format(Math.round(n),t)}function lt(e){return new Promise(t=>{globalThis.setTimeout(t,e)})}async function*Je(e){const t=new Set;let n=await(await x).transaction("progress").store.index("state+due").openCursor();for(;n;){const[r,a]=n.key;if(r<y.Learning){n=await n.continue([y.Learning,G]);continue}if(r>y.Learning&&r<y.Relearning){n=await n.continue([y.Relearning,G]);continue}{const[i]=n.primaryKey;t.has(i)||(yield n,t.add(i))}n=await n.continue()}}async function me(){const e=new Set,t=(await x).transaction("reviews").store.index("review").iterate(IDBKeyRange.lowerBound(B()));for await(const n of t)e.add(n.value.cardId);return e}async function Ye(){const e=new Date;return(await x).transaction("reviews").store.index("state+review").count(IDBKeyRange.bound([y.New,B()],[y.New,e],!0,!0))}async function*He(){const e=await me(),t=(await x).transaction(["cards","progress"],"readwrite"),n=t.objectStore("cards"),r=t.objectStore("progress").index("cardId+cardType+state");let a=await n.index("position").openKeyCursor(IDBKeyRange.bound([0,0],[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],!1,!0));for(;a;){if(e.has(a.primaryKey)){a=await a.continue();continue}let i=await r.openCursor([a.primaryKey,"kanji-write",y.New]);i||(i=await r.openCursor([a.primaryKey,"kanji-read",y.New])),i&&(yield i),a=await a.continue()}}async function Ue(){const e=new Date;return(await x).transaction("reviews").store.index("state+review").count(IDBKeyRange.bound([y.Review,B()],[y.Review,e],!1,!0))}async function*qe(){const e=new Date,t=await me(),n=(await x).transaction(["cards","progress","reviews"],"readonly"),r=n.objectStore("cards"),a=n.objectStore("progress"),i=IDBKeyRange.bound([y.Review,G],[y.Review,e],!1,!0);let v=await a.index("state+due").openCursor(i);for(;v;){const[m]=v.primaryKey;if(!t.has(m)){const g=await r.get(m);g&&g.position.priority<Number.POSITIVE_INFINITY&&(yield v)}v=await v.continue()}}async function Ge(){const e=await(await x).getAllFromIndex("review-limits","time",IDBKeyRange.lowerBound(B())),t={due:0,new:0};for(const{count:n}of e)t.due+=n.due,t.new+=n.new;return t}async function $e({cardId:e,cardType:t},n){const r=(await x).transaction(["progress","reviews"],"readwrite"),a=r.objectStore("progress"),i=r.objectStore("reviews");await a.put({cardId:e,cardType:t,fsrs:n.card}),await i.add({cardId:e,cardType:t,log:n.log})}const $=ee("shodoku.app.preferences.limit.due",50),X=ee("shodoku.app.preferences.limit.new",10),ft=ee("shodoku.app.preferences.fsrs.fuzz-enabled",!0);async function dt(e={new:X.value,due:$.value}){return await(await x).add("review-limits",{time:new Date,count:e}),fe.postMessage("review-limit-increased")}const Xe=De("reviews",()=>{const e=N(!1),t=N([]),n=N([]),r=N([]),a=N(0),i=N(0),v=Z(()=>{const o=new Date;let u=0,s=0,l=0,c=t.value.at(u);const w=[];for(;c&&c.fsrs.due<o;)w.push(c),u+=1,c=t.value.at(u);const h=n.value.length,b=r.value.length,A=h+a.value,I=b+i.value,O=Math.ceil((I+A)/I),F=Math.floor(O/2);let R=n.value.at(s),C=r.value.at(l);for(;R||C;){if(!C){R&&w.push(R),s+=1,R=n.value.at(s);continue}if(!R){C&&w.push(C),l+=1,C=r.value.at(l);continue}(a.value+s+i.value+l)%O===F?(w.push(C),l+=1,C=r.value.at(l)):(w.push(R),s+=1,R=n.value.at(s))}for(;c;)w.push(c),u+=1,c=t.value.at(u);return w});async function m({cardId:o,cardType:u,fsrs:s},l){if(s.state===y.New?(r.value=r.value.filter(c=>c.cardId!==o),i.value+=1):s.state===y.Review?(n.value=n.value.filter(c=>c.cardId!==o),a.value+=1):t.value=t.value.filter(c=>c.cardId!==o),l.card.state===y.Learning||l.card.state===y.Relearning){const c={cardId:o,cardType:u,fsrs:l.card},w=l.card.due,h=t.value.findIndex(b=>w<b.fsrs.due);t.value=t.value.toSpliced(h===-1?t.value.length:h,0,c)}await $e({cardId:o,cardType:u},l),fe.postMessage("card-review")}function g(o){return t.value.some(u=>u.cardId===o)}function p(o){return n.value.some(u=>u.cardId===o)}async function d(){e.value=!0;try{const o=await Ge();a.value=await Ue(),i.value=await Ye(),t.value=await z(Je(),V(u=>u.value),k()),n.value=await z(qe(),ae(({primaryKey:[u]})=>u),ne(({primaryKey:[u]})=>!g(u)),re(Math.max(0,$.value+o.due-a.value)),V(u=>u.value),k()),r.value=await z(He(),ae(u=>u.primaryKey[0]),ne(({primaryKey:[u]})=>!g(u)&&!p(u)),re(Math.max(0,X.value+o.new-i.value)),V(u=>u.value),k())}finally{e.value=!1}}return d(),setTimeout(d,M),j([$,X],d),{refreshing:e,learningQueue:t,dueQueue:n,newQueue:r,queue:v,refreshQueues:d,rateCard:m}});function wt(){const e=Xe();return Z(()=>({due:e.dueQueue.length,new:e.newQueue.length,learning:e.learningQueue.length}))}function pt(){const{result:e}=Ne(async()=>{const t=new Map,n=(await x).transaction("reviews").store.index("review");for await(const r of n.iterate(IDBKeyRange.lowerBound(B()))){const a=r.value;let i=t.get(a.cardId);i||(i=[],t.set(a.cardId,i)),i.push(a)}return t});return e}export{pt as a,ct as b,st as c,Xe as d,ot as e,ne as f,nt as g,rt as h,dt as i,P as j,de as k,Te as l,it as m,X as n,at as o,Re as p,ft as q,$ as r,lt as s,T as t,wt as u,ut as w};
