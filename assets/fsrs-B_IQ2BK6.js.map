{"version":3,"file":"fsrs-B_IQ2BK6.js","sources":["../../src/helpers/fsrs.ts"],"sourcesContent":["import { FSRS, fsrs as createFsrs, generatorParameters, State } from \"ts-fsrs\";\nimport {\n  computed,\n  ComputedRef,\n  MaybeRefOrGetter,\n  ShallowReactive,\n  shallowReactive,\n  toValue,\n  watch,\n} from \"vue\";\n\nimport { db } from \"../db/index.ts\";\nimport {\n  fsrsFuzzEnabled,\n  knownMinDueWeeks,\n  knownMinRetention,\n} from \"../store/reviews.ts\";\nimport { CardProgress } from \"../types.ts\";\nimport { useLiveQuery } from \"./db.ts\";\nimport { isKanji } from \"./text.ts\";\nimport { WEEK } from \"./time.ts\";\n\nexport function useFsrs() {\n  return computed(() => {\n    const params = generatorParameters({\n      enable_fuzz: fsrsFuzzEnabled.value,\n    });\n\n    return createFsrs(params);\n  });\n}\n\nexport function useKanjiProgress(\n  codepoint: MaybeRefOrGetter<number>,\n): ComputedRef<{\n  read: CardProgress | null;\n  write: CardProgress | null;\n}> {\n  const { result } = useLiveQuery(\n    computed(() => {\n      const cardId = toValue(codepoint);\n\n      return async () => {\n        const progressStore = (await db).transaction(\"progress\").store;\n\n        const read = await progressStore.get([cardId, \"kanji-read\"]);\n        const write = await progressStore.get([cardId, \"kanji-write\"]);\n\n        return {\n          read: read ?? null,\n          write: write ?? null,\n        };\n      };\n    }),\n\n    { read: null, write: null },\n  );\n\n  return result;\n}\n\ntype KanjiRetrievability = number | \"learning\" | \"relearning\" | null;\n\nfunction getRetrievability(\n  progress: CardProgress | null,\n  fsrs: FSRS,\n  now = new Date(),\n): KanjiRetrievability {\n  if (!progress) {\n    return null;\n  }\n\n  if (progress.fsrs.state === State.Learning) {\n    return \"learning\";\n  }\n\n  if (progress.fsrs.state === State.Relearning) {\n    return \"relearning\";\n  }\n\n  return fsrs.get_retrievability(progress.fsrs, now, false);\n}\n\nexport function useKanjiRetrievability(\n  codepoint: MaybeRefOrGetter<number>,\n): ComputedRef<{\n  read: KanjiRetrievability;\n  write: KanjiRetrievability;\n} | null> {\n  const fsrs = useFsrs();\n  const progress = useKanjiProgress(codepoint);\n\n  const { result } = useLiveQuery(\n    computed(() => {\n      const fsrsValue = fsrs.value;\n      const { read, write } = progress.value;\n\n      return async () => {\n        const now = new Date();\n        return {\n          read: getRetrievability(read, fsrsValue, now),\n          write: getRetrievability(write, fsrsValue, now),\n        };\n      };\n    }),\n\n    { read: null, write: null },\n  );\n\n  return result;\n}\n\nexport function useHighKanjiReadingProficiency(\n  writing: MaybeRefOrGetter<string | null | undefined>,\n): ShallowReactive<Set<string>> {\n  const fsrs = useFsrs();\n  const knowsReading = shallowReactive(new Set<string>());\n\n  watch(\n    [() => toValue(writing), knownMinDueWeeks, knownMinRetention],\n    async ([value, minDueWeeks, minRetention]) => {\n      if (!value) {\n        return;\n      }\n\n      const now = new Date();\n      const minRetentionProb = minRetention / 100;\n      const minDueDate = new Date(Date.now() + minDueWeeks * WEEK);\n\n      for (const char of value) {\n        if (isKanji(char)) {\n          const codepoint = char.codePointAt(0) ?? 0;\n          const result = await (\n            await db\n          ).get(\"progress\", [codepoint, \"kanji-read\"]);\n          if (result) {\n            if (result.fsrs.state !== State.Review) {\n              continue;\n            }\n\n            const r = fsrs.value.get_retrievability(result.fsrs, now, false);\n\n            if (r > minRetentionProb && result.fsrs.due > minDueDate) {\n              knowsReading.add(char);\n            }\n          }\n        }\n      }\n    },\n    { immediate: true },\n  );\n\n  return knowsReading;\n}\n"],"names":["useFsrs","computed","params","generatorParameters","fsrsFuzzEnabled","createFsrs","useKanjiProgress","codepoint","result","useLiveQuery","cardId","toValue","progressStore","db","read","write","getRetrievability","progress","fsrs","now","State","useKanjiRetrievability","fsrsValue","useHighKanjiReadingProficiency","writing","knowsReading","shallowReactive","watch","knownMinDueWeeks","knownMinRetention","value","minDueWeeks","minRetention","minRetentionProb","minDueDate","WEEK","char","isKanji"],"mappings":"oMAsBO,SAASA,GAAU,CACxB,OAAOC,EAAS,IAAM,CACpB,MAAMC,EAASC,EAAoB,CACjC,YAAaC,EAAgB,KAAA,CAC9B,EAED,OAAOC,EAAWH,CAAM,CAC1B,CAAC,CACH,CAEO,SAASI,EACdC,EAIC,CACD,KAAM,CAAE,OAAAC,GAAWC,EACjBR,EAAS,IAAM,CACb,MAAMS,EAASC,EAAQJ,CAAS,EAEhC,MAAO,UAAY,CACjB,MAAMK,GAAiB,MAAMC,GAAI,YAAY,UAAU,EAAE,MAEnDC,EAAO,MAAMF,EAAc,IAAI,CAACF,EAAQ,YAAY,CAAC,EACrDK,EAAQ,MAAMH,EAAc,IAAI,CAACF,EAAQ,aAAa,CAAC,EAE7D,MAAO,CACL,KAAMI,GAAQ,KACd,MAAOC,GAAS,IAAA,CAEpB,CACF,CAAC,EAED,CAAE,KAAM,KAAM,MAAO,IAAA,CAAK,EAG5B,OAAOP,CACT,CAIA,SAASQ,EACPC,EACAC,EACAC,EAAM,IAAI,KACW,CACrB,OAAKF,EAIDA,EAAS,KAAK,QAAUG,EAAM,SACzB,WAGLH,EAAS,KAAK,QAAUG,EAAM,WACzB,aAGFF,EAAK,mBAAmBD,EAAS,KAAME,EAAK,EAAK,EAX/C,IAYX,CAEO,SAASE,EACdd,EAIQ,CACR,MAAMW,EAAOlB,EAAA,EACPiB,EAAWX,EAAiBC,CAAS,EAErC,CAAE,OAAAC,GAAWC,EACjBR,EAAS,IAAM,CACb,MAAMqB,EAAYJ,EAAK,MACjB,CAAE,KAAAJ,EAAM,MAAAC,CAAA,EAAUE,EAAS,MAEjC,MAAO,UAAY,CACjB,MAAME,MAAU,KAChB,MAAO,CACL,KAAMH,EAAkBF,EAAMQ,EAAWH,CAAG,EAC5C,MAAOH,EAAkBD,EAAOO,EAAWH,CAAG,CAAA,CAElD,CACF,CAAC,EAED,CAAE,KAAM,KAAM,MAAO,IAAA,CAAK,EAG5B,OAAOX,CACT,CAEO,SAASe,EACdC,EAC8B,CAC9B,MAAMN,EAAOlB,EAAA,EACPyB,EAAeC,EAAgB,IAAI,GAAa,EAEtD,OAAAC,EACE,CAAC,IAAMhB,EAAQa,CAAO,EAAGI,EAAkBC,CAAiB,EAC5D,MAAO,CAACC,EAAOC,EAAaC,CAAY,IAAM,CAC5C,GAAI,CAACF,EACH,OAGF,MAAMX,MAAU,KACVc,EAAmBD,EAAe,IAClCE,EAAa,IAAI,KAAK,KAAK,IAAA,EAAQH,EAAcI,CAAI,EAE3D,UAAWC,KAAQN,EACjB,GAAIO,EAAQD,CAAI,EAAG,CACjB,MAAM7B,EAAY6B,EAAK,YAAY,CAAC,GAAK,EACnC5B,EAAS,MACb,MAAMK,GACN,IAAI,WAAY,CAACN,EAAW,YAAY,CAAC,EAC3C,GAAIC,EAAQ,CACV,GAAIA,EAAO,KAAK,QAAUY,EAAM,OAC9B,SAGQF,EAAK,MAAM,mBAAmBV,EAAO,KAAMW,EAAK,EAAK,EAEvDc,GAAoBzB,EAAO,KAAK,IAAM0B,GAC5CT,EAAa,IAAIW,CAAI,CAEzB,CACF,CAEJ,EACA,CAAE,UAAW,EAAA,CAAK,EAGbX,CACT"}