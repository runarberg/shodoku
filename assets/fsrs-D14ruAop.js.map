{"version":3,"file":"fsrs-D14ruAop.js","sources":["../../src/helpers/fsrs.ts"],"sourcesContent":["import { FSRS, fsrs as createFsrs, generatorParameters, State } from \"ts-fsrs\";\nimport {\n  computed,\n  ComputedRef,\n  MaybeRefOrGetter,\n  ShallowReactive,\n  shallowReactive,\n  toValue,\n  watch,\n} from \"vue\";\n\nimport { db } from \"../db/index.ts\";\nimport {\n  fsrsFuzzEnabled,\n  knownMinDueWeeks,\n  knownMinRetention,\n} from \"../store/reviews.ts\";\nimport { CardProgress, CardType } from \"../types.ts\";\nimport { useLiveQuery } from \"./db.ts\";\nimport { isKanji } from \"./text.ts\";\nimport { WEEK } from \"./time.ts\";\n\nexport function useFsrs() {\n  return computed(() => {\n    const params = generatorParameters({\n      enable_fuzz: fsrsFuzzEnabled.value,\n    });\n\n    return createFsrs(params);\n  });\n}\n\nexport function useCardProgress(\n  cardId: MaybeRefOrGetter<number | undefined>,\n  cardTypes: CardType[],\n): ComputedRef<Map<CardType, CardProgress>> {\n  const { result } = useLiveQuery(\n    computed(() => {\n      const id = toValue(cardId);\n\n      return async () => {\n        const progressMap = new Map<CardType, CardProgress>();\n\n        if (!id) {\n          return progressMap;\n        }\n\n        const progressStore = (await db).transaction(\"progress\").store;\n\n        for (const cardType of cardTypes) {\n          const progress = await progressStore.get([id, cardType]);\n          if (progress) {\n            progressMap.set(cardType, progress);\n          }\n        }\n\n        return progressMap;\n      };\n    }),\n\n    new Map<CardType, CardProgress>(),\n  );\n\n  return result;\n}\n\nexport type CardRetrievability = number | \"learning\" | \"relearning\" | null;\n\nfunction getRetrievability(\n  progress: CardProgress | null,\n  fsrs: FSRS,\n  now = new Date(),\n): CardRetrievability {\n  if (!progress) {\n    return null;\n  }\n\n  if (progress.fsrs.state === State.Learning) {\n    return \"learning\";\n  }\n\n  if (progress.fsrs.state === State.Relearning) {\n    return \"relearning\";\n  }\n\n  return fsrs.get_retrievability(progress.fsrs, now, false);\n}\n\nexport function useCardRetrievability(\n  codepoint: MaybeRefOrGetter<number | undefined>,\n  cardTypes: CardType[],\n): ComputedRef<Map<CardType, CardRetrievability>> {\n  const fsrs = useFsrs();\n  const progresses = useCardProgress(codepoint, cardTypes);\n\n  return computed(() => {\n    const now = new Date();\n    const fsrsValue = fsrs.value;\n    const result = new Map<CardType, CardRetrievability>();\n\n    for (const [cardType, cardProgress] of progresses.value) {\n      result.set(cardType, getRetrievability(cardProgress, fsrsValue, now));\n    }\n\n    return result;\n  });\n}\n\nexport function useHighKanjiReadingProficiency(\n  writing: MaybeRefOrGetter<string | null | undefined>,\n): ShallowReactive<Set<string>> {\n  const fsrs = useFsrs();\n  const knowsReading = shallowReactive(new Set<string>());\n\n  watch(\n    [() => toValue(writing), knownMinDueWeeks, knownMinRetention],\n    async ([value, minDueWeeks, minRetention]) => {\n      if (!value) {\n        return;\n      }\n\n      const now = new Date();\n      const minRetentionProb = minRetention / 100;\n      const minDueDate = new Date(Date.now() + minDueWeeks * WEEK);\n\n      for (const char of value) {\n        if (isKanji(char)) {\n          const codepoint = char.codePointAt(0) ?? 0;\n          const result = await (\n            await db\n          ).get(\"progress\", [codepoint, \"kanji-read\"]);\n          if (result) {\n            if (result.fsrs.state !== State.Review) {\n              continue;\n            }\n\n            const r = fsrs.value.get_retrievability(result.fsrs, now, false);\n\n            if (r > minRetentionProb && result.fsrs.due > minDueDate) {\n              knowsReading.add(char);\n            }\n          }\n        }\n      }\n    },\n    { immediate: true },\n  );\n\n  return knowsReading;\n}\n"],"names":["useFsrs","computed","params","generatorParameters","fsrsFuzzEnabled","createFsrs","useCardProgress","cardId","cardTypes","result","useLiveQuery","id","toValue","progressMap","progressStore","db","cardType","progress","getRetrievability","fsrs","now","State","useCardRetrievability","codepoint","progresses","fsrsValue","cardProgress","useHighKanjiReadingProficiency","writing","knowsReading","shallowReactive","watch","knownMinDueWeeks","knownMinRetention","value","minDueWeeks","minRetention","minRetentionProb","minDueDate","WEEK","char","isKanji"],"mappings":"+LAsBO,SAASA,GAAU,CACxB,OAAOC,EAAS,IAAM,CACpB,MAAMC,EAASC,EAAoB,CACjC,YAAaC,EAAgB,KAAA,CAC9B,EAED,OAAOC,EAAWH,CAAM,CAC1B,CAAC,CACH,CAEO,SAASI,EACdC,EACAC,EAC0C,CAC1C,KAAM,CAAE,OAAAC,GAAWC,EACjBT,EAAS,IAAM,CACb,MAAMU,EAAKC,EAAQL,CAAM,EAEzB,MAAO,UAAY,CACjB,MAAMM,MAAkB,IAExB,GAAI,CAACF,EACH,OAAOE,EAGT,MAAMC,GAAiB,MAAMC,GAAI,YAAY,UAAU,EAAE,MAEzD,UAAWC,KAAYR,EAAW,CAChC,MAAMS,EAAW,MAAMH,EAAc,IAAI,CAACH,EAAIK,CAAQ,CAAC,EACnDC,GACFJ,EAAY,IAAIG,EAAUC,CAAQ,CAEtC,CAEA,OAAOJ,CACT,CACF,CAAC,MAEG,GAA4B,EAGlC,OAAOJ,CACT,CAIA,SAASS,EACPD,EACAE,EACAC,EAAM,IAAI,KACU,CACpB,OAAKH,EAIDA,EAAS,KAAK,QAAUI,EAAM,SACzB,WAGLJ,EAAS,KAAK,QAAUI,EAAM,WACzB,aAGFF,EAAK,mBAAmBF,EAAS,KAAMG,EAAK,EAAK,EAX/C,IAYX,CAEO,SAASE,EACdC,EACAf,EACgD,CAChD,MAAMW,EAAOnB,EAAA,EACPwB,EAAalB,EAAgBiB,EAAWf,CAAS,EAEvD,OAAOP,EAAS,IAAM,CACpB,MAAMmB,MAAU,KACVK,EAAYN,EAAK,MACjBV,MAAa,IAEnB,SAAW,CAACO,EAAUU,CAAY,IAAKF,EAAW,MAChDf,EAAO,IAAIO,EAAUE,EAAkBQ,EAAcD,EAAWL,CAAG,CAAC,EAGtE,OAAOX,CACT,CAAC,CACH,CAEO,SAASkB,EACdC,EAC8B,CAC9B,MAAMT,EAAOnB,EAAA,EACP6B,EAAeC,EAAgB,IAAI,GAAa,EAEtD,OAAAC,EACE,CAAC,IAAMnB,EAAQgB,CAAO,EAAGI,EAAkBC,CAAiB,EAC5D,MAAO,CAACC,EAAOC,EAAaC,CAAY,IAAM,CAC5C,GAAI,CAACF,EACH,OAGF,MAAMd,MAAU,KACViB,EAAmBD,EAAe,IAClCE,EAAa,IAAI,KAAK,KAAK,IAAA,EAAQH,EAAcI,CAAI,EAE3D,UAAWC,KAAQN,EACjB,GAAIO,EAAQD,CAAI,EAAG,CACjB,MAAMjB,EAAYiB,EAAK,YAAY,CAAC,GAAK,EACnC/B,EAAS,MACb,MAAMM,GACN,IAAI,WAAY,CAACQ,EAAW,YAAY,CAAC,EAC3C,GAAId,EAAQ,CACV,GAAIA,EAAO,KAAK,QAAUY,EAAM,OAC9B,SAGQF,EAAK,MAAM,mBAAmBV,EAAO,KAAMW,EAAK,EAAK,EAEvDiB,GAAoB5B,EAAO,KAAK,IAAM6B,GAC5CT,EAAa,IAAIW,CAAI,CAEzB,CACF,CAEJ,EACA,CAAE,UAAW,EAAA,CAAK,EAGbX,CACT"}