{"version":3,"file":"decks-BBCgiq92.js","sources":["../../src/helpers/random.ts","../../src/db/decks.ts"],"sourcesContent":["function randomBytes(n: number): string {\n  return Math.floor(Math.random() * 16 ** n)\n    .toString(16)\n    .padStart(n, \"0\");\n}\n\nexport function randomId(): string {\n  try {\n    return crypto.randomUUID();\n  } catch {\n    // Not a secure context. Backup for dev over a local network.\n    return [\n      randomBytes(8),\n      randomBytes(4),\n      randomBytes(4),\n      randomBytes(4),\n      `${randomBytes(6)}${randomBytes(6)}`,\n    ].join(\"-\");\n  }\n}\n","import { IDBPTransaction } from \"idb\";\nimport { createEmptyCard, FSRS, generatorParameters, State } from \"ts-fsrs\";\n\nimport { liveQueryBroadcaster } from \"../helpers/channels.ts\";\nimport { randomId } from \"../helpers/random.ts\";\nimport { WEEK } from \"../helpers/time.ts\";\nimport { knownMinDueWeeks, knownMinRetention } from \"../store/reviews.ts\";\nimport {\n  Card,\n  CardProgress,\n  CardType,\n  Deck,\n  DeckTemplate,\n  Optional,\n} from \"../types.ts\";\nimport { db } from \"./index.ts\";\nimport { DB } from \"./schema.ts\";\nimport { addToSyncStaging } from \"./sync.ts\";\n\nfunction isNotNull<T>(thing: T | null | undefined): thing is T {\n  return thing != null;\n}\n\nasync function maybeCreateCard(\n  tx: IDBPTransaction<DB, Array<\"cards\" | \"progress\" | \"decks\">, \"readwrite\">,\n  id: number,\n) {\n  const cards = tx.objectStore(\"cards\");\n  const progress = tx.objectStore(\"progress\");\n  const now = new Date();\n\n  if (!(await cards.getKey(id))) {\n    const card: Card = {\n      id,\n      value: String.fromCodePoint(id),\n      types: [\"kanji-read\", \"kanji-write\"],\n      createdAt: now,\n    };\n\n    const writeProgress: CardProgress = {\n      cardId: id,\n      cardType: \"kanji-write\",\n      fsrs: createEmptyCard(),\n    };\n\n    const readProgress: CardProgress = {\n      cardId: id,\n      cardType: \"kanji-read\",\n      fsrs: createEmptyCard(),\n    };\n\n    cards.add(card);\n    progress.add(writeProgress);\n    progress.add(readProgress);\n\n    addToSyncStaging([\n      { store: \"cards\", op: \"add\", key: id },\n      { store: \"progress\", op: \"add\", key: [id, \"kanji-write\"] },\n      { store: \"progress\", op: \"add\", key: [id, \"kanji-read\"] },\n    ]);\n  }\n}\n\nexport async function activateDeck(\n  deckName: string,\n  transaction?: IDBPTransaction<\n    DB,\n    Array<\"cards\" | \"progress\" | \"decks\">,\n    \"readwrite\"\n  >,\n): Promise<Deck> {\n  let tx = transaction;\n  let newTransaction = false;\n\n  if (!tx) {\n    newTransaction = true;\n    tx = (await db).transaction([\"cards\", \"decks\", \"progress\"], \"readwrite\");\n  }\n\n  const decks = tx.objectStore(\"decks\");\n  const deck = await decks.get(deckName);\n\n  if (!deck) {\n    throw new Error(\"Deck does not exist\");\n  }\n\n  if (deck.active) {\n    return deck;\n  }\n\n  const updatedAt = new Date();\n  await decks.put({\n    ...deck,\n    active: true,\n    updatedAt,\n  });\n\n  for (const cardId of deck.cards) {\n    maybeCreateCard(tx, cardId);\n  }\n\n  addToSyncStaging([{ store: \"decks\", key: deck.name, op: \"put\" }]);\n\n  if (newTransaction) {\n    await tx.done;\n    liveQueryBroadcaster.postMessage(\"deck-added\");\n  }\n\n  return deck;\n}\n\nexport async function activateDeckCategory(\n  category: string,\n  deckTemplates: DeckTemplate[],\n) {\n  const now = new Date();\n  const decks: Array<Omit<Deck, \"createdAt\"> | string> = await Promise.all(\n    deckTemplates.map(async ({ name, label, priority, content }) => {\n      const isStored = await (await db).getKey(\"decks\", name);\n\n      if (isStored) {\n        return name;\n      }\n\n      const response = await fetch(content);\n      const csv = await response.text();\n\n      const cards = csv\n        .split(\"\\n\")\n        .map((line) => line.codePointAt(0))\n        .filter(isNotNull);\n\n      return {\n        name,\n        label,\n        priority,\n        category,\n        cards,\n        active: true,\n      };\n    }),\n  );\n\n  const tx = (await db).transaction(\n    [\"cards\", \"decks\", \"progress\"],\n    \"readwrite\",\n  );\n\n  const decksStore = tx.objectStore(\"decks\");\n\n  for (const deckOrName of decks) {\n    if (typeof deckOrName === \"string\") {\n      activateDeck(deckOrName, tx);\n    } else {\n      const deck = { ...deckOrName, createdAt: now };\n      await decksStore.add(deck);\n\n      addToSyncStaging([{ store: \"decks\", op: \"add\", key: deck.name }]);\n\n      for (const card of deck.cards) {\n        maybeCreateCard(tx, card);\n      }\n    }\n  }\n\n  await tx.done;\n  liveQueryBroadcaster.postMessage(\"deck-category-added\");\n}\n\nexport async function deactivateDeck(deckName: string) {\n  const tx = (await db).transaction([\"cards\", \"decks\"], \"readwrite\");\n  const decks = tx.objectStore(\"decks\");\n\n  const deck = await decks.get(deckName);\n  if (!deck || !deck.active) {\n    return;\n  }\n\n  const updatedAt = new Date();\n\n  await decks.put({ ...deck, active: false, updatedAt });\n  addToSyncStaging([{ store: \"decks\", op: \"put\", key: deck.name }]);\n\n  await tx.done;\n\n  liveQueryBroadcaster.postMessage(\"deck-removed\");\n}\n\nexport async function deactivateDeckCategory(category: string) {\n  const tx = (await db).transaction([\"cards\", \"decks\"], \"readwrite\");\n  const decks = await tx\n    .objectStore(\"decks\")\n    .index(\"category\")\n    .getAllKeys(category);\n\n  for (const deck of decks) {\n    await deactivateDeck(deck);\n  }\n\n  await tx.done;\n}\n\ntype DeckStatusCount = {\n  new: number;\n  due: number;\n  review: number;\n  know: number;\n};\n\ntype DeckStatus = { [Property in CardType]: DeckStatusCount };\n\nexport async function getDeckStatus(\n  name: string,\n  fsrs = new FSRS(generatorParameters()),\n) {\n  const tx = (await db).transaction([\"decks\", \"progress\"]);\n  const progressStore = tx.objectStore(\"progress\");\n\n  const deckStatus: DeckStatus = {\n    \"kanji-read\": {\n      new: 0,\n      due: 0,\n      review: 0,\n      know: 0,\n    },\n\n    \"kanji-write\": {\n      new: 0,\n      due: 0,\n      review: 0,\n      know: 0,\n    },\n  };\n\n  const now = new Date();\n  const deck = await tx.objectStore(\"decks\").get(name);\n\n  if (!deck) {\n    return deckStatus;\n  }\n\n  const minRetentionProb = knownMinRetention.value / 100;\n  const minDueDate = new Date(Date.now() + knownMinDueWeeks.value * WEEK);\n\n  for await (const cardId of deck.cards) {\n    for (const [cardType, counts] of Object.entries(deckStatus) as Array<\n      [type: CardType, count: DeckStatusCount]\n    >) {\n      const progress = await progressStore.get([cardId, cardType]);\n\n      if (!progress) {\n        continue;\n      }\n\n      if (progress.fsrs.state === State.New) {\n        counts.new += 1;\n      } else if (\n        progress.fsrs.state === State.Learning ||\n        progress.fsrs.state === State.Relearning ||\n        progress.fsrs.due < now\n      ) {\n        counts.due += 1;\n      } else if (\n        progress.fsrs.due > minDueDate &&\n        fsrs.get_retrievability(progress.fsrs, now, false) > minRetentionProb\n      ) {\n        counts.know += 1;\n      } else {\n        counts.review += 1;\n      }\n    }\n  }\n\n  return deckStatus;\n}\n\nexport async function createDeck({\n  name = `custom/${randomId()}`,\n  active = true,\n  category = \"custom\",\n  createdAt = new Date(),\n  ...deckTemplate\n}: Optional<\n  Deck,\n  \"name\" | \"active\" | \"category\" | \"createdAt\"\n>): Promise<Deck> {\n  const deck: Deck = {\n    ...deckTemplate,\n    name,\n    active,\n    category,\n    createdAt,\n  };\n\n  const tx = (await db).transaction(\n    [\"decks\", \"cards\", \"progress\"],\n    \"readwrite\",\n  );\n\n  await tx.objectStore(\"decks\").add(deck);\n  addToSyncStaging([{ store: \"decks\", op: \"add\", key: deck.name }]);\n\n  for (const card of deck.cards) {\n    maybeCreateCard(tx, card);\n  }\n\n  await tx.done;\n  liveQueryBroadcaster.postMessage(\"deck-created\");\n\n  return deck;\n}\n\nexport async function editDeck(deck: Deck): Promise<void> {\n  const tx = (await db).transaction(\n    [\"decks\", \"cards\", \"progress\"],\n    \"readwrite\",\n  );\n\n  const decks = tx.objectStore(\"decks\");\n  const previousDeck = await decks.get(deck.name);\n\n  if (!previousDeck) {\n    await decks.add(deck);\n\n    addToSyncStaging([{ store: \"decks\", op: \"add\", key: deck.name }]);\n    liveQueryBroadcaster.postMessage(\"deck-created\");\n\n    return;\n  }\n\n  const updatedAt = new Date();\n  await decks.put({ ...deck, updatedAt });\n\n  addToSyncStaging([{ store: \"decks\", op: \"put\", key: deck.name }]);\n\n  for (const card of deck.cards) {\n    if (!previousDeck.cards.includes(card)) {\n      maybeCreateCard(tx, card);\n    }\n  }\n\n  await tx.done;\n  liveQueryBroadcaster.postMessage(\"custom-deck-edited\");\n}\n\nexport async function removeDeck(name: string): Promise<void> {\n  const tx = (await db).transaction([\"decks\", \"cards\"], \"readwrite\");\n\n  await tx.objectStore(\"decks\").delete(name);\n\n  addToSyncStaging([{ store: \"decks\", op: \"delete\", key: name }]);\n  liveQueryBroadcaster.postMessage(\"custom-deck-removed\");\n}\n"],"names":["randomBytes","n","randomId","isNotNull","thing","maybeCreateCard","tx","id","cards","progress","now","card","writeProgress","createEmptyCard","readProgress","addToSyncStaging","activateDeck","deckName","transaction","newTransaction","db","decks","deck","updatedAt","cardId","liveQueryBroadcaster","activateDeckCategory","category","deckTemplates","name","label","priority","content","line","decksStore","deckOrName","deactivateDeck","deactivateDeckCategory","getDeckStatus","fsrs","FSRS","generatorParameters","progressStore","deckStatus","minRetentionProb","knownMinRetention","minDueDate","knownMinDueWeeks","WEEK","cardType","counts","State","createDeck","active","createdAt","deckTemplate","editDeck","previousDeck","removeDeck"],"mappings":"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"}