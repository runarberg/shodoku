var G=Object.defineProperty;var N=(r,t,i)=>t in r?G(r,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):r[t]=i;var _=(r,t,i)=>N(r,typeof t!="symbol"?t+"":t,i);var c=(r=>(r[r.New=0]="New",r[r.Learning=1]="Learning",r[r.Review=2]="Review",r[r.Relearning=3]="Relearning",r))(c||{}),d=(r=>(r[r.Manual=0]="Manual",r[r.Again=1]="Again",r[r.Hard=2]="Hard",r[r.Good=3]="Good",r[r.Easy=4]="Easy",r))(d||{});class o{static card(t){return{...t,state:o.state(t.state),due:o.time(t.due),last_review:t.last_review?o.time(t.last_review):void 0}}static rating(t){if(typeof t=="string"){const i=t.charAt(0).toUpperCase(),e=t.slice(1).toLowerCase(),a=d[`${i}${e}`];if(a===void 0)throw new Error(`Invalid rating:[${t}]`);return a}else if(typeof t=="number")return t;throw new Error(`Invalid rating:[${t}]`)}static state(t){if(typeof t=="string"){const i=t.charAt(0).toUpperCase(),e=t.slice(1).toLowerCase(),a=c[`${i}${e}`];if(a===void 0)throw new Error(`Invalid state:[${t}]`);return a}else if(typeof t=="number")return t;throw new Error(`Invalid state:[${t}]`)}static time(t){if(typeof t=="object"&&t instanceof Date)return t;if(typeof t=="string"){const i=Date.parse(t);if(isNaN(i))throw new Error(`Invalid date:[${t}]`);return new Date(i)}else if(typeof t=="number")return new Date(t);throw new Error(`Invalid date:[${t}]`)}static review_log(t){return{...t,due:o.time(t.due),rating:o.rating(t.rating),state:o.state(t.state),review:o.time(t.review)}}}const D=.9,F=36500,I=[.4072,1.1829,3.1262,15.4722,7.2102,.5316,1.0651,.0234,1.616,.1544,1.0824,1.9813,.0953,.2975,2.2042,.2407,2.9466,.5034,.6567],z=!1,T=!0,R=r=>{let t=I;return r!=null&&r.w&&(r.w.length===19?t=r==null?void 0:r.w:r.w.length===17&&(t=r==null?void 0:r.w.concat([0,0]),console.debug("[FSRS V5]auto fill w to 19 length"))),{request_retention:(r==null?void 0:r.request_retention)||D,maximum_interval:(r==null?void 0:r.maximum_interval)||F,w:t,enable_fuzz:(r==null?void 0:r.enable_fuzz)??z,enable_short_term:(r==null?void 0:r.enable_short_term)??T}};function E(r,t){const i={due:r?o.time(r):new Date,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:0,lapses:0,state:c.New,last_review:void 0};return t&&typeof t=="function"?t(i):i}Date.prototype.scheduler=function(r,t){return q(this,r,t)},Date.prototype.diff=function(r,t){return C(this,r,t)},Date.prototype.format=function(){return j(this)},Date.prototype.dueFormat=function(r,t,i){return B(this,r,t,i)};function q(r,t,i){return new Date(i?m(r).getTime()+t*24*60*60*1e3:m(r).getTime()+t*60*1e3)}function C(r,t,i){if(!r||!t)throw new Error("Invalid date");const e=m(r).getTime()-m(t).getTime();let a=0;switch(i){case"days":a=Math.floor(e/(24*60*60*1e3));break;case"minutes":a=Math.floor(e/(60*1e3));break}return a}function j(r){const t=m(r),i=t.getFullYear(),e=t.getMonth()+1,a=t.getDate(),s=t.getHours(),n=t.getMinutes(),l=t.getSeconds();return`${i}-${w(e)}-${w(a)} ${w(s)}:${w(n)}:${w(l)}`}function w(r){return r<10?`0${r}`:`${r}`}const x=[60,60,24,31,12],b=["second","min","hour","day","month","year"];function B(r,t,i,e=b){r=m(r),t=m(t),e.length!==b.length&&(e=b);let a=r.getTime()-t.getTime(),s;for(a/=1e3,s=0;s<x.length&&!(a<x[s]);s++)a/=x[s];return`${Math.floor(a)}${i?e[s]:""}`}function m(r){return o.time(r)}const O=[d.Again,d.Hard,d.Good,d.Easy],U=[{start:2.5,end:7,factor:.15},{start:7,end:20,factor:.1},{start:20,end:1/0,factor:.05}];function V(r,t,i){let e=1;for(const n of U)e+=n.factor*Math.max(Math.min(r,n.end)-n.start,0);r=Math.min(r,i);let a=Math.max(2,Math.round(r-e));const s=Math.min(Math.round(r+e),i);return r>t&&(a=Math.max(a,t+1)),a=Math.min(a,s),{min_ivl:a,max_ivl:s}}function M(r,t,i){return Math.min(Math.max(r,t),i)}class J{constructor(t){_(this,"c");_(this,"s0");_(this,"s1");_(this,"s2");const i=K();this.c=1,this.s0=i(" "),this.s1=i(" "),this.s2=i(" "),t==null&&(t=+new Date),this.s0-=i(t),this.s0<0&&(this.s0+=1),this.s1-=i(t),this.s1<0&&(this.s1+=1),this.s2-=i(t),this.s2<0&&(this.s2+=1)}next(){const t=2091639*this.s0+this.c*23283064365386963e-26;return this.s0=this.s1,this.s1=this.s2,this.s2=t-(this.c=t|0),this.s2}set state(t){this.c=t.c,this.s0=t.s0,this.s1=t.s1,this.s2=t.s2}get state(){return{c:this.c,s0:this.s0,s1:this.s1,s2:this.s2}}}function K(){let r=4022871197;return function(t){t=String(t);for(let i=0;i<t.length;i++){r+=t.charCodeAt(i);let e=.02519603282416938*r;r=e>>>0,e-=r,e*=r,r=e>>>0,e-=r,r+=e*4294967296}return(r>>>0)*23283064365386963e-26}}function P(r){const t=new J(r),i=()=>t.next();return i.int32=()=>t.next()*4294967296|0,i.double=()=>i()+(i()*2097152|0)*11102230246251565e-32,i.state=()=>t.state,i.importState=e=>(t.state=e,i),i}const $=-.5,S=19/81;class Q{constructor(t){_(this,"param");_(this,"intervalModifier");_(this,"_seed");this.param=new Proxy(R(t),this.params_handler_proxy()),this.intervalModifier=this.calculate_interval_modifier(this.param.request_retention)}get interval_modifier(){return this.intervalModifier}set seed(t){this._seed=t}calculate_interval_modifier(t){if(t<=0||t>1)throw new Error("Requested retention rate should be in the range (0,1]");return+((Math.pow(t,1/$)-1)/S).toFixed(8)}get parameters(){return this.param}set parameters(t){this.update_parameters(t)}params_handler_proxy(){const t=this;return{set:function(i,e,a){return e==="request_retention"&&Number.isFinite(a)&&(t.intervalModifier=t.calculate_interval_modifier(Number(a))),Reflect.set(i,e,a),!0}}}update_parameters(t){const i=R(t);for(const e in i)if(e in this.param){const a=e;this.param[a]=i[a]}}init_stability(t){return Math.max(this.param.w[t-1],.1)}init_difficulty(t){return this.constrain_difficulty(this.param.w[4]-Math.exp((t-1)*this.param.w[5])+1)}apply_fuzz(t,i){if(!this.param.enable_fuzz||t<2.5)return Math.round(t);const e=P(this._seed)(),{min_ivl:a,max_ivl:s}=V(t,i,this.param.maximum_interval);return Math.floor(e*(s-a+1)+a)}next_interval(t,i){const e=Math.min(Math.max(1,Math.round(t*this.intervalModifier)),this.param.maximum_interval);return this.apply_fuzz(e,i)}next_difficulty(t,i){const e=t-this.param.w[6]*(i-3);return this.constrain_difficulty(this.mean_reversion(this.init_difficulty(d.Easy),e))}constrain_difficulty(t){return Math.min(Math.max(+t.toFixed(8),1),10)}mean_reversion(t,i){return+(this.param.w[7]*t+(1-this.param.w[7])*i).toFixed(8)}next_recall_stability(t,i,e,a){const s=d.Hard===a?this.param.w[15]:1,n=d.Easy===a?this.param.w[16]:1;return+M(i*(1+Math.exp(this.param.w[8])*(11-t)*Math.pow(i,-this.param.w[9])*(Math.exp((1-e)*this.param.w[10])-1)*s*n),.01,36500).toFixed(8)}next_forget_stability(t,i,e){return+M(this.param.w[11]*Math.pow(t,-this.param.w[12])*(Math.pow(i+1,this.param.w[13])-1)*Math.exp((1-e)*this.param.w[14]),.01,36500).toFixed(8)}next_short_term_stability(t,i){return+M(t*Math.exp(this.param.w[17]*(i-3+this.param.w[18])),.01,36500).toFixed(8)}forgetting_curve(t,i){return+Math.pow(1+S*t/i,$).toFixed(8)}}class A{constructor(t,i,e){_(this,"last");_(this,"current");_(this,"review_time");_(this,"next",new Map);_(this,"algorithm");this.algorithm=e,this.last=o.card(t),this.current=o.card(t),this.review_time=o.time(i),this.init()}init(){const{state:t,last_review:i}=this.current;let e=0;t!==c.New&&i&&(e=this.review_time.diff(i,"days")),this.current.last_review=this.review_time,this.current.elapsed_days=e,this.current.reps+=1,this.initSeed()}preview(){return{[d.Again]:this.review(d.Again),[d.Hard]:this.review(d.Hard),[d.Good]:this.review(d.Good),[d.Easy]:this.review(d.Easy),[Symbol.iterator]:this.previewIterator.bind(this)}}*previewIterator(){for(const t of O)yield this.review(t)}review(t){const{state:i}=this.last;let e;switch(i){case c.New:e=this.newState(t);break;case c.Learning:case c.Relearning:e=this.learningState(t);break;case c.Review:e=this.reviewState(t);break}if(e)return e;throw new Error("Invalid grade")}initSeed(){const t=this.review_time.getTime(),i=this.current.reps,e=this.current.difficulty*this.current.stability;this.algorithm.seed=`${t}_${i}_${e}`}buildLog(t){const{last_review:i,due:e,elapsed_days:a}=this.last;return{rating:t,state:this.current.state,due:i||e,stability:this.current.stability,difficulty:this.current.difficulty,elapsed_days:this.current.elapsed_days,last_elapsed_days:a,scheduled_days:this.current.scheduled_days,review:this.review_time}}}class L extends A{newState(t){const i=this.next.get(t);if(i)return i;const e=o.card(this.current);switch(e.difficulty=this.algorithm.init_difficulty(t),e.stability=this.algorithm.init_stability(t),t){case d.Again:e.scheduled_days=0,e.due=this.review_time.scheduler(1),e.state=c.Learning;break;case d.Hard:e.scheduled_days=0,e.due=this.review_time.scheduler(5),e.state=c.Learning;break;case d.Good:e.scheduled_days=0,e.due=this.review_time.scheduler(10),e.state=c.Learning;break;case d.Easy:{const s=this.algorithm.next_interval(e.stability,this.current.elapsed_days);e.scheduled_days=s,e.due=this.review_time.scheduler(s,!0),e.state=c.Review;break}default:throw new Error("Invalid grade")}const a={card:e,log:this.buildLog(t)};return this.next.set(t,a),a}learningState(t){const i=this.next.get(t);if(i)return i;const{state:e,difficulty:a,stability:s}=this.last,n=o.card(this.current),l=this.current.elapsed_days;switch(n.difficulty=this.algorithm.next_difficulty(a,t),n.stability=this.algorithm.next_short_term_stability(s,t),t){case d.Again:{n.scheduled_days=0,n.due=this.review_time.scheduler(5,!1),n.state=e;break}case d.Hard:{n.scheduled_days=0,n.due=this.review_time.scheduler(10),n.state=e;break}case d.Good:{const u=this.algorithm.next_interval(n.stability,l);n.scheduled_days=u,n.due=this.review_time.scheduler(u,!0),n.state=c.Review;break}case d.Easy:{const u=this.algorithm.next_short_term_stability(s,d.Good),f=this.algorithm.next_interval(u,l),y=Math.max(this.algorithm.next_interval(n.stability,l),f+1);n.scheduled_days=y,n.due=this.review_time.scheduler(y,!0),n.state=c.Review;break}default:throw new Error("Invalid grade")}const h={card:n,log:this.buildLog(t)};return this.next.set(t,h),h}reviewState(t){const i=this.next.get(t);if(i)return i;const e=this.current.elapsed_days,{difficulty:a,stability:s}=this.last,n=this.algorithm.forgetting_curve(e,s),l=o.card(this.current),h=o.card(this.current),u=o.card(this.current),f=o.card(this.current);this.next_ds(l,h,u,f,a,s,n),this.next_interval(l,h,u,f,e),this.next_state(l,h,u,f),l.lapses+=1;const y={card:l,log:this.buildLog(d.Again)},v={card:h,log:super.buildLog(d.Hard)},p={card:u,log:super.buildLog(d.Good)},g={card:f,log:super.buildLog(d.Easy)};return this.next.set(d.Again,y),this.next.set(d.Hard,v),this.next.set(d.Good,p),this.next.set(d.Easy,g),this.next.get(t)}next_ds(t,i,e,a,s,n,l){t.difficulty=this.algorithm.next_difficulty(s,d.Again),t.stability=this.algorithm.next_forget_stability(s,n,l),i.difficulty=this.algorithm.next_difficulty(s,d.Hard),i.stability=this.algorithm.next_recall_stability(s,n,l,d.Hard),e.difficulty=this.algorithm.next_difficulty(s,d.Good),e.stability=this.algorithm.next_recall_stability(s,n,l,d.Good),a.difficulty=this.algorithm.next_difficulty(s,d.Easy),a.stability=this.algorithm.next_recall_stability(s,n,l,d.Easy)}next_interval(t,i,e,a,s){let n,l;n=this.algorithm.next_interval(i.stability,s),l=this.algorithm.next_interval(e.stability,s),n=Math.min(n,l),l=Math.max(l,n+1);const h=Math.max(this.algorithm.next_interval(a.stability,s),l+1);t.scheduled_days=0,t.due=this.review_time.scheduler(5),i.scheduled_days=n,i.due=this.review_time.scheduler(n,!0),e.scheduled_days=l,e.due=this.review_time.scheduler(l,!0),a.scheduled_days=h,a.due=this.review_time.scheduler(h,!0)}next_state(t,i,e,a){t.state=c.Relearning,i.state=c.Review,e.state=c.Review,a.state=c.Review}}class H extends A{newState(t){const i=this.next.get(t);if(i)return i;this.current.scheduled_days=0,this.current.elapsed_days=0;const e=o.card(this.current),a=o.card(this.current),s=o.card(this.current),n=o.card(this.current);return this.init_ds(e,a,s,n),this.next_interval(e,a,s,n,0),this.next_state(e,a,s,n),this.update_next(e,a,s,n),this.next.get(t)}init_ds(t,i,e,a){t.difficulty=this.algorithm.init_difficulty(d.Again),t.stability=this.algorithm.init_stability(d.Again),i.difficulty=this.algorithm.init_difficulty(d.Hard),i.stability=this.algorithm.init_stability(d.Hard),e.difficulty=this.algorithm.init_difficulty(d.Good),e.stability=this.algorithm.init_stability(d.Good),a.difficulty=this.algorithm.init_difficulty(d.Easy),a.stability=this.algorithm.init_stability(d.Easy)}learningState(t){return this.reviewState(t)}reviewState(t){const i=this.next.get(t);if(i)return i;const e=this.current.elapsed_days,{difficulty:a,stability:s}=this.last,n=this.algorithm.forgetting_curve(e,s),l=o.card(this.current),h=o.card(this.current),u=o.card(this.current),f=o.card(this.current);return this.next_ds(l,h,u,f,a,s,n),this.next_interval(l,h,u,f,e),this.next_state(l,h,u,f),l.lapses+=1,this.update_next(l,h,u,f),this.next.get(t)}next_ds(t,i,e,a,s,n,l){t.difficulty=this.algorithm.next_difficulty(s,d.Again),t.stability=this.algorithm.next_forget_stability(s,n,l),i.difficulty=this.algorithm.next_difficulty(s,d.Hard),i.stability=this.algorithm.next_recall_stability(s,n,l,d.Hard),e.difficulty=this.algorithm.next_difficulty(s,d.Good),e.stability=this.algorithm.next_recall_stability(s,n,l,d.Good),a.difficulty=this.algorithm.next_difficulty(s,d.Easy),a.stability=this.algorithm.next_recall_stability(s,n,l,d.Easy)}next_interval(t,i,e,a,s){let n,l,h,u;n=this.algorithm.next_interval(t.stability,s),l=this.algorithm.next_interval(i.stability,s),h=this.algorithm.next_interval(e.stability,s),u=this.algorithm.next_interval(a.stability,s),n=Math.min(n,l),l=Math.max(l,n+1),h=Math.max(h,l+1),u=Math.max(u,h+1),t.scheduled_days=n,t.due=this.review_time.scheduler(n,!0),i.scheduled_days=l,i.due=this.review_time.scheduler(l,!0),e.scheduled_days=h,e.due=this.review_time.scheduler(h,!0),a.scheduled_days=u,a.due=this.review_time.scheduler(u,!0)}next_state(t,i,e,a){t.state=c.Review,i.state=c.Review,e.state=c.Review,a.state=c.Review}update_next(t,i,e,a){const s={card:t,log:this.buildLog(d.Again)},n={card:i,log:super.buildLog(d.Hard)},l={card:e,log:super.buildLog(d.Good)},h={card:a,log:super.buildLog(d.Easy)};this.next.set(d.Again,s),this.next.set(d.Hard,n),this.next.set(d.Good,l),this.next.set(d.Easy,h)}}class W{constructor(t){_(this,"fsrs");this.fsrs=t}replay(t,i,e){return this.fsrs.next(t,i,e)}handleManualRating(t,i,e,a,s,n,l){if(typeof i>"u")throw new Error("reschedule: state is required for manual rating");let h,u;if(i===c.New)h={rating:d.Manual,state:i,due:l??e,stability:t.stability,difficulty:t.difficulty,elapsed_days:a,last_elapsed_days:t.elapsed_days,scheduled_days:t.scheduled_days,review:e},u=E(e),u.last_review=e;else{if(typeof l>"u")throw new Error("reschedule: due is required for manual rating");const f=l.diff(e,"days");h={rating:d.Manual,state:t.state,due:t.last_review||t.due,stability:t.stability,difficulty:t.difficulty,elapsed_days:a,last_elapsed_days:t.elapsed_days,scheduled_days:t.scheduled_days,review:e},u={...t,state:i,due:l,last_review:e,stability:s||t.stability,difficulty:n||t.difficulty,elapsed_days:a,scheduled_days:f,reps:t.reps+1}}return{card:u,log:h}}reschedule(t,i){const e=[];let a=E(t.due);for(const s of i){let n;if(s.review=o.time(s.review),s.rating===d.Manual){let l=0;a.state!==c.New&&a.last_review&&(l=s.review.diff(a.last_review,"days")),n=this.handleManualRating(a,s.state,s.review,l,s.stability,s.difficulty,s.due?o.time(s.due):void 0)}else n=this.replay(a,s.review,s.rating);e.push(n),a=n.card}return e}calculateManualRecord(t,i,e,a){if(!e)return null;const{card:s,log:n}=e,l=o.card(t);return l.due.getTime()===s.due.getTime()?null:(l.scheduled_days=s.due.diff(l.due,"days"),this.handleManualRating(l,s.state,o.time(i),n.elapsed_days,a?s.stability:void 0,a?s.difficulty:void 0,s.due))}}class Y extends Q{constructor(i){super(i);_(this,"Scheduler");const{enable_short_term:e}=this.parameters;this.Scheduler=e?L:H}params_handler_proxy(){const i=this;return{set:function(e,a,s){return a==="request_retention"&&Number.isFinite(s)?i.intervalModifier=i.calculate_interval_modifier(Number(s)):a==="enable_short_term"&&(i.Scheduler=s===!0?L:H),Reflect.set(e,a,s),!0}}}repeat(i,e,a){const s=this.Scheduler,n=new s(i,e,this).preview();return a&&typeof a=="function"?a(n):n}next(i,e,a,s){const n=this.Scheduler,l=new n(i,e,this),h=o.rating(a);if(h===d.Manual)throw new Error("Cannot review a manual rating");const u=l.review(h);return s&&typeof s=="function"?s(u):u}get_retrievability(i,e,a=!0){const s=o.card(i);e=e?o.time(e):new Date;const n=s.state!==c.New?Math.max(e.diff(s.last_review,"days"),0):0,l=s.state!==c.New?this.forgetting_curve(n,+s.stability.toFixed(8)):0;return a?`${(l*100).toFixed(2)}%`:l}rollback(i,e,a){const s=o.card(i),n=o.review_log(e);if(n.rating===d.Manual)throw new Error("Cannot rollback a manual rating");let l,h,u;switch(n.state){case c.New:l=n.due,h=void 0,u=0;break;case c.Learning:case c.Relearning:case c.Review:l=n.review,h=n.due,u=s.lapses-(n.rating===d.Again&&n.state===c.Review?1:0);break}const f={...s,due:l,stability:n.stability,difficulty:n.difficulty,elapsed_days:n.last_elapsed_days,scheduled_days:n.scheduled_days,reps:Math.max(0,s.reps-1),lapses:Math.max(0,u),state:n.state,last_review:h};return a&&typeof a=="function"?a(f):f}forget(i,e,a=!1,s){const n=o.card(i);e=o.time(e);const l=n.state===c.New?0:e.diff(n.last_review,"days"),h={rating:d.Manual,state:n.state,due:n.due,stability:n.stability,difficulty:n.difficulty,elapsed_days:0,last_elapsed_days:n.elapsed_days,scheduled_days:l,review:e},u={card:{...n,due:e,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:a?0:n.reps,lapses:a?0:n.lapses,state:c.New,last_review:n.last_review},log:h};return s&&typeof s=="function"?s(u):u}reschedule(i,e=[],a={}){const{recordLogHandler:s,reviewsOrderBy:n,skipManual:l=!0,now:h=new Date,update_memory_state:u=!1}=a;n&&typeof n=="function"&&e.sort(n),l&&(e=e.filter(k=>k.rating!==d.Manual));const f=new W(this),y=f.reschedule(a.first_card||E(),e),v=y.length,p=o.card(i),g=f.calculateManualRecord(p,h,v?y[v-1]:void 0,u);return s&&typeof s=="function"?{collections:y.map(s),reschedule_item:g?s(g):null}:{collections:y,reschedule_item:g}}}const Z=r=>new Y(r||{});export{Y as O,Z as W,R as b,d as l,c as u,E as w};
