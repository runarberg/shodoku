import{al as D,am as Va,c as ca,m as H,C as za}from"./index-CvwMh420.js";import{u as Zt,d as E,l as oe,a as Ya}from"./db-CNlb8ZXY.js";function Wa(t){return async e=>{const r=new Map;for await(const n of e){const a=t(n);let i=r.get(a);i||(i=[],r.set(a,i)),i.push(n)}return r}}function le(){return async function(t){const e=[];for await(const r of t)e.push(r);return e}}function X(t,...e){return e.reduce((r,n)=>n(r),t)}function Gt(t){return async function*(e){for await(const r of e)yield t(r)}}function Qa(t){return function*(e){const r=e[Symbol.iterator]();let n=r.next();for(;!n.done&&t(n.value);)n=r.next();try{for(;!n.done;)yield n.value,n=r.next()}finally{typeof r.return=="function"&&r.return()}}}function vr(t){return async function*(e){for await(const r of e)t(r)&&(yield r)}}function pr(t){if(t<0){const e=-t;return async function*(r){const n=[];let a=0;for await(const i of r)n[a]=i,a=(a+1)%e;for(let i=0;i<n.length;i+=1)yield n[a],a=(a+1)%e}}return async function*(e){let r=0;for await(const n of e){if(r>=t)break;r+=1,yield n}}}class fe extends Error{constructor(e,r){super(e),this.name="DevalueError",this.path=r.join("")}}function gr(t){return Object(t)!==t}const Ja=Object.getOwnPropertyNames(Object.prototype).sort().join("\0");function Xa(t){const e=Object.getPrototypeOf(t);return e===Object.prototype||e===null||Object.getOwnPropertyNames(e).sort().join("\0")===Ja}function Za(t){return Object.prototype.toString.call(t).slice(8,-1)}function ei(t){switch(t){case'"':return'\\"';case"<":return"\\u003C";case"\\":return"\\\\";case`
`:return"\\n";case"\r":return"\\r";case"	":return"\\t";case"\b":return"\\b";case"\f":return"\\f";case"\u2028":return"\\u2028";case"\u2029":return"\\u2029";default:return t<" "?`\\u${t.charCodeAt(0).toString(16).padStart(4,"0")}`:""}}function V(t){let e="",r=0;const n=t.length;for(let a=0;a<n;a+=1){const i=t[a],s=ei(i);s&&(e+=t.slice(r,a)+s,r=a+1)}return`"${r===0?t:e+t.slice(r)}"`}function ti(t){return Object.getOwnPropertySymbols(t).filter(e=>Object.getOwnPropertyDescriptor(t,e).enumerable)}const ri=/^[a-zA-Z_$][a-zA-Z_$0-9]*$/;function wr(t){return ri.test(t)?"."+t:"["+JSON.stringify(t)+"]"}function mr(t){const e=new DataView(t);let r="";for(let n=0;n<t.byteLength;n++)r+=String.fromCharCode(e.getUint8(n));return ai(r)}function br(t){const e=ni(t),r=new ArrayBuffer(e.length),n=new DataView(r);for(let a=0;a<r.byteLength;a++)n.setUint8(a,e.charCodeAt(a));return r}const la="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function ni(t){t.length%4===0&&(t=t.replace(/==?$/,""));let e="",r=0,n=0;for(let a=0;a<t.length;a++)r<<=6,r|=la.indexOf(t[a]),n+=6,n===24&&(e+=String.fromCharCode((r&16711680)>>16),e+=String.fromCharCode((r&65280)>>8),e+=String.fromCharCode(r&255),r=n=0);return n===12?(r>>=4,e+=String.fromCharCode(r)):n===18&&(r>>=2,e+=String.fromCharCode((r&65280)>>8),e+=String.fromCharCode(r&255)),e}function ai(t){let e="";for(let r=0;r<t.length;r+=3){const n=[void 0,void 0,void 0,void 0];n[0]=t.charCodeAt(r)>>2,n[1]=(t.charCodeAt(r)&3)<<4,t.length>r+1&&(n[1]|=t.charCodeAt(r+1)>>4,n[2]=(t.charCodeAt(r+1)&15)<<2),t.length>r+2&&(n[2]|=t.charCodeAt(r+2)>>6,n[3]=t.charCodeAt(r+2)&63);for(let a=0;a<n.length;a++)typeof n[a]>"u"?e+="=":e+=la[n[a]]}return e}const er=-1,fa=-2,da=-3,ha=-4,ya=-5,tr=-6;function de(t,e){return ii(JSON.parse(t))}function ii(t,e){if(typeof t=="number")return a(t,!0);if(!Array.isArray(t)||t.length===0)throw new Error("Invalid input");const r=t,n=Array(r.length);function a(i,s=!1){if(i===er)return;if(i===da)return NaN;if(i===ha)return 1/0;if(i===ya)return-1/0;if(i===tr)return-0;if(s)throw new Error("Invalid input");if(i in n)return n[i];const o=r[i];if(!o||typeof o!="object")n[i]=o;else if(Array.isArray(o))if(typeof o[0]=="string"){const c=o[0];switch(c){case"Date":n[i]=new Date(o[1]);break;case"Set":const u=new Set;n[i]=u;for(let d=1;d<o.length;d+=1)u.add(a(o[d]));break;case"Map":const f=new Map;n[i]=f;for(let d=1;d<o.length;d+=2)f.set(a(o[d]),a(o[d+1]));break;case"RegExp":n[i]=new RegExp(o[1],o[2]);break;case"Object":n[i]=Object(o[1]);break;case"BigInt":n[i]=BigInt(o[1]);break;case"null":const l=Object.create(null);n[i]=l;for(let d=1;d<o.length;d+=2)l[o[d]]=a(o[d+1]);break;case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"BigInt64Array":case"BigUint64Array":{const d=globalThis[c],h=o[1],y=br(h),b=new d(y);n[i]=b;break}case"ArrayBuffer":{const d=o[1],h=br(d);n[i]=h;break}default:throw new Error(`Unknown type ${c}`)}}else{const c=new Array(o.length);n[i]=c;for(let u=0;u<o.length;u+=1){const f=o[u];f!==fa&&(c[u]=a(f))}}else{const c={};n[i]=c;for(const u in o){const f=o[u];c[u]=a(f)}}return n[i]}return a(0)}function Z(t,e){const r=[],n=new Map,a=[],i=[];let s=0;function o(u){if(typeof u=="function")throw new fe("Cannot stringify a function",i);if(n.has(u))return n.get(u);if(u===void 0)return er;if(Number.isNaN(u))return da;if(u===1/0)return ha;if(u===-1/0)return ya;if(u===0&&1/u<0)return tr;const f=s++;n.set(u,f);for(const{key:d,fn:h}of a){const y=h(u);if(y)return r[f]=`["${d}",${o(y)}]`,f}let l="";if(gr(u))l=he(u);else{const d=Za(u);switch(d){case"Number":case"String":case"Boolean":l=`["Object",${he(u)}]`;break;case"BigInt":l=`["BigInt",${u}]`;break;case"Date":l=`["Date","${!isNaN(u.getDate())?u.toISOString():""}"]`;break;case"RegExp":const{source:y,flags:b}=u;l=b?`["RegExp",${V(y)},"${b}"]`:`["RegExp",${V(y)}]`;break;case"Array":l="[";for(let v=0;v<u.length;v+=1)v>0&&(l+=","),v in u?(i.push(`[${v}]`),l+=o(u[v]),i.pop()):l+=fa;l+="]";break;case"Set":l='["Set"';for(const v of u)l+=`,${o(v)}`;l+="]";break;case"Map":l='["Map"';for(const[v,_]of u)i.push(`.get(${gr(v)?he(v):"..."})`),l+=`,${o(v)},${o(_)}`,i.pop();l+="]";break;case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"BigInt64Array":case"BigUint64Array":{const _=mr(u.buffer);l='["'+d+'","'+_+'"]';break}case"ArrayBuffer":{l=`["ArrayBuffer","${mr(u)}"]`;break}default:if(!Xa(u))throw new fe("Cannot stringify arbitrary non-POJOs",i);if(ti(u).length>0)throw new fe("Cannot stringify POJOs with symbolic keys",i);if(Object.getPrototypeOf(u)===null){l='["null"';for(const v in u)i.push(wr(v)),l+=`,${V(v)},${o(u[v])}`,i.pop();l+="]"}else{l="{";let v=!1;for(const _ in u)v&&(l+=","),v=!0,i.push(wr(_)),l+=`${V(_)}:${o(u[_])}`,i.pop();l+="}"}}}return r[f]=l,f}const c=o(t);return c<0?`${c}`:`[${r.join(",")}]`}function he(t){const e=typeof t;return e==="string"?V(t):t instanceof String?V(t.toString()):t===void 0?er.toString():t===0&&1/t<0?tr.toString():e==="bigint"?`["BigInt","${t}"]`:String(t)}const K="shodoku.app.config.sync.remote",si=D(`${K}.fetch.method`,"GET"),oi=D(`${K}.fetch.url`,""),ui=D(`${K}.fetch.headers`,[]),ci=D(`${K}.push.method`,"PUT"),li=D(`${K}.push.url`,""),fi=D(`${K}.push.headers`,[]),va=D(`${K}.push.body`,void 0);function fo(){return Zt(async()=>await(await E).count("syncs")>0)}function ho(){return Zt(async()=>await(await E).count("sync.staging.stores")>0)}function pa(t){return typeof t!="object"?typeof t:t===null?"null":t.constructor.name}function rr(t,e){return`Expected "${t}" but got "${pa(e)}"`}function nr(t,e,r){return`Expected key "${t}" to be "${e}" but is "${pa(r)}"`}class F extends Error{name="AssertationError";code="ERR_ASSERTION";actual;constructor(e={}){if(e.message)super(e.message);else{let r;"actual"in e&&(r=`Assertion failed with "${e.actual}"`),super(r||"Assertion failed")}this.actual=e.actual}}function ga(t){if(typeof t!="string")throw new F({message:rr("String",t),actual:t})}function ee(t){if(!Array.isArray(t))throw new F({message:rr("Array",t),actual:t})}function wa(t){if(typeof t!="object"||t==null)throw new F({message:rr("Object",t),actual:t})}function ar(t,e){if(!(t in e))throw new F({message:`Expected object to have key "${String(t)}" but none found`,actual:e})}function L(t,e,{optional:r=!1,nullable:n=!1}={}){if(!(r&&!(t in e))&&(ar(t,e),typeof e[t]!="string")){if(n&&e[t]===null||r&&typeof e[t]>"u")return;throw new F({message:nr(String(t),"String",e[t]),actual:e})}}function _r(t,e,{optional:r=!1,nullable:n=!1}={}){if(!(r&&!(t in e))&&(ar(t,e),typeof e[t]!="number")){if(n&&e[t]===null||r&&typeof e[t]>"u")return;throw new F({message:nr(String(t),"Number",e[t]),actual:e})}}function se(t,e,{optional:r=!1,nullable:n=!1}={}){if(!(r&&!(t in e))&&(ar(t,e),!Array.isArray(e[t]))){if(n&&e[t]===null||r&&typeof e[t]>"u")return;throw new F({message:nr(String(t),"Array",e[t]),actual:e})}}function ye(t,e,{optional:r=!1,nullable:n=!1}={}){se(t,e,{optional:r,nullable:n});const a=e[t];if(a)for(const i of a)ga(i)}var Sr=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Ir={},Ar={},Q,Or;function x(){if(Or)return Q;Or=1;var t=function(e){return e&&e.Math===Math&&e};return Q=t(typeof globalThis=="object"&&globalThis)||t(typeof window=="object"&&window)||t(typeof self=="object"&&self)||t(typeof Sr=="object"&&Sr)||t(typeof Q=="object"&&Q)||function(){return this}()||Function("return this")(),Q}var ve={},pe,Er;function k(){return Er||(Er=1,pe=function(t){try{return!!t()}catch{return!0}}),pe}var ge,Rr;function G(){if(Rr)return ge;Rr=1;var t=k();return ge=!t(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!==7}),ge}var we,xr;function ma(){if(xr)return we;xr=1;var t=k();return we=!t(function(){var e=(function(){}).bind();return typeof e!="function"||e.hasOwnProperty("prototype")}),we}var me,Tr;function ir(){if(Tr)return me;Tr=1;var t=ma(),e=Function.prototype.call;return me=t?e.bind(e):function(){return e.apply(e,arguments)},me}var be={},Mr;function di(){if(Mr)return be;Mr=1;var t={}.propertyIsEnumerable,e=Object.getOwnPropertyDescriptor,r=e&&!t.call({1:2},1);return be.f=r?function(a){var i=e(this,a);return!!i&&i.enumerable}:t,be}var _e,qr;function ba(){return qr||(qr=1,_e=function(t,e){return{enumerable:!(t&1),configurable:!(t&2),writable:!(t&4),value:e}}),_e}var Se,jr;function P(){if(jr)return Se;jr=1;var t=ma(),e=Function.prototype,r=e.call,n=t&&e.bind.bind(r,r);return Se=t?n:function(a){return function(){return r.apply(a,arguments)}},Se}var Ie,Dr;function sr(){if(Dr)return Ie;Dr=1;var t=P(),e=t({}.toString),r=t("".slice);return Ie=function(n){return r(e(n),8,-1)},Ie}var Ae,Pr;function hi(){if(Pr)return Ae;Pr=1;var t=P(),e=k(),r=sr(),n=Object,a=t("".split);return Ae=e(function(){return!n("z").propertyIsEnumerable(0)})?function(i){return r(i)==="String"?a(i,""):n(i)}:n,Ae}var Oe,Cr;function _a(){return Cr||(Cr=1,Oe=function(t){return t==null}),Oe}var Ee,Br;function Sa(){if(Br)return Ee;Br=1;var t=_a(),e=TypeError;return Ee=function(r){if(t(r))throw new e("Can't call method on "+r);return r},Ee}var Re,Nr;function or(){if(Nr)return Re;Nr=1;var t=hi(),e=Sa();return Re=function(r){return t(e(r))},Re}var xe,Fr;function N(){if(Fr)return xe;Fr=1;var t=typeof document=="object"&&document.all;return xe=typeof t>"u"&&t!==void 0?function(e){return typeof e=="function"||e===t}:function(e){return typeof e=="function"},xe}var Te,$r;function W(){if($r)return Te;$r=1;var t=N();return Te=function(e){return typeof e=="object"?e!==null:t(e)},Te}var Me,Lr;function Ia(){if(Lr)return Me;Lr=1;var t=x(),e=N(),r=function(n){return e(n)?n:void 0};return Me=function(n,a){return arguments.length<2?r(t[n]):t[n]&&t[n][a]},Me}var qe,kr;function yi(){if(kr)return qe;kr=1;var t=P();return qe=t({}.isPrototypeOf),qe}var je,Ur;function vi(){if(Ur)return je;Ur=1;var t=x(),e=t.navigator,r=e&&e.userAgent;return je=r?String(r):"",je}var De,Kr;function pi(){if(Kr)return De;Kr=1;var t=x(),e=vi(),r=t.process,n=t.Deno,a=r&&r.versions||n&&n.version,i=a&&a.v8,s,o;return i&&(s=i.split("."),o=s[0]>0&&s[0]<4?1:+(s[0]+s[1])),!o&&e&&(s=e.match(/Edge\/(\d+)/),(!s||s[1]>=74)&&(s=e.match(/Chrome\/(\d+)/),s&&(o=+s[1]))),De=o,De}var Pe,Gr;function Aa(){if(Gr)return Pe;Gr=1;var t=pi(),e=k(),r=x(),n=r.String;return Pe=!!Object.getOwnPropertySymbols&&!e(function(){var a=Symbol("symbol detection");return!n(a)||!(Object(a)instanceof Symbol)||!Symbol.sham&&t&&t<41}),Pe}var Ce,Hr;function Oa(){if(Hr)return Ce;Hr=1;var t=Aa();return Ce=t&&!Symbol.sham&&typeof Symbol.iterator=="symbol",Ce}var Be,Vr;function Ea(){if(Vr)return Be;Vr=1;var t=Ia(),e=N(),r=yi(),n=Oa(),a=Object;return Be=n?function(i){return typeof i=="symbol"}:function(i){var s=t("Symbol");return e(s)&&r(s.prototype,a(i))},Be}var Ne,zr;function gi(){if(zr)return Ne;zr=1;var t=String;return Ne=function(e){try{return t(e)}catch{return"Object"}},Ne}var Fe,Yr;function Ra(){if(Yr)return Fe;Yr=1;var t=N(),e=gi(),r=TypeError;return Fe=function(n){if(t(n))return n;throw new r(e(n)+" is not a function")},Fe}var $e,Wr;function wi(){if(Wr)return $e;Wr=1;var t=Ra(),e=_a();return $e=function(r,n){var a=r[n];return e(a)?void 0:t(a)},$e}var Le,Qr;function mi(){if(Qr)return Le;Qr=1;var t=ir(),e=N(),r=W(),n=TypeError;return Le=function(a,i){var s,o;if(i==="string"&&e(s=a.toString)&&!r(o=t(s,a))||e(s=a.valueOf)&&!r(o=t(s,a))||i!=="string"&&e(s=a.toString)&&!r(o=t(s,a)))return o;throw new n("Can't convert object to primitive value")},Le}var ke={exports:{}},Ue,Jr;function bi(){return Jr||(Jr=1,Ue=!1),Ue}var Ke,Xr;function ur(){if(Xr)return Ke;Xr=1;var t=x(),e=Object.defineProperty;return Ke=function(r,n){try{e(t,r,{value:n,configurable:!0,writable:!0})}catch{t[r]=n}return n},Ke}var Zr;function cr(){if(Zr)return ke.exports;Zr=1;var t=bi(),e=x(),r=ur(),n="__core-js_shared__",a=ke.exports=e[n]||r(n,{});return(a.versions||(a.versions=[])).push({version:"3.44.0",mode:t?"pure":"global",copyright:"Â© 2014-2025 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.44.0/LICENSE",source:"https://github.com/zloirock/core-js"}),ke.exports}var Ge,en;function xa(){if(en)return Ge;en=1;var t=cr();return Ge=function(e,r){return t[e]||(t[e]=r||{})},Ge}var He,tn;function _i(){if(tn)return He;tn=1;var t=Sa(),e=Object;return He=function(r){return e(t(r))},He}var Ve,rn;function U(){if(rn)return Ve;rn=1;var t=P(),e=_i(),r=t({}.hasOwnProperty);return Ve=Object.hasOwn||function(a,i){return r(e(a),i)},Ve}var ze,nn;function Ta(){if(nn)return ze;nn=1;var t=P(),e=0,r=Math.random(),n=t(1.1.toString);return ze=function(a){return"Symbol("+(a===void 0?"":a)+")_"+n(++e+r,36)},ze}var Ye,an;function lr(){if(an)return Ye;an=1;var t=x(),e=xa(),r=U(),n=Ta(),a=Aa(),i=Oa(),s=t.Symbol,o=e("wks"),c=i?s.for||s:s&&s.withoutSetter||n;return Ye=function(u){return r(o,u)||(o[u]=a&&r(s,u)?s[u]:c("Symbol."+u)),o[u]},Ye}var We,sn;function Si(){if(sn)return We;sn=1;var t=ir(),e=W(),r=Ea(),n=wi(),a=mi(),i=lr(),s=TypeError,o=i("toPrimitive");return We=function(c,u){if(!e(c)||r(c))return c;var f=n(c,o),l;if(f){if(u===void 0&&(u="default"),l=t(f,c,u),!e(l)||r(l))return l;throw new s("Can't convert object to primitive value")}return u===void 0&&(u="number"),a(c,u)},We}var Qe,on;function Ma(){if(on)return Qe;on=1;var t=Si(),e=Ea();return Qe=function(r){var n=t(r,"string");return e(n)?n:n+""},Qe}var Je,un;function Ii(){if(un)return Je;un=1;var t=x(),e=W(),r=t.document,n=e(r)&&e(r.createElement);return Je=function(a){return n?r.createElement(a):{}},Je}var Xe,cn;function qa(){if(cn)return Xe;cn=1;var t=G(),e=k(),r=Ii();return Xe=!t&&!e(function(){return Object.defineProperty(r("div"),"a",{get:function(){return 7}}).a!==7}),Xe}var ln;function ja(){if(ln)return ve;ln=1;var t=G(),e=ir(),r=di(),n=ba(),a=or(),i=Ma(),s=U(),o=qa(),c=Object.getOwnPropertyDescriptor;return ve.f=t?c:function(f,l){if(f=a(f),l=i(l),o)try{return c(f,l)}catch{}if(s(f,l))return n(!e(r.f,f,l),f[l])},ve}var Ze={},et,fn;function Ai(){if(fn)return et;fn=1;var t=G(),e=k();return et=t&&e(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!==42}),et}var tt,dn;function Da(){if(dn)return tt;dn=1;var t=W(),e=String,r=TypeError;return tt=function(n){if(t(n))return n;throw new r(e(n)+" is not an object")},tt}var hn;function fr(){if(hn)return Ze;hn=1;var t=G(),e=qa(),r=Ai(),n=Da(),a=Ma(),i=TypeError,s=Object.defineProperty,o=Object.getOwnPropertyDescriptor,c="enumerable",u="configurable",f="writable";return Ze.f=t?r?function(d,h,y){if(n(d),h=a(h),n(y),typeof d=="function"&&h==="prototype"&&"value"in y&&f in y&&!y[f]){var b=o(d,h);b&&b[f]&&(d[h]=y.value,y={configurable:u in y?y[u]:b[u],enumerable:c in y?y[c]:b[c],writable:!1})}return s(d,h,y)}:s:function(d,h,y){if(n(d),h=a(h),n(y),e)try{return s(d,h,y)}catch{}if("get"in y||"set"in y)throw new i("Accessors not supported");return"value"in y&&(d[h]=y.value),d},Ze}var rt,yn;function Pa(){if(yn)return rt;yn=1;var t=G(),e=fr(),r=ba();return rt=t?function(n,a,i){return e.f(n,a,r(1,i))}:function(n,a,i){return n[a]=i,n},rt}var nt={exports:{}},at,vn;function Oi(){if(vn)return at;vn=1;var t=G(),e=U(),r=Function.prototype,n=t&&Object.getOwnPropertyDescriptor,a=e(r,"name"),i=a&&(function(){}).name==="something",s=a&&(!t||t&&n(r,"name").configurable);return at={EXISTS:a,PROPER:i,CONFIGURABLE:s},at}var it,pn;function Ei(){if(pn)return it;pn=1;var t=P(),e=N(),r=cr(),n=t(Function.toString);return e(r.inspectSource)||(r.inspectSource=function(a){return n(a)}),it=r.inspectSource,it}var st,gn;function Ri(){if(gn)return st;gn=1;var t=x(),e=N(),r=t.WeakMap;return st=e(r)&&/native code/.test(String(r)),st}var ot,wn;function xi(){if(wn)return ot;wn=1;var t=xa(),e=Ta(),r=t("keys");return ot=function(n){return r[n]||(r[n]=e(n))},ot}var ut,mn;function Ca(){return mn||(mn=1,ut={}),ut}var ct,bn;function Ti(){if(bn)return ct;bn=1;var t=Ri(),e=x(),r=W(),n=Pa(),a=U(),i=cr(),s=xi(),o=Ca(),c="Object already initialized",u=e.TypeError,f=e.WeakMap,l,d,h,y=function(g){return h(g)?d(g):l(g,{})},b=function(g){return function(w){var I;if(!r(w)||(I=d(w)).type!==g)throw new u("Incompatible receiver, "+g+" required");return I}};if(t||i.state){var v=i.state||(i.state=new f);v.get=v.get,v.has=v.has,v.set=v.set,l=function(g,w){if(v.has(g))throw new u(c);return w.facade=g,v.set(g,w),w},d=function(g){return v.get(g)||{}},h=function(g){return v.has(g)}}else{var _=s("state");o[_]=!0,l=function(g,w){if(a(g,_))throw new u(c);return w.facade=g,n(g,_,w),w},d=function(g){return a(g,_)?g[_]:{}},h=function(g){return a(g,_)}}return ct={set:l,get:d,has:h,enforce:y,getterFor:b},ct}var _n;function Mi(){if(_n)return nt.exports;_n=1;var t=P(),e=k(),r=N(),n=U(),a=G(),i=Oi().CONFIGURABLE,s=Ei(),o=Ti(),c=o.enforce,u=o.get,f=String,l=Object.defineProperty,d=t("".slice),h=t("".replace),y=t([].join),b=a&&!e(function(){return l(function(){},"length",{value:8}).length!==8}),v=String(String).split("String"),_=nt.exports=function(g,w,I){d(f(w),0,7)==="Symbol("&&(w="["+h(f(w),/^Symbol\(([^)]*)\).*$/,"$1")+"]"),I&&I.getter&&(w="get "+w),I&&I.setter&&(w="set "+w),(!n(g,"name")||i&&g.name!==w)&&(a?l(g,"name",{value:w,configurable:!0}):g.name=w),b&&I&&n(I,"arity")&&g.length!==I.arity&&l(g,"length",{value:I.arity});try{I&&n(I,"constructor")&&I.constructor?a&&l(g,"prototype",{writable:!1}):g.prototype&&(g.prototype=void 0)}catch{}var A=c(g);return n(A,"source")||(A.source=y(v,typeof w=="string"?w:"")),g};return Function.prototype.toString=_(function(){return r(this)&&u(this).source||s(this)},"toString"),nt.exports}var lt,Sn;function qi(){if(Sn)return lt;Sn=1;var t=N(),e=fr(),r=Mi(),n=ur();return lt=function(a,i,s,o){o||(o={});var c=o.enumerable,u=o.name!==void 0?o.name:i;if(t(s)&&r(s,u,o),o.global)c?a[i]=s:n(i,s);else{try{o.unsafe?a[i]&&(c=!0):delete a[i]}catch{}c?a[i]=s:e.f(a,i,{value:s,enumerable:!1,configurable:!o.nonConfigurable,writable:!o.nonWritable})}return a},lt}var ft={},dt,In;function ji(){if(In)return dt;In=1;var t=Math.ceil,e=Math.floor;return dt=Math.trunc||function(n){var a=+n;return(a>0?e:t)(a)},dt}var ht,An;function Ba(){if(An)return ht;An=1;var t=ji();return ht=function(e){var r=+e;return r!==r||r===0?0:t(r)},ht}var yt,On;function Di(){if(On)return yt;On=1;var t=Ba(),e=Math.max,r=Math.min;return yt=function(n,a){var i=t(n);return i<0?e(i+a,0):r(i,a)},yt}var vt,En;function Pi(){if(En)return vt;En=1;var t=Ba(),e=Math.min;return vt=function(r){var n=t(r);return n>0?e(n,9007199254740991):0},vt}var pt,Rn;function Na(){if(Rn)return pt;Rn=1;var t=Pi();return pt=function(e){return t(e.length)},pt}var gt,xn;function Ci(){if(xn)return gt;xn=1;var t=or(),e=Di(),r=Na(),n=function(a){return function(i,s,o){var c=t(i),u=r(c);if(u===0)return!a&&-1;var f=e(o,u),l;if(a&&s!==s){for(;u>f;)if(l=c[f++],l!==l)return!0}else for(;u>f;f++)if((a||f in c)&&c[f]===s)return a||f||0;return!a&&-1}};return gt={includes:n(!0),indexOf:n(!1)},gt}var wt,Tn;function Bi(){if(Tn)return wt;Tn=1;var t=P(),e=U(),r=or(),n=Ci().indexOf,a=Ca(),i=t([].push);return wt=function(s,o){var c=r(s),u=0,f=[],l;for(l in c)!e(a,l)&&e(c,l)&&i(f,l);for(;o.length>u;)e(c,l=o[u++])&&(~n(f,l)||i(f,l));return f},wt}var mt,Mn;function Ni(){return Mn||(Mn=1,mt=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"]),mt}var qn;function Fi(){if(qn)return ft;qn=1;var t=Bi(),e=Ni(),r=e.concat("length","prototype");return ft.f=Object.getOwnPropertyNames||function(a){return t(a,r)},ft}var bt={},jn;function $i(){return jn||(jn=1,bt.f=Object.getOwnPropertySymbols),bt}var _t,Dn;function Li(){if(Dn)return _t;Dn=1;var t=Ia(),e=P(),r=Fi(),n=$i(),a=Da(),i=e([].concat);return _t=t("Reflect","ownKeys")||function(o){var c=r.f(a(o)),u=n.f;return u?i(c,u(o)):c},_t}var St,Pn;function ki(){if(Pn)return St;Pn=1;var t=U(),e=Li(),r=ja(),n=fr();return St=function(a,i,s){for(var o=e(i),c=n.f,u=r.f,f=0;f<o.length;f++){var l=o[f];!t(a,l)&&!(s&&t(s,l))&&c(a,l,u(i,l))}},St}var It,Cn;function Ui(){if(Cn)return It;Cn=1;var t=k(),e=N(),r=/#|\.prototype\./,n=function(c,u){var f=i[a(c)];return f===o?!0:f===s?!1:e(u)?t(u):!!u},a=n.normalize=function(c){return String(c).replace(r,".").toLowerCase()},i=n.data={},s=n.NATIVE="N",o=n.POLYFILL="P";return It=n,It}var At,Bn;function Fa(){if(Bn)return At;Bn=1;var t=x(),e=ja().f,r=Pa(),n=qi(),a=ur(),i=ki(),s=Ui();return At=function(o,c){var u=o.target,f=o.global,l=o.stat,d,h,y,b,v,_;if(f?h=t:l?h=t[u]||a(u,{}):h=t[u]&&t[u].prototype,h)for(y in c){if(v=c[y],o.dontCallGetSet?(_=e(h,y),b=_&&_.value):b=h[y],d=s(f?y:u+(l?".":"#")+y,o.forced),!d&&b!==void 0){if(typeof v==typeof b)continue;i(v,b)}(o.sham||b&&b.sham)&&r(v,"sham",!0),n(h,y,v,o)}},At}var Ot,Nn;function Ki(){if(Nn)return Ot;Nn=1;var t=Na();return Ot=function(e,r,n){for(var a=0,i=arguments.length>2?n:t(r),s=new e(i);i>a;)s[a]=r[a++];return s},Ot}var Et,Fn;function $a(){if(Fn)return Et;Fn=1;var t=W(),e=String,r=TypeError;return Et=function(n){if(n===void 0||t(n))return n;throw new r(e(n)+" is not an object or undefined")},Et}var Rt,$n;function Gi(){if($n)return Rt;$n=1;var t=TypeError;return Rt=function(e){if(typeof e=="string")return e;throw new t("Argument is not a string")},Rt}var xt,Ln;function La(){if(Ln)return xt;Ln=1;var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=t+"+/",r=t+"-_",n=function(a){for(var i={},s=0;s<64;s++)i[a.charAt(s)]=s;return i};return xt={i2c:e,c2i:n(e),i2cUrl:r,c2iUrl:n(r)},xt}var Tt,kn;function ka(){if(kn)return Tt;kn=1;var t=TypeError;return Tt=function(e){var r=e&&e.alphabet;if(r===void 0||r==="base64"||r==="base64url")return r||"base64";throw new t("Incorrect `alphabet` option")},Tt}var Mt,Un;function Hi(){return Un||(Un=1,Mt=typeof ArrayBuffer<"u"&&typeof DataView<"u"),Mt}var qt,Kn;function Vi(){if(Kn)return qt;Kn=1;var t=P(),e=Ra();return qt=function(r,n,a){try{return t(e(Object.getOwnPropertyDescriptor(r,n)[a]))}catch{}},qt}var jt,Gn;function zi(){if(Gn)return jt;Gn=1;var t=x(),e=Vi(),r=sr(),n=t.ArrayBuffer,a=t.TypeError;return jt=n&&e(n.prototype,"byteLength","get")||function(i){if(r(i)!=="ArrayBuffer")throw new a("ArrayBuffer expected");return i.byteLength},jt}var Dt,Hn;function Yi(){if(Hn)return Dt;Hn=1;var t=x(),e=Hi(),r=zi(),n=t.DataView;return Dt=function(a){if(!e||r(a)!==0)return!1;try{return new n(a),!1}catch{return!0}},Dt}var Pt,Vn;function Ua(){if(Vn)return Pt;Vn=1;var t=Yi(),e=TypeError;return Pt=function(r){if(t(r))throw new e("ArrayBuffer is detached");return r},Pt}var Ct,zn;function Wi(){if(zn)return Ct;zn=1;var t=x(),e=P(),r=$a(),n=Gi(),a=U(),i=La(),s=ka(),o=Ua(),c=i.c2i,u=i.c2iUrl,f=t.SyntaxError,l=t.TypeError,d=e("".charAt),h=function(v,_){for(var g=v.length;_<g;_++){var w=d(v,_);if(w!==" "&&w!=="	"&&w!==`
`&&w!=="\f"&&w!=="\r")break}return _},y=function(v,_,g){var w=v.length;w<4&&(v+=w===2?"AA":"A");var I=(_[d(v,0)]<<18)+(_[d(v,1)]<<12)+(_[d(v,2)]<<6)+_[d(v,3)],A=[I>>16&255,I>>8&255,I&255];if(w===2){if(g&&A[1]!==0)throw new f("Extra bits");return[A[0]]}if(w===3){if(g&&A[2]!==0)throw new f("Extra bits");return[A[0],A[1]]}return A},b=function(v,_,g){for(var w=_.length,I=0;I<w;I++)v[g+I]=_[I];return g+w};return Ct=function(v,_,g,w){n(v),r(_);var I=s(_)==="base64"?c:u,A=_?_.lastChunkHandling:void 0;if(A===void 0&&(A="loose"),A!=="loose"&&A!=="strict"&&A!=="stop-before-partial")throw new l("Incorrect `lastChunkHandling` option");g&&o(g.buffer);var R=g||[],O=0,j=0,q="",M=0;if(w)for(;;){if(M=h(v,M),M===v.length){if(q.length>0){if(A==="stop-before-partial")break;if(A==="loose"){if(q.length===1)throw new f("Malformed padding: exactly one additional character");O=b(R,y(q,I,!1),O)}else throw new f("Missing padding")}j=v.length;break}var ce=d(v,M);if(++M,ce==="="){if(q.length<2)throw new f("Padding is too early");if(M=h(v,M),q.length===2){if(M===v.length){if(A==="stop-before-partial")break;throw new f("Malformed padding: only one =")}d(v,M)==="="&&(++M,M=h(v,M))}if(M<v.length)throw new f("Unexpected character after padding");O=b(R,y(q,I,A==="strict"),O),j=v.length;break}if(!a(I,ce))throw new f("Unexpected character");var yr=w-O;if(yr===1&&q.length===2||yr===2&&q.length===3||(q+=ce,q.length===4&&(O=b(R,y(q,I,!1),O),q="",j=M,O===w)))break}return{bytes:R,read:j,written:O}},Ct}var Yn;function Qi(){if(Yn)return Ar;Yn=1;var t=Fa(),e=x(),r=Ki(),n=Wi(),a=e.Uint8Array,i=!a||!a.fromBase64||!function(){try{a.fromBase64("",null)}catch{return!0}}();return a&&t({target:"Uint8Array",stat:!0,forced:i},{fromBase64:function(o){var c=n(o,arguments.length>1?arguments[1]:void 0,null,9007199254740991);return r(a,c.bytes)}}),Ar}var Wn;function Ji(){return Wn||(Wn=1,Qi()),Ir}Ji();var Qn={},Jn={},Bt,Xn;function Xi(){if(Xn)return Bt;Xn=1;var t=lr(),e=t("toStringTag"),r={};return r[e]="z",Bt=String(r)==="[object z]",Bt}var Nt,Zn;function Zi(){if(Zn)return Nt;Zn=1;var t=Xi(),e=N(),r=sr(),n=lr(),a=n("toStringTag"),i=Object,s=r(function(){return arguments}())==="Arguments",o=function(c,u){try{return c[u]}catch{}};return Nt=t?r:function(c){var u,f,l;return c===void 0?"Undefined":c===null?"Null":typeof(f=o(u=i(c),a))=="string"?f:s?r(u):(l=r(u))==="Object"&&e(u.callee)?"Arguments":l},Nt}var Ft,ea;function es(){if(ea)return Ft;ea=1;var t=Zi(),e=TypeError;return Ft=function(r){if(t(r)==="Uint8Array")return r;throw new e("Argument is not an Uint8Array")},Ft}var ta;function ts(){if(ta)return Jn;ta=1;var t=Fa(),e=x(),r=P(),n=$a(),a=es(),i=Ua(),s=La(),o=ka(),c=s.i2c,u=s.i2cUrl,f=r("".charAt),l=e.Uint8Array,d=!l||!l.prototype.toBase64||!function(){try{var h=new l;h.toBase64(null)}catch{return!0}}();return l&&t({target:"Uint8Array",proto:!0,forced:d},{toBase64:function(){var y=a(this),b=arguments.length?n(arguments[0]):void 0,v=o(b)==="base64"?c:u,_=!!b&&!!b.omitPadding;i(this.buffer);for(var g="",w=0,I=y.length,A,R=function(O){return f(v,A>>6*O&63)};w+2<I;w+=3)A=(y[w]<<16)+(y[w+1]<<8)+y[w+2],g+=R(3)+R(2)+R(1)+R(0);return w+2===I?(A=(y[w]<<16)+(y[w+1]<<8),g+=R(3)+R(2)+R(1)+(_?"":"=")):w+1===I&&(A=y[w]<<16,g+=R(3)+R(2)+(_?"":"==")),g}}),Jn}var ra;function rs(){return ra||(ra=1,ts()),Qn}rs();const ns=new RegExp("\\p{Script=Han}","u"),as=new RegExp("^\\p{Script=Han}$","u"),is=/[\p{Script=Hiragana}\p{Script=Katakana}\p{Script=Han}\u{2e80}-\u{2fd5}\u{3000}-\u{303f}\u{31f0}-\u{31ff}\u{3220}-\u{3243}\u{3280}-\u{337f}\u{ff5f}-\u{ff9f}\u{ff01}-\u{ff5e}]/u;function yo(t){return is.test(t)}function vo(t){return ns.test(t)}function po(t){return as.test(t)}function ss(t){return new TextDecoder().decode(Uint8Array.fromBase64(t))}function os(t){return new TextEncoder().encode(t).toBase64()}const Ht=["bookmarked-words","cards","decks","progress","reviews"],us="${PLACEHOLDER}";function cs(t){if(!Ht.includes(t))throw new F({actual:t,message:`Expected "${t}" to be a store name`})}function ls(t,e){se(t,e);for(const r of e[t]){wa(r),L("name",r),cs(r.name),ye("add",r,{optional:!0}),se("set",r,{optional:!0});for(const n of r.set??[]){if(ee(n),n.length!==2)throw new F({actual:n,message:`Excpected a 2-tuple. Got ${n.length}-tuple`});ga(n[0]),ee(n[1]);for(const a of n[1]){if(ee(a),a.length!==3)throw new F({actual:n,message:`Excpected a 3-tuple. Got ${a.length}-tuple`});L(0,a),ye(1,a),L(2,a)}}ye("delete",r,{optional:!0})}}function fs(t,e){se(t,e);for(const r of e[t])ee(r),L(0,r),L(1,r,{nullable:!0})}async function ds(){const t=si.value,e=URL.parse(oi.value),r=new Headers(ui.value);if(!e)throw new Error("Remote sync not set up");e.host==="gist.githubusercontent.com"&&e.searchParams.set("cachebuster",new Date().toISOString());const a=await fetch(e,{method:t,headers:r,mode:"cors"}),i=await a.text();if(!a.ok)throw new Error(`Error ${a.status} fetching sync: ${i}`);if(!i.trim())return[];const s=va.value,o=JSON.parse(s?ss(i):i);return ee(o),o.map(c=>(wa(c),L("hash",c),L("parent",c,{nullable:!0}),L("syncedAt",c),_r("dbVersion",c),_r("patchVersion",c),ls("stores",c),fs("preferences",c),{...c,syncedAt:new Date(c.syncedAt)}))}async function hs(t){const e=ci.value,r=URL.parse(li.value),n=new Headers(fi.value),a=va.value;if(!r)throw new Error("Remote sync not set up");let i=JSON.stringify(t);a&&(i=a.replace(us,os(i)));const s=await fetch(r,{method:e,headers:n,body:i,mode:"cors"});if(!s.ok)throw new Error(`Error ${s.status} pushing sync: ${await s.text()}`)}const $="shodoku.app.sync.latest",ys=1;async function vs(t){const e=JSON.stringify(t),r=new TextEncoder().encode(e),n=await crypto.subtle.digest("SHA-256",r);return Array.from(new Uint8Array(n)).map(i=>i.toString(16).padStart(2,"0")).join("")}async function ps(t){const e={...t,parent:localStorage.getItem($)};return{...e,hash:await vs(e)}}async function gs(){const t=await E,e=t.transaction(Ht),r=[];for(const n of Ht){const a=e.objectStore(n),i=await a.getAll();if(i.length===0)continue;const s=i.map(o=>{if(a.autoIncrement&&typeof a.keyPath=="string"){const c=a.keyPath;delete o[c]}return Z(o)});r.push({name:n,add:s})}return r.length===0?null:{syncedAt:new Date,dbVersion:t.version,patchVersion:ys,stores:r,preferences:[]}}async function ws(){const t=await E;if(await t.count("syncs")===0&&localStorage.getItem($)&&localStorage.removeItem($),!localStorage.getItem($))return gs();const e=t.transaction(t.objectStoreNames),r=await X(e.objectStore("sync.staging.stores").iterate(),Gt(a=>a.value),Wa(a=>a.store));if(r.size===0)return null;const n=[];for(const[a,i]of r){const s=[],o=[],c=[];for(const f of i)if(f.op==="add"){const l=e.objectStore(a),d=await l.get(f.key);if(!d)continue;if(l.autoIncrement&&typeof l.keyPath=="string"){const h=l.keyPath;delete d[h]}s.push(Z(d))}else f.op==="put"?o.push(Z(await e.objectStore(a).get(f.key))):c.push(Z(f.key));const u={name:a};s.length>0&&(u.add=s),o.length>0&&(u.put=o),c.length>0&&(u.delete=c),(u.add||u.put||u.delete)&&n.push(u)}return{syncedAt:new Date,dbVersion:t.version,patchVersion:1,stores:n,preferences:[]}}function Vt(t,e){if(!t)return e;if(Array.isArray(t))return t.map(n=>Vt(n,e));let r=e;for(const n of t.split("."))r=r[n];return r}function ms(t,e){return t.updatedAt?e.updatedAt?t.updatedAt>e.updatedAt:!0:e.updatedAt?!1:t.createdAt>e.createdAt}function bs(t,e){return t.fsrs.last_review?e.fsrs.last_review?t.fsrs.last_review>e.fsrs.last_review:!0:!1}function _s(t,e){return t.log.review>e.log.review}function Ss(t,e){return t.bookmarkedAt>e.bookmarkedAt}function Is(t,e,r){return t==="decks"?ms(e,r):t==="progress"?bs(e,r):t==="reviews"?_s(e,r):t==="bookmarked-words"?Ss(e,r):!0}function As(t,e,r){if(!r)return;const n=r.stores.find(({name:i})=>i===t);if(!n?.add)return;const a=n.add.indexOf(e);a!==-1&&n.add.splice(a,1)}function Os(t,e,r){if(!r)return;const n=r.stores.find(({name:i})=>i===t);if(!n)return;let{put:a}=n;a||(a=[],n.put=a),a.push(e)}function na(t){return t instanceof DOMException&&t.name==="ConstraintError"}async function Es(t,e){const r=await E,n=r.transaction(r.objectStoreNames,"readwrite"),a=localStorage.getItem($)??null;let i;for(const s of X(t,Qa(({parent:o})=>o!==a))){for(const o of s.stores){const c=n.objectStore(o.name);for(const u of o.add??[]){const f=de(u),l=c.add(f),d=Ya(l);d.addEventListener("error",h=>{na(d.error)&&(h.preventDefault(),h.stopPropagation())});try{await l}catch(h){if(na(h)){const y=await c.get(Vt(c.keyPath,f));if(y){const b=Z(y);As(o.name,b,e),Is(o.name,y,f)?Os(o.name,b,e):c.put(f)}}else throw h}}for(const u of o.put??[]){const f=de(u),l=await c.openCursor(Vt(c.keyPath,f));l&&l.update(f)}for(const u of o.delete??[]){const f=de(u);console.log(f),c.delete(f)}}n.objectStore("syncs").add(s),i=s.hash}await n.done,i&&localStorage.setItem($,i)}async function go(){const t=await ds(),e=await ws();if(await Es(t,e),!e)return;const r=await ps(e),a=(await E).transaction(["sync.staging.preferences","sync.staging.stores","syncs"],"readwrite");a.objectStore("sync.staging.stores").clear(),a.objectStore("sync.staging.preferences").clear(),a.objectStore("syncs").add(r),await a.done,localStorage.setItem($,r.hash),oe.postMessage("sync-enabled"),await hs([...t,r])}function Rs(){return localStorage.getItem($)!=null}async function wo(){const e=(await E).transaction(["sync.staging.preferences","sync.staging.stores","syncs"],"readwrite");e.objectStore("sync.staging.stores").clear(),e.objectStore("sync.staging.preferences").clear(),e.objectStore("syncs").clear(),await e.done,localStorage.removeItem($),oe.postMessage("sync-disabled")}async function xs(t){if(!Rs())return;const r=(await E).transaction("sync.staging.stores","readwrite");for(const n of t)r.store.add(n);await r.done}var m=(t=>(t[t.New=0]="New",t[t.Learning=1]="Learning",t[t.Review=2]="Review",t[t.Relearning=3]="Relearning",t))(m||{}),p=(t=>(t[t.Manual=0]="Manual",t[t.Again=1]="Again",t[t.Hard=2]="Hard",t[t.Good=3]="Good",t[t.Easy=4]="Easy",t))(p||{});class S{static card(e){return{...e,state:S.state(e.state),due:S.time(e.due),last_review:e.last_review?S.time(e.last_review):void 0}}static rating(e){if(typeof e=="string"){const r=e.charAt(0).toUpperCase(),n=e.slice(1).toLowerCase(),a=p[`${r}${n}`];if(a===void 0)throw new Error(`Invalid rating:[${e}]`);return a}else if(typeof e=="number")return e;throw new Error(`Invalid rating:[${e}]`)}static state(e){if(typeof e=="string"){const r=e.charAt(0).toUpperCase(),n=e.slice(1).toLowerCase(),a=m[`${r}${n}`];if(a===void 0)throw new Error(`Invalid state:[${e}]`);return a}else if(typeof e=="number")return e;throw new Error(`Invalid state:[${e}]`)}static time(e){if(typeof e=="object"&&e instanceof Date)return e;if(typeof e=="string"){const r=Date.parse(e);if(Number.isNaN(r))throw new Error(`Invalid date:[${e}]`);return new Date(r)}else if(typeof e=="number")return new Date(e);throw new Error(`Invalid date:[${e}]`)}static review_log(e){return{...e,due:S.time(e.due),rating:S.rating(e.rating),state:S.state(e.state),review:S.time(e.review)}}}Date.prototype.scheduler=function(t,e){return C(this,t,e)};Date.prototype.diff=function(t,e){return z(this,t,e)};Date.prototype.format=function(){return Ts(this)};Date.prototype.dueFormat=function(t,e,r){return Ms(this,t,e,r)};function C(t,e,r){return new Date(r?S.time(t).getTime()+e*24*60*60*1e3:S.time(t).getTime()+e*60*1e3)}function z(t,e,r){if(!t||!e)throw new Error("Invalid date");const n=S.time(t).getTime()-S.time(e).getTime();let a=0;switch(r){case"days":a=Math.floor(n/(24*60*60*1e3));break;case"minutes":a=Math.floor(n/(60*1e3));break}return a}function Ts(t){const e=S.time(t),r=e.getFullYear(),n=e.getMonth()+1,a=e.getDate(),i=e.getHours(),s=e.getMinutes(),o=e.getSeconds();return`${r}-${J(n)}-${J(a)} ${J(i)}:${J(s)}:${J(o)}`}function J(t){return t<10?`0${t}`:`${t}`}const $t=[60,60,24,31,12],Lt=["second","min","hour","day","month","year"];function Ms(t,e,r,n=Lt){t=S.time(t),e=S.time(e),n.length!==Lt.length&&(n=Lt);let a=t.getTime()-e.getTime(),i=0;for(a/=1e3,i=0;i<$t.length&&!(a<$t[i]);i++)a/=$t[i];return`${Math.floor(a)}${r?n[i]:""}`}const qs=Object.freeze([p.Again,p.Hard,p.Good,p.Easy]),js=[{start:2.5,end:7,factor:.15},{start:7,end:20,factor:.1},{start:20,end:1/0,factor:.05}];function Ds(t,e,r){let n=1;for(const s of js)n+=s.factor*Math.max(Math.min(t,s.end)-s.start,0);t=Math.min(t,r);let a=Math.max(2,Math.round(t-n));const i=Math.min(Math.round(t+n),r);return t>e&&(a=Math.max(a,e+1)),a=Math.min(a,i),{min_ivl:a,max_ivl:i}}function T(t,e,r){return Math.min(Math.max(t,e),r)}function Ps(t,e){const r=Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()),n=Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate());return Math.floor((n-r)/864e5)}const Cs=t=>{const e=t.slice(-1),r=parseInt(t.slice(0,-1),10);if(Number.isNaN(r)||!Number.isFinite(r)||r<0)throw new Error(`Invalid step value: ${t}`);switch(e){case"m":return r;case"h":return r*60;case"d":return r*1440;default:throw new Error(`Invalid step unit: ${t}, expected m/h/d`)}},Bs=(t,e,r)=>{const n=e===m.Relearning||e===m.Review?t.relearning_steps:t.learning_steps,a=n.length;if(a===0||r>=a)return{};const i=n[0],s=Cs,o=()=>s(i),c=()=>{if(a===1)return Math.round(s(i)*1.5);const h=n[1];return Math.round((s(i)+s(h))/2)},u=h=>h<0||h>=a?null:n[h],f=h=>s(h),l={},d=u(Math.max(0,r));if(e===m.Review)return l[p.Again]={scheduled_minutes:s(d),next_step:0},l;{l[p.Again]={scheduled_minutes:o(),next_step:0},l[p.Hard]={scheduled_minutes:c(),next_step:r};const h=u(r+1);if(h){const y=f(h);y&&(l[p.Good]={scheduled_minutes:Math.round(y),next_step:r+1})}}return l};function Ns(){const t=this.review_time.getTime(),e=this.current.reps,r=this.current.difficulty*this.current.stability;return`${t}_${e}_${r}`}var ue=(t=>(t.SCHEDULER="Scheduler",t.LEARNING_STEPS="LearningSteps",t.SEED="Seed",t))(ue||{});class Ka{last;current;review_time;next=new Map;algorithm;strategies;elapsed_days=0;constructor(e,r,n,a){this.algorithm=n,this.last=S.card(e),this.current=S.card(e),this.review_time=S.time(r),this.strategies=a,this.init()}checkGrade(e){if(!Number.isFinite(e)||e<0||e>4)throw new Error(`Invalid grade "${e}",expected 1-4`)}init(){const{state:e,last_review:r}=this.current;let n=0;e!==m.New&&r&&(n=Ps(r,this.review_time)),this.current.last_review=this.review_time,this.elapsed_days=n,this.current.elapsed_days=n,this.current.reps+=1;let a=Ns;if(this.strategies){const i=this.strategies.get(ue.SEED);i&&(a=i)}this.algorithm.seed=a.call(this)}preview(){return{[p.Again]:this.review(p.Again),[p.Hard]:this.review(p.Hard),[p.Good]:this.review(p.Good),[p.Easy]:this.review(p.Easy),[Symbol.iterator]:this.previewIterator.bind(this)}}*previewIterator(){for(const e of qs)yield this.review(e)}review(e){const{state:r}=this.last;let n;switch(this.checkGrade(e),r){case m.New:n=this.newState(e);break;case m.Learning:case m.Relearning:n=this.learningState(e);break;case m.Review:n=this.reviewState(e);break}return n}buildLog(e){const{last_review:r,due:n,elapsed_days:a}=this.last;return{rating:e,state:this.current.state,due:r||n,stability:this.current.stability,difficulty:this.current.difficulty,elapsed_days:this.elapsed_days,last_elapsed_days:a,scheduled_days:this.current.scheduled_days,learning_steps:this.current.learning_steps,review:this.review_time}}}class Fs{c;s0;s1;s2;constructor(e){const r=$s();this.c=1,this.s0=r(" "),this.s1=r(" "),this.s2=r(" "),e==null&&(e=Date.now()),this.s0-=r(e),this.s0<0&&(this.s0+=1),this.s1-=r(e),this.s1<0&&(this.s1+=1),this.s2-=r(e),this.s2<0&&(this.s2+=1)}next(){const e=2091639*this.s0+this.c*23283064365386963e-26;return this.s0=this.s1,this.s1=this.s2,this.c=e|0,this.s2=e-this.c,this.s2}set state(e){this.c=e.c,this.s0=e.s0,this.s1=e.s1,this.s2=e.s2}get state(){return{c:this.c,s0:this.s0,s1:this.s1,s2:this.s2}}}function $s(){let t=4022871197;return function(r){r=String(r);for(let n=0;n<r.length;n++){t+=r.charCodeAt(n);let a=.02519603282416938*t;t=a>>>0,a-=t,a*=t,t=a>>>0,a-=t,t+=a*4294967296}return(t>>>0)*23283064365386963e-26}}function Ls(t){const e=new Fs(t),r=()=>e.next();return r.int32=()=>e.next()*4294967296|0,r.double=()=>r()+(r()*2097152|0)*11102230246251565e-32,r.state=()=>e.state,r.importState=n=>(e.state=n,r),r}const ks=.9,Us=36500,Ks=!1,Gs=!0,Hs=Object.freeze(["1m","10m"]),Vs=Object.freeze(["10m"]),B=.001,ae=100,aa=.5,zs=.1542,ia=Object.freeze([.212,1.2931,2.3065,8.2956,6.4133,.8334,3.0194,.001,1.8722,.1666,.796,1.4835,.0614,.2629,1.6483,.6014,1.8729,.5425,.0912,.0658,zs]),Ys=2,Ws=t=>[[B,ae],[B,ae],[B,ae],[B,ae],[1,10],[.001,4],[.001,4],[.001,.75],[0,4.5],[0,.8],[.001,3.5],[.001,5],[.001,.25],[.001,.9],[0,4],[0,1],[1,6],[0,t],[0,t],[0,.8],[.1,.8]],dr=(t,e)=>{let r=Ys;if(Math.max(0,e)>1){const a=-(Math.log(t[11])+Math.log(Math.pow(2,t[13])-1)+t[14]*.3)/e;r=T(+a.toFixed(8),.01,2)}return Ws(r).map(([a,i],s)=>T(t[s],a,i))},hr=t=>{if(t===void 0)return[...ia];switch(t.length){case 21:return[...t];case 19:return console.debug("[FSRS-6]auto fill w from 19 to 21 length"),[...t,0,aa];case 17:{const e=[...t];return e[4]=+(e[5]*2+e[4]).toFixed(8),e[5]=+(Math.log(e[5]*3+1)/3).toFixed(8),e[6]=+(e[6]+.5).toFixed(8),console.debug("[FSRS-6]auto fill w from 17 to 21 length"),e.concat([0,0,0,aa])}default:return console.warn("[FSRS]Invalid parameters length, using default parameters"),[...ia]}},sa=t=>{const e=Array.isArray(t?.learning_steps)?t.learning_steps:Hs,r=Array.isArray(t?.relearning_steps)?t.relearning_steps:Vs,n=dr(hr(t?.w),r.length);return{request_retention:t?.request_retention||ks,maximum_interval:t?.maximum_interval||Us,w:n,enable_fuzz:t?.enable_fuzz??Ks,enable_short_term:t?.enable_short_term??Gs,learning_steps:e,relearning_steps:r}};function zt(t,e){return{due:t?S.time(t):new Date,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:0,lapses:0,learning_steps:0,state:m.New,last_review:void 0}}const Ga=t=>{const e=typeof t=="number"?-t:-t[20],r=Math.exp(Math.pow(e,-1)*Math.log(.9))-1;return{decay:e,factor:+r.toFixed(8)}};function Yt(t,e,r){const{decay:n,factor:a}=Ga(t);return+Math.pow(1+a*e/r,n).toFixed(8)}class Qs{param;intervalModifier;_seed;constructor(e){this.param=new Proxy(sa(e),this.params_handler_proxy()),this.intervalModifier=this.calculate_interval_modifier(this.param.request_retention),this.forgetting_curve=Yt.bind(this,this.param.w)}get interval_modifier(){return this.intervalModifier}set seed(e){this._seed=e}calculate_interval_modifier(e){if(e<=0||e>1)throw new Error("Requested retention rate should be in the range (0,1]");const{decay:r,factor:n}=Ga(this.param.w);return+((Math.pow(e,1/r)-1)/n).toFixed(8)}get parameters(){return this.param}set parameters(e){this.update_parameters(e)}params_handler_proxy(){const e=this;return{set:function(r,n,a){return n==="request_retention"&&Number.isFinite(a)?e.intervalModifier=e.calculate_interval_modifier(Number(a)):n==="w"&&(a=dr(hr(a),r.relearning_steps.length),e.forgetting_curve=Yt.bind(this,a),e.intervalModifier=e.calculate_interval_modifier(Number(r.request_retention))),Reflect.set(r,n,a),!0}}}update_parameters(e){const r=sa(e);for(const n in r){const a=n;this.param[a]=r[a]}}init_stability(e){return Math.max(this.param.w[e-1],.1)}init_difficulty(e){return+(this.param.w[4]-Math.exp((e-1)*this.param.w[5])+1).toFixed(8)}apply_fuzz(e,r){if(!this.param.enable_fuzz||e<2.5)return Math.round(e);const a=Ls(this._seed)(),{min_ivl:i,max_ivl:s}=Ds(e,r,this.param.maximum_interval);return Math.floor(a*(s-i+1)+i)}next_interval(e,r){const n=Math.min(Math.max(1,Math.round(e*this.intervalModifier)),this.param.maximum_interval);return this.apply_fuzz(n,r)}linear_damping(e,r){return+(e*(10-r)/9).toFixed(8)}next_difficulty(e,r){const n=-this.param.w[6]*(r-3),a=e+this.linear_damping(n,e);return T(this.mean_reversion(this.init_difficulty(p.Easy),a),1,10)}mean_reversion(e,r){return+(this.param.w[7]*e+(1-this.param.w[7])*r).toFixed(8)}next_recall_stability(e,r,n,a){const i=p.Hard===a?this.param.w[15]:1,s=p.Easy===a?this.param.w[16]:1;return+T(r*(1+Math.exp(this.param.w[8])*(11-e)*Math.pow(r,-this.param.w[9])*(Math.exp((1-n)*this.param.w[10])-1)*i*s),B,36500).toFixed(8)}next_forget_stability(e,r,n){return+T(this.param.w[11]*Math.pow(e,-this.param.w[12])*(Math.pow(r+1,this.param.w[13])-1)*Math.exp((1-n)*this.param.w[14]),B,36500).toFixed(8)}next_short_term_stability(e,r){const n=Math.pow(e,-this.param.w[19])*Math.exp(this.param.w[17]*(r-3+this.param.w[18])),a=r>=3?Math.max(n,1):n;return+T(e*a,B,36500).toFixed(8)}forgetting_curve;next_state(e,r,n){const{difficulty:a,stability:i}=e??{difficulty:0,stability:0};if(r<0)throw new Error(`Invalid delta_t "${r}"`);if(n<0||n>4)throw new Error(`Invalid grade "${n}"`);if(a===0&&i===0)return{difficulty:T(this.init_difficulty(n),1,10),stability:this.init_stability(n)};if(n===0)return{difficulty:a,stability:i};if(a<1||i<B)throw new Error(`Invalid memory state { difficulty: ${a}, stability: ${i} }`);const s=this.forgetting_curve(r,i),o=this.next_recall_stability(a,i,s,n),c=this.next_forget_stability(a,i,s),u=this.next_short_term_stability(i,n);let f=o;if(n===1){let[d,h]=[0,0];this.param.enable_short_term&&(d=this.param.w[17],h=this.param.w[18]);const y=i/Math.exp(d*h);f=T(+y.toFixed(8),B,c)}return r===0&&this.param.enable_short_term&&(f=u),{difficulty:this.next_difficulty(a,n),stability:f}}}class oa extends Ka{learningStepsStrategy;constructor(e,r,n,a){super(e,r,n,a);let i=Bs;if(this.strategies){const s=this.strategies.get(ue.LEARNING_STEPS);s&&(i=s)}this.learningStepsStrategy=i}getLearningInfo(e,r){const n=this.algorithm.parameters;e.learning_steps=e.learning_steps||0;const a=this.learningStepsStrategy(n,e.state,this.current.state===m.Learning&&r!==p.Again&&r!==p.Hard?e.learning_steps+1:e.learning_steps),i=Math.max(0,a[r]?.scheduled_minutes??0),s=Math.max(0,a[r]?.next_step??0);return{scheduled_minutes:i,next_steps:s}}applyLearningSteps(e,r,n){const{scheduled_minutes:a,next_steps:i}=this.getLearningInfo(this.current,r);if(a>0&&a<1440)e.learning_steps=i,e.scheduled_days=0,e.state=n,e.due=C(this.review_time,Math.round(a),!1);else if(e.state=m.Review,a>=1440)e.learning_steps=i,e.due=C(this.review_time,Math.round(a),!1),e.scheduled_days=Math.floor(a/1440);else{e.learning_steps=0;const s=this.algorithm.next_interval(e.stability,this.elapsed_days);e.scheduled_days=s,e.due=C(this.review_time,s,!0)}}newState(e){const r=this.next.get(e);if(r)return r;const n=S.card(this.current);n.difficulty=T(this.algorithm.init_difficulty(e),1,10),n.stability=this.algorithm.init_stability(e),this.applyLearningSteps(n,e,m.Learning);const a={card:n,log:this.buildLog(e)};return this.next.set(e,a),a}learningState(e){const r=this.next.get(e);if(r)return r;const{state:n,difficulty:a,stability:i}=this.last,s=S.card(this.current);s.difficulty=this.algorithm.next_difficulty(a,e),s.stability=this.algorithm.next_short_term_stability(i,e),this.applyLearningSteps(s,e,n);const o={card:s,log:this.buildLog(e)};return this.next.set(e,o),o}reviewState(e){const r=this.next.get(e);if(r)return r;const n=this.elapsed_days,{difficulty:a,stability:i}=this.last,s=this.algorithm.forgetting_curve(n,i),o=S.card(this.current),c=S.card(this.current),u=S.card(this.current),f=S.card(this.current);this.next_ds(o,c,u,f,a,i,s),this.next_interval(c,u,f,n),this.next_state(c,u,f),this.applyLearningSteps(o,p.Again,m.Relearning),o.lapses+=1;const l={card:o,log:this.buildLog(p.Again)},d={card:c,log:super.buildLog(p.Hard)},h={card:u,log:super.buildLog(p.Good)},y={card:f,log:super.buildLog(p.Easy)};return this.next.set(p.Again,l),this.next.set(p.Hard,d),this.next.set(p.Good,h),this.next.set(p.Easy,y),this.next.get(e)}next_ds(e,r,n,a,i,s,o){e.difficulty=this.algorithm.next_difficulty(i,p.Again);const c=s/Math.exp(this.algorithm.parameters.w[17]*this.algorithm.parameters.w[18]),u=this.algorithm.next_forget_stability(i,s,o);e.stability=T(+c.toFixed(8),B,u),r.difficulty=this.algorithm.next_difficulty(i,p.Hard),r.stability=this.algorithm.next_recall_stability(i,s,o,p.Hard),n.difficulty=this.algorithm.next_difficulty(i,p.Good),n.stability=this.algorithm.next_recall_stability(i,s,o,p.Good),a.difficulty=this.algorithm.next_difficulty(i,p.Easy),a.stability=this.algorithm.next_recall_stability(i,s,o,p.Easy)}next_interval(e,r,n,a){let i,s;i=this.algorithm.next_interval(e.stability,a),s=this.algorithm.next_interval(r.stability,a),i=Math.min(i,s),s=Math.max(s,i+1);const o=Math.max(this.algorithm.next_interval(n.stability,a),s+1);e.scheduled_days=i,e.due=C(this.review_time,i,!0),r.scheduled_days=s,r.due=C(this.review_time,s,!0),n.scheduled_days=o,n.due=C(this.review_time,o,!0)}next_state(e,r,n){e.state=m.Review,e.learning_steps=0,r.state=m.Review,r.learning_steps=0,n.state=m.Review,n.learning_steps=0}}class ua extends Ka{newState(e){const r=this.next.get(e);if(r)return r;this.current.scheduled_days=0,this.current.elapsed_days=0;const n=S.card(this.current),a=S.card(this.current),i=S.card(this.current),s=S.card(this.current);return this.init_ds(n,a,i,s),this.next_interval(n,a,i,s,0),this.next_state(n,a,i,s),this.update_next(n,a,i,s),this.next.get(e)}init_ds(e,r,n,a){e.difficulty=T(this.algorithm.init_difficulty(p.Again),1,10),e.stability=this.algorithm.init_stability(p.Again),r.difficulty=T(this.algorithm.init_difficulty(p.Hard),1,10),r.stability=this.algorithm.init_stability(p.Hard),n.difficulty=T(this.algorithm.init_difficulty(p.Good),1,10),n.stability=this.algorithm.init_stability(p.Good),a.difficulty=T(this.algorithm.init_difficulty(p.Easy),1,10),a.stability=this.algorithm.init_stability(p.Easy)}learningState(e){return this.reviewState(e)}reviewState(e){const r=this.next.get(e);if(r)return r;const n=this.elapsed_days,{difficulty:a,stability:i}=this.last,s=this.algorithm.forgetting_curve(n,i),o=S.card(this.current),c=S.card(this.current),u=S.card(this.current),f=S.card(this.current);return this.next_ds(o,c,u,f,a,i,s),this.next_interval(o,c,u,f,n),this.next_state(o,c,u,f),o.lapses+=1,this.update_next(o,c,u,f),this.next.get(e)}next_ds(e,r,n,a,i,s,o){e.difficulty=this.algorithm.next_difficulty(i,p.Again);const c=this.algorithm.next_forget_stability(i,s,o);e.stability=T(s,B,c),r.difficulty=this.algorithm.next_difficulty(i,p.Hard),r.stability=this.algorithm.next_recall_stability(i,s,o,p.Hard),n.difficulty=this.algorithm.next_difficulty(i,p.Good),n.stability=this.algorithm.next_recall_stability(i,s,o,p.Good),a.difficulty=this.algorithm.next_difficulty(i,p.Easy),a.stability=this.algorithm.next_recall_stability(i,s,o,p.Easy)}next_interval(e,r,n,a,i){let s,o,c,u;s=this.algorithm.next_interval(e.stability,i),o=this.algorithm.next_interval(r.stability,i),c=this.algorithm.next_interval(n.stability,i),u=this.algorithm.next_interval(a.stability,i),s=Math.min(s,o),o=Math.max(o,s+1),c=Math.max(c,o+1),u=Math.max(u,c+1),e.scheduled_days=s,e.due=C(this.review_time,s,!0),r.scheduled_days=o,r.due=C(this.review_time,o,!0),n.scheduled_days=c,n.due=C(this.review_time,c,!0),a.scheduled_days=u,a.due=C(this.review_time,u,!0)}next_state(e,r,n,a){e.state=m.Review,e.learning_steps=0,r.state=m.Review,r.learning_steps=0,n.state=m.Review,n.learning_steps=0,a.state=m.Review,a.learning_steps=0}update_next(e,r,n,a){const i={card:e,log:this.buildLog(p.Again)},s={card:r,log:super.buildLog(p.Hard)},o={card:n,log:super.buildLog(p.Good)},c={card:a,log:super.buildLog(p.Easy)};this.next.set(p.Again,i),this.next.set(p.Hard,s),this.next.set(p.Good,o),this.next.set(p.Easy,c)}}class Js{fsrs;constructor(e){this.fsrs=e}replay(e,r,n){return this.fsrs.next(e,r,n)}handleManualRating(e,r,n,a,i,s,o){if(typeof r>"u")throw new Error("reschedule: state is required for manual rating");let c,u;if(r===m.New)c={rating:p.Manual,state:r,due:o??n,stability:e.stability,difficulty:e.difficulty,elapsed_days:a,last_elapsed_days:e.elapsed_days,scheduled_days:e.scheduled_days,learning_steps:e.learning_steps,review:n},u=zt(n),u.last_review=n;else{if(typeof o>"u")throw new Error("reschedule: due is required for manual rating");const f=z(o,n,"days");c={rating:p.Manual,state:e.state,due:e.last_review||e.due,stability:e.stability,difficulty:e.difficulty,elapsed_days:a,last_elapsed_days:e.elapsed_days,scheduled_days:e.scheduled_days,learning_steps:e.learning_steps,review:n},u={...e,state:r,due:o,last_review:n,stability:i||e.stability,difficulty:s||e.difficulty,elapsed_days:a,scheduled_days:f,reps:e.reps+1}}return{card:u,log:c}}reschedule(e,r){const n=[];let a=zt(e.due);for(const i of r){let s;if(i.review=S.time(i.review),i.rating===p.Manual){let o=0;a.state!==m.New&&a.last_review&&(o=z(i.review,a.last_review,"days")),s=this.handleManualRating(a,i.state,i.review,o,i.stability,i.difficulty,i.due?S.time(i.due):void 0)}else s=this.replay(a,i.review,i.rating);n.push(s),a=s.card}return n}calculateManualRecord(e,r,n,a){if(!n)return null;const{card:i,log:s}=n,o=S.card(e);return o.due.getTime()===i.due.getTime()?null:(o.scheduled_days=z(i.due,o.due,"days"),this.handleManualRating(o,i.state,S.time(r),s.elapsed_days,a?i.stability:void 0,a?i.difficulty:void 0,i.due))}}class Xs extends Qs{strategyHandler=new Map;Scheduler;constructor(e){super(e);const{enable_short_term:r}=this.parameters;this.Scheduler=r?oa:ua}params_handler_proxy(){const e=this;return{set:function(r,n,a){return n==="request_retention"&&Number.isFinite(a)?e.intervalModifier=e.calculate_interval_modifier(Number(a)):n==="enable_short_term"?e.Scheduler=a===!0?oa:ua:n==="w"&&(a=dr(hr(a),r.relearning_steps.length),e.forgetting_curve=Yt.bind(this,a),e.intervalModifier=e.calculate_interval_modifier(Number(r.request_retention))),Reflect.set(r,n,a),!0}}}useStrategy(e,r){return this.strategyHandler.set(e,r),this}clearStrategy(e){return e?this.strategyHandler.delete(e):this.strategyHandler.clear(),this}getScheduler(e,r){const a=this.strategyHandler.get(ue.SCHEDULER)||this.Scheduler;return new a(e,r,this,this.strategyHandler)}repeat(e,r,n){const i=this.getScheduler(e,r).preview();return n&&typeof n=="function"?n(i):i}next(e,r,n,a){const i=this.getScheduler(e,r),s=S.rating(n);if(s===p.Manual)throw new Error("Cannot review a manual rating");const o=i.review(s);return a&&typeof a=="function"?a(o):o}get_retrievability(e,r,n=!0){const a=S.card(e);r=r?S.time(r):new Date;const i=a.state!==m.New?Math.max(z(r,a.last_review,"days"),0):0,s=a.state!==m.New?this.forgetting_curve(i,+a.stability.toFixed(8)):0;return n?`${(s*100).toFixed(2)}%`:s}rollback(e,r,n){const a=S.card(e),i=S.review_log(r);if(i.rating===p.Manual)throw new Error("Cannot rollback a manual rating");let s,o,c;switch(i.state){case m.New:s=i.due,o=void 0,c=0;break;case m.Learning:case m.Relearning:case m.Review:s=i.review,o=i.due,c=a.lapses-(i.rating===p.Again&&i.state===m.Review?1:0);break}const u={...a,due:s,stability:i.stability,difficulty:i.difficulty,elapsed_days:i.last_elapsed_days,scheduled_days:i.scheduled_days,reps:Math.max(0,a.reps-1),lapses:Math.max(0,c),learning_steps:i.learning_steps,state:i.state,last_review:o};return n&&typeof n=="function"?n(u):u}forget(e,r,n=!1,a){const i=S.card(e);r=S.time(r);const s=i.state===m.New?0:z(r,i.due,"days"),o={rating:p.Manual,state:i.state,due:i.due,stability:i.stability,difficulty:i.difficulty,elapsed_days:0,last_elapsed_days:i.elapsed_days,scheduled_days:s,learning_steps:i.learning_steps,review:r},u={card:{...i,due:r,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:n?0:i.reps,lapses:n?0:i.lapses,learning_steps:0,state:m.New,last_review:i.last_review},log:o};return a&&typeof a=="function"?a(u):u}reschedule(e,r=[],n={}){const{recordLogHandler:a,reviewsOrderBy:i,skipManual:s=!0,now:o=new Date,update_memory_state:c=!1}=n;i&&typeof i=="function"&&r.sort(i),s&&(r=r.filter(y=>y.rating!==p.Manual));const u=new Js(this),f=u.reschedule(n.first_card||zt(),r),l=f.length,d=S.card(e),h=u.calculateManualRecord(d,o,l?f[l-1]:void 0,c);return a&&typeof a=="function"?{collections:f.map(a),reschedule_item:h?a(h):null}:{collections:f,reschedule_item:h}}}const mo=t=>new Xs(t||{}),Wt=1e3,ie=60*Wt,te=60*ie,Y=24*te,kt=7*Y,Ut=29.53*Y,Kt=365.2425*Y,Qt=new Date(0);function re(t=new Date){return new Date(t.getFullYear(),t.getMonth(),t.getDate())}function Zs(t){const e=Math.abs(t);return e<1.5*ie?{unit:"second",multiplier:Wt,value:t/Wt}:e<1.5*te?{unit:"minute",multiplier:ie,value:t/ie}:e<1.5*Y?{unit:"hour",multiplier:te,value:t/te}:e<kt?{unit:"day",multiplier:Y,value:t/Y}:e<Ut?{unit:"week",multiplier:kt,value:t/kt}:e<Kt?{unit:"month",multiplier:Ut,value:t/Ut}:{unit:"year",multiplier:Kt,value:t/Kt}}const eo=new Intl.RelativeTimeFormat("default",{numeric:"always",style:"short"});function bo(t){const{unit:e,value:r}=Zs(t);return eo.format(Math.round(r),e)}function _o(t){return new Promise(e=>{globalThis.setTimeout(e,t)})}async function*to(t){const e=new Set;let r=await(await E).transaction("progress").store.index("state+due").openCursor();for(;r;){const[n,a]=r.key;if(n<m.Learning){r=await r.continue([m.Learning,Qt]);continue}if(n>m.Learning&&n<m.Relearning){r=await r.continue([m.Relearning,Qt]);continue}{const[i]=r.primaryKey;e.has(i)||(yield r,e.add(i))}r=await r.continue()}}async function Ha(){const t=new Set,e=(await E).transaction("reviews").store.index("review").iterate(IDBKeyRange.lowerBound(re()));for await(const r of e)t.add(r.value.cardId);return t}async function ro(){const t=new Date;return(await E).transaction("reviews").store.index("state+review").count(IDBKeyRange.bound([m.New,re()],[m.New,t],!0,!0))}async function*no(){const t=await Ha(),e=(await E).transaction(["decks","progress"]),r=e.objectStore("progress"),n=new Set;let a=null,i=null,s=null;for await(const c of r.index("cardId+cardType+state")){const[u,f,l]=c.key;if(!(t.has(u)||n.has(u)))if(a===u&&s!==null&&i!==null){if(s!==m.New&&l===m.New)yield c.value,n.add(u);else if(s===0&&l!==m.New){const d=await r.get([a,i]);d&&(yield d,n.add(a))}}else a=u,i=f,s=l}const o=e.objectStore("decks").index("priority");for await(const{value:c}of o)if(c.active){for(const u of c.cards)if(!(n.has(u)||t.has(u)))for(const f of["kanji-write","kanji-read"]){const l=await r.get([u,f]);if(l?.fsrs.state===m.New){yield l;break}}}}async function ao(){const t=new Date;return(await E).transaction("reviews").store.index("state+review").count(IDBKeyRange.bound([m.Review,re()],[m.Review,t],!1,!0))}async function*io(){const t=new Date,e=await Ha(),r=(await E).transaction(["decks","progress","reviews"],"readonly"),a=r.objectStore("decks").index("cards"),i=r.objectStore("progress"),s=IDBKeyRange.bound([m.Review,Qt],[m.Review,t],!1,!0),o=new Set;let c=await i.index("state+due").openCursor(s);for(;c;){const[u]=c.primaryKey;!o.has(u)&&!e.has(u)&&await a.getKey(IDBKeyRange.only(u))&&(yield c),c=await c.continue()}}async function so(){const t=await(await E).getAllFromIndex("review-limits","time",IDBKeyRange.lowerBound(re())),e={due:0,new:0};for(const{count:r}of t)e.due+=r.due,e.new+=r.new;return e}async function oo({cardId:t,cardType:e},r){const n=(await E).transaction(["progress","reviews"],"readwrite"),a=n.objectStore("progress"),i=n.objectStore("reviews");await a.put({cardId:t,cardType:e,fsrs:r.card});const s=await i.add({cardId:t,cardType:e,log:r.log});xs([{store:"progress",op:"put",key:[t,e]},{store:"reviews",op:"add",key:s}]),await n.done}const ne="shodoku.app.preferences",Jt=D(`${ne}.limit.due`,50),Xt=D(`${ne}.limit.new`,10),So=D(`${ne}.fsrs.fuzz-enabled`,!0),Io=D(`${ne}.known.min-due-weeks`,8),Ao=D(`${ne}.known.min-retention`,90);async function Oo(t={new:Xt.value,due:Jt.value}){return await(await E).add("review-limits",{time:new Date,count:t}),oe.postMessage("review-limit-increased")}const uo=Va("reviews",()=>{const t=H(!1),e=H([]),r=H([]),n=H([]),a=H(0),i=H(0),s=ca(()=>{const l=new Date;let d=0,h=0,y=0,b=e.value.at(d);const v=[];for(;b&&b.fsrs.due<l;)v.push(b),d+=1,b=e.value.at(d);const _=r.value.length,g=n.value.length,w=_+a.value,I=g+i.value,A=Math.ceil((I+w)/I),R=Math.floor(A/2);let O=r.value.at(h),j=n.value.at(y);for(;O||j;){if(!j){O&&v.push(O),h+=1,O=r.value.at(h);continue}if(!O){j&&v.push(j),y+=1,j=n.value.at(y);continue}(a.value+h+i.value+y)%A===R?(v.push(j),y+=1,j=n.value.at(y)):(v.push(O),h+=1,O=r.value.at(h))}for(;b;)v.push(b),d+=1,b=e.value.at(d);return v});async function o({cardId:l,cardType:d,fsrs:h},y){if(h.state===m.New?(n.value=n.value.filter(b=>b.cardId!==l),i.value+=1):h.state===m.Review?(r.value=r.value.filter(b=>b.cardId!==l),a.value+=1):e.value=e.value.filter(b=>b.cardId!==l),y.card.state===m.Learning||y.card.state===m.Relearning){const b={cardId:l,cardType:d,fsrs:y.card},{due:v}=y.card,_=e.value.findIndex(g=>v<g.fsrs.due);e.value=e.value.toSpliced(_===-1?e.value.length:_,0,b)}await oo({cardId:l,cardType:d},y),oe.postMessage("card-review")}function c(l){return e.value.some(d=>d.cardId===l)}function u(l){return r.value.some(d=>d.cardId===l)}async function f(){t.value=!0;try{const l=await so();a.value=await ao(),i.value=await ro(),e.value=await X(to(),Gt(d=>d.value),le()),r.value=await X(io(),vr(({primaryKey:[d]})=>!c(d)),pr(Math.max(0,Jt.value+l.due-a.value)),Gt(d=>d.value),le()),n.value=await X(no(),vr(({cardId:d})=>!c(d)&&!u(d)),pr(Math.max(0,Xt.value+l.new-i.value)),le())}finally{t.value=!1}}return f(),setTimeout(f,te),za([Jt,Xt],f),{refreshing:t,learningQueue:e,dueQueue:r,newQueue:n,queue:s,refreshQueues:f,rateCard:o}});function Eo(){const t=uo();return ca(()=>({due:t.dueQueue.length,new:t.newQueue.length,learning:t.learningQueue.length}))}function Ro(){const{result:t}=Zt(async()=>{const e=new Map,r=(await E).transaction("reviews").store.index("review");for await(const n of r.iterate(IDBKeyRange.lowerBound(re()))){const a=n.value;let i=e.get(a.cardId);i||(i=[],e.set(a.cardId,i)),i.push(a)}return e});return t}export{oi as A,si as B,ui as C,fo as D,wo as E,Xs as F,ho as G,go as H,us as P,p as R,m as S,kt as W,Ro as a,bo as b,uo as c,po as d,Io as e,vr as f,xs as g,sa as h,Oo as i,zt as j,Ao as k,vo as l,Gt as m,Xt as n,yo as o,X as p,ns as q,So as r,_o as s,mo as t,Eo as u,Jt as v,li as w,ci as x,fi as y,va as z};
